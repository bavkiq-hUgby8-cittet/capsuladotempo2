<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÅ Minha C√°psula do Tempo</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;500;600;700;800&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        :root { --natal-red: #c41e3a; --natal-green: #165b33; --natal-gold: #ffd700; --midnight: #0a0e14; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(180deg, #0a0e14 0%, #1a2e1a 50%, #2a1a1a 100%); min-height: 100vh; color: white; overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Pacifico', cursive; }

        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; top: -20px; color: rgba(255,255,255,0.8); animation: snowfall linear infinite; }
        @keyframes snowfall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .container { max-width: 520px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }

        .tela { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.5s ease; }
        .tela.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .tela-lacrada { align-items: center; text-align: center; padding: 30px 20px; }
        .foto-lacrada { width: 160px; height: 160px; border-radius: 50%; border: 5px solid var(--natal-gold); overflow: hidden; margin-bottom: 20px; background: linear-gradient(135deg, var(--natal-red), var(--natal-green)); display: flex; align-items: center; justify-content: center; font-size: 4.5rem; box-shadow: 0 0 50px rgba(255,215,0,0.4); }
        .foto-lacrada img { width: 100%; height: 100%; object-fit: cover; }
        .nome-lacrada { font-size: 2rem; color: var(--natal-gold); margin-bottom: 6px; }
        .evento-lacrada { color: rgba(255,255,255,0.7); font-size: 1rem; margin-bottom: 28px; }

        .capsula-3d { position: relative; width: 180px; height: 220px; margin: 20px auto; }
        .capsula-corpo { position: absolute; width: 100%; height: 100%; background: linear-gradient(135deg, #ffd700 0%, #ffaa00 50%, #cc8800 100%); border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%; box-shadow: inset -20px -20px 40px rgba(0,0,0,0.3), 0 20px 40px rgba(0,0,0,0.4); animation: float 4s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .capsula-tampa { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 120px; height: 50px; background: linear-gradient(135deg, #ffcc00, #ff9900); border-radius: 50% 50% 0 0; }
        .capsula-lacre { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3.5rem; z-index: 2; }
        .capsula-brilho { position: absolute; top: 20%; left: 20%; width: 30px; height: 30px; background: rgba(255,255,255,0.6); border-radius: 50%; filter: blur(5px); }

        .status-badge { padding: 14px 28px; border-radius: 20px; font-weight: 700; margin: 24px 0; font-size: 1.1rem; }
        .status-lacrada { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); }
        .status-liberada { background: rgba(255,215,0,0.2); color: var(--natal-gold); animation: pulse 2s infinite; border: 2px solid var(--natal-gold); }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .countdown { display: flex; justify-content: center; gap: 14px; margin: 28px 0; }
        .countdown-item { text-align: center; }
        .countdown-value { font-family: 'Orbitron', sans-serif; font-size: 2.2rem; font-weight: 900; color: var(--natal-gold); background: rgba(0,0,0,0.4); padding: 14px 18px; border-radius: 14px; min-width: 65px; border: 2px solid rgba(255,215,0,0.3); }
        .countdown-label { font-size: 0.8rem; color: rgba(255,255,255,0.6); margin-top: 6px; font-weight: 500; }

        .btn-abrir { background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; padding: 20px 52px; border-radius: 16px; font-size: 1.3rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; box-shadow: 0 8px 30px rgba(255,215,0,0.4); transition: all 0.3s; margin-top: 24px; }
        .btn-abrir:hover { transform: translateY(-3px) scale(1.02); }
        .btn-abrir:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .msg-aguarde { color: rgba(255,255,255,0.6); font-size: 1rem; margin-top: 20px; line-height: 1.5; }

        .tela-aberta { padding: 20px 0; }
        .header-aberta { display: flex; align-items: center; gap: 18px; margin-bottom: 28px; padding-bottom: 24px; border-bottom: 2px solid rgba(255,255,255,0.1); }
        .foto-mini { width: 80px; height: 80px; border-radius: 50%; overflow: hidden; border: 4px solid var(--natal-gold); flex-shrink: 0; }
        .foto-mini img { width: 100%; height: 100%; object-fit: cover; }
        .info-header h2 { font-size: 1.5rem; color: var(--natal-gold); }
        .info-header p { font-size: 0.95rem; color: rgba(255,255,255,0.7); margin-top: 4px; }

        .secao { background: rgba(255,255,255,0.06); border-radius: 18px; padding: 22px; margin-bottom: 18px; border: 2px solid rgba(255,255,255,0.1); }
        .secao-titulo { display: flex; align-items: center; gap: 10px; font-size: 1.15rem; color: var(--natal-gold); margin-bottom: 14px; font-weight: 600; }
        .secao-conteudo { color: rgba(255,255,255,0.9); line-height: 1.7; font-size: 1.05rem; }

        .tags-container { display: flex; flex-wrap: wrap; gap: 10px; }
        .tag-item { background: rgba(255,215,0,0.18); color: var(--natal-gold); padding: 8px 16px; border-radius: 16px; font-size: 0.95rem; font-weight: 500; border: 1px solid rgba(255,215,0,0.3); }

        .secao-audio { background: linear-gradient(135deg, rgba(196,30,58,0.15), rgba(22,91,51,0.15)); border: 3px solid var(--natal-gold); position: relative; overflow: hidden; }
        .secao-audio::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%); animation: audioGlow 3s ease-in-out infinite; }
        @keyframes audioGlow { 0%, 100% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } }
        .audio-player { background: rgba(0,0,0,0.4); border-radius: 16px; padding: 24px; position: relative; z-index: 1; }
        .audio-header { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .audio-icon-big { font-size: 3.5rem; animation: micPulse 2s ease-in-out infinite; }
        @keyframes micPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .audio-info h3 { color: var(--natal-gold); font-size: 1.2rem; margin-bottom: 4px; font-family: 'Pacifico', cursive; }
        .audio-info p { color: rgba(255,255,255,0.7); font-size: 0.95rem; }
        .audio-player audio { width: 100%; height: 60px; border-radius: 12px; background: rgba(255,255,255,0.1); }
        .btn-play-audio { width: 100%; background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; padding: 16px; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; font-family: 'Poppins', sans-serif; transition: all 0.3s; }
        .btn-play-audio:hover { transform: scale(1.02); }
        .btn-play-audio.playing { background: var(--natal-green); }
        .audio-status { text-align: center; margin-top: 12px; font-size: 0.9rem; color: rgba(255,255,255,0.6); }

        .pergunta-item { background: rgba(0,0,0,0.25); border-radius: 14px; padding: 18px; margin-bottom: 14px; border-left: 4px solid var(--natal-gold); }
        .pergunta-label { font-size: 0.9rem; color: var(--natal-gold); margin-bottom: 8px; font-weight: 600; }
        .pergunta-resposta { color: white; font-size: 1.1rem; line-height: 1.5; }
        .felicidade-display { display: flex; align-items: center; gap: 12px; margin-top: 8px; }
        .felicidade-nota { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; color: var(--natal-gold); font-weight: 900; }
        .felicidade-barra { flex: 1; height: 12px; background: rgba(255,255,255,0.15); border-radius: 6px; overflow: hidden; }
        .felicidade-fill { height: 100%; background: linear-gradient(90deg, var(--natal-gold), #ffaa00); border-radius: 6px; }

        .mensagem-texto { white-space: pre-wrap; font-size: 1.1rem; line-height: 1.8; }
        .mensagem-chars { text-align: right; font-size: 0.9rem; color: rgba(255,255,255,0.5); margin-top: 12px; }

        .reflexao-form textarea { width: 100%; padding: 18px; border: 3px solid rgba(255,255,255,0.25); border-radius: 14px; background: rgba(255,255,255,0.12); color: white; font-size: 1.1rem; font-family: 'Poppins', sans-serif; resize: none; min-height: 130px; line-height: 1.6; }
        .reflexao-form textarea:focus { outline: none; border-color: var(--natal-gold); }
        .reflexao-form textarea::placeholder { color: rgba(255,255,255,0.45); }
        .btn-salvar { background: var(--natal-green); color: white; border: none; padding: 16px 28px; border-radius: 12px; font-weight: 700; cursor: pointer; margin-top: 14px; font-family: 'Poppins', sans-serif; font-size: 1.1rem; }
        
        .reflexao-salva { background: rgba(22,91,51,0.2); border-radius: 14px; padding: 20px; border-left: 4px solid var(--natal-green); }
        .reflexao-salva-titulo { color: var(--natal-green); font-size: 1rem; margin-bottom: 10px; font-weight: 600; }
        .reflexao-salva-texto { color: white; font-size: 1.05rem; line-height: 1.6; }

        .btn-compartilhar { width: 100%; background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); border: none; color: white; padding: 18px; border-radius: 14px; font-weight: 700; cursor: pointer; margin-top: 20px; font-family: 'Poppins', sans-serif; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* MODAL COMPARTILHAR - PROFISSIONAL */
        .share-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: flex-start; padding: 15px; overflow-y: auto; }
        .share-modal.active { display: flex; }
        .share-modal-content { max-width: 420px; width: 100%; text-align: center; }
        .share-modal h3 { color: var(--natal-gold); font-size: 1.6rem; margin: 15px 0; font-family: 'Pacifico', cursive; }
        .share-preview { width: 100%; aspect-ratio: 9/16; max-height: 55vh; overflow: hidden; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 15px 50px rgba(255,215,0,0.3); background: #000; position: relative; }
        .share-preview canvas { width: 100%; height: 100%; object-fit: contain; border-radius: 20px; }
        .share-preview video { width: 100%; height: 100%; object-fit: contain; border-radius: 20px; }
        .share-status { color: var(--natal-gold); font-size: 1rem; padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .share-status .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,215,0,0.3); border-top-color: var(--natal-gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .share-progress { width: 100%; height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; }
        .share-progress-bar { height: 100%; background: linear-gradient(90deg, var(--natal-gold), #ff6b6b, var(--natal-gold)); width: 0%; transition: width 0.3s; }
        .share-btns { display: flex; flex-direction: column; gap: 10px; }
        .share-btns button { padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; transition: all 0.3s; }
        .share-btns button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-baixar-video { background: linear-gradient(135deg, #ff416c, #ff4b2b); color: white; border: none; }
        .btn-baixar-img { background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; }
        .btn-copiar-link { background: var(--natal-green); color: white; border: none; }
        .btn-fechar-share { background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; margin-top: 5px; }

        .abertura-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.5s; }
        .abertura-overlay.active { opacity: 1; visibility: visible; }
        .abertura-capsula { font-size: 9rem; }
        .abertura-capsula.shake { animation: shakeOpen 0.5s ease; }
        @keyframes shakeOpen { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(-12deg); } 75% { transform: rotate(12deg); } }
        .abertura-capsula.explode { animation: explodeOpen 0.8s ease forwards; }
        @keyframes explodeOpen { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.5); } 100% { transform: scale(3); opacity: 0; } }
        .flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; opacity: 0; z-index: 1001; pointer-events: none; }
        .flash.active { animation: flashAnim 0.8s ease; }
        @keyframes flashAnim { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }

        .confetes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; }
        .confete { position: absolute; animation: confeteFall 3s ease-out forwards; }
        @keyframes confeteFall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(720deg); } }

        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--natal-green); color: white; padding: 16px 28px; border-radius: 14px; font-weight: 600; z-index: 3000; opacity: 0; transition: all 0.4s; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        .tela-erro { align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
        .erro-icon { font-size: 5rem; margin-bottom: 24px; }
        .erro-titulo { color: var(--natal-gold); font-size: 1.5rem; margin-bottom: 12px; }
        .erro-msg { color: rgba(255,255,255,0.7); font-size: 1.1rem; }

        @media (max-width: 400px) {
            .container { padding: 16px; }
            .countdown-value { font-size: 1.8rem; padding: 12px 14px; min-width: 55px; }
            .foto-lacrada { width: 140px; height: 140px; }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="confetes" id="confetes"></div>
    <div class="flash" id="flash"></div>

    <div class="container">
        <!-- TELA LACRADA -->
        <div class="tela tela-lacrada active" id="telaLacrada">
            <div class="foto-lacrada" id="fotoLacrada">üë§</div>
            <h1 class="nome-lacrada" id="nomeLacrada">Carregando...</h1>
            <p class="evento-lacrada" id="eventoLacrada">Evento</p>
            
            <div class="capsula-3d">
                <div class="capsula-corpo"><div class="capsula-brilho"></div></div>
                <div class="capsula-tampa"></div>
                <div class="capsula-lacre" id="capsulLacre">üîí</div>
            </div>
            
            <div class="status-badge status-lacrada" id="statusBadge">üîí C√°psula Lacrada</div>
            
            <div class="countdown" id="countdown">
                <div class="countdown-item"><div class="countdown-value" id="dias">--</div><div class="countdown-label">DIAS</div></div>
                <div class="countdown-item"><div class="countdown-value" id="horas">--</div><div class="countdown-label">HORAS</div></div>
                <div class="countdown-item"><div class="countdown-value" id="minutos">--</div><div class="countdown-label">MIN</div></div>
                <div class="countdown-item"><div class="countdown-value" id="segundos">--</div><div class="countdown-label">SEG</div></div>
            </div>
            
            <button class="btn-abrir" id="btnAbrir" onclick="iniciarAbertura()" disabled>üéÅ ABRIR C√ÅPSULA</button>
            <p class="msg-aguarde" id="msgAguarde">‚è≥ Aguardando o guardi√£o liberar sua c√°psula...</p>
        </div>

        <!-- TELA ABERTA -->
        <div class="tela tela-aberta" id="telaAberta">
            <div class="header-aberta">
                <div class="foto-mini" id="fotoAberta"></div>
                <div class="info-header">
                    <h2 id="nomeAberta">Nome</h2>
                    <p id="dataAberta">Criada em --/--/----</p>
                    <p id="eventoAberta">Evento</p>
                </div>
            </div>
            
            <div class="secao secao-audio" id="secaoAudio" style="display:none">
                <div class="secao-titulo">üé§ Mensagem de Voz</div>
                <div class="audio-player">
                    <div class="audio-header">
                        <span class="audio-icon-big">üéôÔ∏è</span>
                        <div class="audio-info">
                            <h3>Ou√ßa voc√™ mesmo!</h3>
                            <p>Mensagem do passado</p>
                        </div>
                    </div>
                    <audio id="audioPlayer" controls preload="auto"></audio>
                    <button class="btn-play-audio" id="btnPlayAudio" onclick="toggleAudio()">
                        <span id="playIcon">‚ñ∂Ô∏è</span>
                        <span id="playText">Ouvir Mensagem</span>
                    </button>
                    <div class="audio-status" id="audioStatus"></div>
                </div>
            </div>
            
            <div class="secao" id="secaoDesejos">
                <div class="secao-titulo">üåü Prioridades</div>
                <div class="tags-container" id="desejosContainer"></div>
            </div>
            
            <div class="secao" id="secaoPessoas" style="display:none">
                <div class="secao-titulo">üë• Pessoas importantes</div>
                <div class="tags-container" id="pessoasContainer"></div>
            </div>
            
            <div class="secao" id="secaoPerguntas" style="display:none">
                <div class="secao-titulo">üí≠ Reflex√µes</div>
                <div id="perguntasContainer"></div>
            </div>
            
            <div class="secao">
                <div class="secao-titulo">üíå Mensagem</div>
                <div class="secao-conteudo">
                    <div class="mensagem-texto" id="mensagemTexto"></div>
                    <div class="mensagem-chars" id="mensagemChars"></div>
                </div>
            </div>
            
            <div class="secao" id="secaoReflexao">
                <div class="secao-titulo">‚úçÔ∏è Sua reflex√£o agora</div>
                <div class="reflexao-form" id="reflexaoForm">
                    <textarea id="reflexaoInput" placeholder="O que voc√™ sente ao ler isso?"></textarea>
                    <button class="btn-salvar" onclick="salvarReflexao()">üíæ Salvar reflex√£o</button>
                </div>
                <div class="reflexao-salva" id="reflexaoSalva" style="display:none">
                    <div class="reflexao-salva-titulo">üìù Sua reflex√£o:</div>
                    <div class="reflexao-salva-texto" id="reflexaoTexto"></div>
                </div>
            </div>
            
            <button class="btn-compartilhar" onclick="abrirCompartilhar()">üé¨ Criar V√≠deo para Stories</button>
        </div>

        <!-- TELA ERRO -->
        <div class="tela tela-erro" id="telaErro">
            <div class="erro-icon">üòï</div>
            <h2 class="erro-titulo">C√°psula n√£o encontrada</h2>
            <p class="erro-msg">Verifique o link</p>
        </div>
    </div>

    <!-- MODAL COMPARTILHAR -->
    <div class="share-modal" id="shareModal">
        <div class="share-modal-content">
            <h3>üé¨ Momento √©pico!</h3>
            <div class="share-preview" id="sharePreview">
                <div class="share-status" id="shareStatus">
                    <div class="spinner"></div>
                    <span>Criando anima√ß√£o de abertura...</span>
                    <div class="share-progress">
                        <div class="share-progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>
            <div class="share-btns">
                <button class="btn-baixar-video" id="btnBaixarVideo" onclick="baixarVideo()" disabled>
                    üé¨ Baixar V√≠deo (.webm)
                </button>
                <button class="btn-baixar-img" id="btnBaixarImg" onclick="baixarImagem()" disabled>
                    üì∏ Baixar Imagem (.png)
                </button>
                <button class="btn-copiar-link" onclick="copiarLink()">üîó Copiar Link</button>
                <button class="btn-fechar-share" onclick="fecharCompartilhar()">‚úï Fechar</button>
            </div>
        </div>
    </div>

    <!-- ANIMA√á√ÉO ABERTURA -->
    <div class="abertura-overlay" id="aberturaOverlay">
        <div class="abertura-capsula" id="aberturaCapsula">üéÅ</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB2cNiBL1SU_QfjH_S_QGv_KSiFoocfqd4",
            authDomain: "capsuladotempo-f86bf.firebaseapp.com",
            databaseURL: "https://capsuladotempo-f86bf-default-rtdb.firebaseio.com",
            projectId: "capsuladotempo-f86bf",
            storageBucket: "capsuladotempo-f86bf.firebasestorage.app",
            messagingSenderId: "43014678980",
            appId: "1:43014678980:web:0c84f48037ee6924afdc91"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let capsulaId = null;
        let capsulaData = null;
        let eventoData = null;
        let isGuardiao = false;
        let countdownInterval = null;
        let isPlaying = false;
        let videoBlob = null;
        let imagemBlob = null;
        let fotoImg = null;

        const formatarData = (d) => new Date(d).toLocaleDateString('pt-BR');
        const mostrarToast = (msg) => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show';
            setTimeout(() => t.className = 'toast', 3000);
        };

        function criarParticulas() {
            const c = document.getElementById('particles');
            ['‚ùÑ','‚ùÖ','‚ùÜ','‚úß'].forEach(f => {
                for(let i=0;i<6;i++) {
                    const e = document.createElement('div');
                    e.className = 'snowflake';
                    e.textContent = f;
                    e.style.left = Math.random()*100+'vw';
                    e.style.animationDuration = (8+Math.random()*5)+'s';
                    e.style.animationDelay = Math.random()*10+'s';
                    e.style.fontSize = (0.5+Math.random()*0.8)+'rem';
                    c.appendChild(e);
                }
            });
            for(let i=0;i<30;i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.left = Math.random()*100+'vw';
                s.style.top = Math.random()*100+'vh';
                const sz = 1+Math.random()*2;
                s.style.width = sz+'px';
                s.style.height = sz+'px';
                s.style.animationDuration = (2+Math.random()*3)+'s';
                c.appendChild(s);
            }
        }

        function criarConfetes() {
            const c = document.getElementById('confetes');
            c.innerHTML = '';
            const cores = ['#c41e3a','#165b33','#ffd700','#fff','#ff6b6b','#4ecdc4'];
            for(let i=0;i<150;i++) {
                const cf = document.createElement('div');
                cf.className = 'confete';
                cf.style.left = Math.random()*100+'vw';
                cf.style.background = cores[Math.floor(Math.random()*cores.length)];
                cf.style.animationDelay = Math.random()*2+'s';
                const sz = 5+Math.random()*10;
                cf.style.width = sz+'px';
                cf.style.height = sz+'px';
                cf.style.borderRadius = Math.random()>0.5?'50%':'0';
                c.appendChild(cf);
            }
        }

        function mostrarTela(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            criarParticulas();
            
            const params = new URLSearchParams(window.location.search);
            capsulaId = params.get('id');
            isGuardiao = params.get('guardiao') === 'true';
            
            if (!capsulaId) { mostrarTela('telaErro'); return; }
            
            try {
                const capSnap = await database.ref(`capsulas/${capsulaId}`).once('value');
                capsulaData = capSnap.val();
                if (!capsulaData) { mostrarTela('telaErro'); return; }
                
                const evtSnap = await database.ref(`eventos/${capsulaData.eventoId}`).once('value');
                eventoData = evtSnap.val();
                
                // Pr√©-carregar foto
                if (capsulaData.foto) {
                    fotoImg = new Image();
                    fotoImg.crossOrigin = 'anonymous';
                    fotoImg.src = capsulaData.foto;
                }
                
                if (capsulaData.aberta) { mostrarConteudo(); return; }
                renderizarLacrada();
            } catch (err) {
                console.error(err);
                mostrarTela('telaErro');
            }
        });

        function renderizarLacrada() {
            if (capsulaData.foto) document.getElementById('fotoLacrada').innerHTML = `<img src="${capsulaData.foto}">`;
            document.getElementById('nomeLacrada').textContent = `${capsulaData.nome} ${capsulaData.sobrenome}`;
            document.getElementById('eventoLacrada').textContent = eventoData?.nome || 'C√°psula do Tempo';
            
            if (capsulaData.liberada || isGuardiao) {
                document.getElementById('statusBadge').className = 'status-badge status-liberada';
                document.getElementById('statusBadge').textContent = 'üîì Liberada!';
                document.getElementById('capsulLacre').textContent = 'üîì';
                document.getElementById('btnAbrir').disabled = false;
                document.getElementById('msgAguarde').style.display = 'none';
            }
            
            atualizarCountdown();
            countdownInterval = setInterval(atualizarCountdown, 1000);
        }

        function atualizarCountdown() {
            const diff = new Date(capsulaData.dataAbertura) - new Date();
            if (diff <= 0) {
                document.getElementById('dias').textContent = '0';
                document.getElementById('horas').textContent = '00';
                document.getElementById('minutos').textContent = '00';
                document.getElementById('segundos').textContent = '00';
                return;
            }
            document.getElementById('dias').textContent = Math.floor(diff / (1000*60*60*24));
            document.getElementById('horas').textContent = Math.floor((diff % (1000*60*60*24)) / (1000*60*60)).toString().padStart(2,'0');
            document.getElementById('minutos').textContent = Math.floor((diff % (1000*60*60)) / (1000*60)).toString().padStart(2,'0');
            document.getElementById('segundos').textContent = Math.floor((diff % (1000*60)) / 1000).toString().padStart(2,'0');
        }

        async function iniciarAbertura() {
            const overlay = document.getElementById('aberturaOverlay');
            const capsula = document.getElementById('aberturaCapsula');
            const flash = document.getElementById('flash');
            
            overlay.classList.add('active');
            
            await new Promise(r => setTimeout(r, 500));
            capsula.classList.add('shake');
            await new Promise(r => setTimeout(r, 500));
            capsula.classList.remove('shake');
            
            await new Promise(r => setTimeout(r, 300));
            capsula.classList.add('shake');
            await new Promise(r => setTimeout(r, 500));
            capsula.classList.remove('shake');
            
            await new Promise(r => setTimeout(r, 200));
            capsula.classList.add('explode');
            
            await new Promise(r => setTimeout(r, 400));
            flash.classList.add('active');
            
            await database.ref(`capsulas/${capsulaId}`).update({
                aberta: true,
                dataVisualizacao: new Date().toISOString()
            });
            
            await new Promise(r => setTimeout(r, 800));
            flash.classList.remove('active');
            overlay.classList.remove('active');
            capsula.classList.remove('explode');
            
            clearInterval(countdownInterval);
            mostrarConteudo(true);
            criarConfetes();
        }

        function mostrarConteudo(autoplayAudio = false) {
            const fotoAberta = document.getElementById('fotoAberta');
            if (capsulaData.foto) fotoAberta.innerHTML = `<img src="${capsulaData.foto}">`;
            else fotoAberta.innerHTML = '<div style="width:100%;height:100%;background:#333;display:flex;align-items:center;justify-content:center;font-size:2rem">üë§</div>';
            
            document.getElementById('nomeAberta').textContent = `${capsulaData.nome} ${capsulaData.sobrenome}`;
            document.getElementById('dataAberta').textContent = `Criada em ${formatarData(capsulaData.dataCriacao)}`;
            document.getElementById('eventoAberta').textContent = eventoData?.nome || '';
            
            configurarAudio(autoplayAudio);
            
            if (capsulaData.desejos?.length > 0) {
                document.getElementById('desejosContainer').innerHTML = capsulaData.desejos.map(d => `<span class="tag-item">${d}</span>`).join('');
            }
            
            if (capsulaData.pessoas?.length > 0) {
                document.getElementById('secaoPessoas').style.display = 'block';
                document.getElementById('pessoasContainer').innerHTML = capsulaData.pessoas.map(p => `<span class="tag-item">${p}</span>`).join('');
            }
            
            if (capsulaData.perguntas) {
                const p = capsulaData.perguntas;
                let html = '';
                if (p.conquista) html += `<div class="pergunta-item"><div class="pergunta-label">üéØ Conquista esperada:</div><div class="pergunta-resposta">${p.conquista}</div></div>`;
                if (p.momento) html += `<div class="pergunta-item"><div class="pergunta-label">‚ú® Momento marcante:</div><div class="pergunta-resposta">${p.momento}</div></div>`;
                if (p.palavra) html += `<div class="pergunta-item"><div class="pergunta-label">üìù Palavra do momento:</div><div class="pergunta-resposta" style="font-size:1.4rem;color:var(--natal-gold);font-weight:600">"${p.palavra}"</div></div>`;
                if (p.felicidade) html += `<div class="pergunta-item"><div class="pergunta-label">üòä Felicidade:</div><div class="felicidade-display"><span class="felicidade-nota">${p.felicidade}</span><div class="felicidade-barra"><div class="felicidade-fill" style="width:${p.felicidade*10}%"></div></div><span style="color:rgba(255,255,255,0.5)">/10</span></div></div>`;
                if (p.previsao) html += `<div class="pergunta-item"><div class="pergunta-label">üîÆ Previs√£o:</div><div class="pergunta-resposta" style="font-style:italic">"${p.previsao}"</div></div>`;
                if (html) {
                    document.getElementById('secaoPerguntas').style.display = 'block';
                    document.getElementById('perguntasContainer').innerHTML = html;
                }
            }
            
            document.getElementById('mensagemTexto').textContent = capsulaData.mensagemPessoal || '(Sem mensagem)';
            document.getElementById('mensagemChars').textContent = `${(capsulaData.mensagemPessoal || '').length} caracteres`;
            
            if (capsulaData.reflexao) {
                document.getElementById('reflexaoForm').style.display = 'none';
                document.getElementById('reflexaoSalva').style.display = 'block';
                document.getElementById('reflexaoTexto').textContent = capsulaData.reflexao;
            }
            
            mostrarTela('telaAberta');
        }

        function configurarAudio(autoplay) {
            const secaoAudio = document.getElementById('secaoAudio');
            const audioPlayer = document.getElementById('audioPlayer');
            const audioStatus = document.getElementById('audioStatus');
            
            const temAudio = capsulaData.audioBase64 || capsulaData.audioUrl;
            if (!temAudio) { secaoAudio.style.display = 'none'; return; }
            
            secaoAudio.style.display = 'block';
            audioPlayer.src = capsulaData.audioBase64 || capsulaData.audioUrl;
            
            audioPlayer.oncanplay = () => {
                audioStatus.textContent = 'üéµ Pronto';
                if (autoplay) setTimeout(() => playAudio(), 1000);
            };
            audioPlayer.onplay = () => {
                isPlaying = true;
                document.getElementById('btnPlayAudio').classList.add('playing');
                document.getElementById('playIcon').textContent = '‚è∏Ô∏è';
                document.getElementById('playText').textContent = 'Pausar';
            };
            audioPlayer.onpause = () => {
                isPlaying = false;
                document.getElementById('btnPlayAudio').classList.remove('playing');
                document.getElementById('playIcon').textContent = '‚ñ∂Ô∏è';
                document.getElementById('playText').textContent = 'Ouvir';
            };
            audioPlayer.onended = () => {
                isPlaying = false;
                document.getElementById('btnPlayAudio').classList.remove('playing');
                document.getElementById('playIcon').textContent = 'üîÑ';
                document.getElementById('playText').textContent = 'Ouvir de novo';
            };
            audioPlayer.onerror = () => {
                audioStatus.textContent = '‚ö†Ô∏è Erro';
                if (capsulaData.audioBase64 && capsulaData.audioUrl) audioPlayer.src = capsulaData.audioUrl;
            };
            audioPlayer.load();
        }
        
        function toggleAudio() {
            const audioPlayer = document.getElementById('audioPlayer');
            if (isPlaying) audioPlayer.pause();
            else playAudio();
        }
        
        function playAudio() {
            document.getElementById('audioPlayer').play().catch(() => {
                document.getElementById('audioStatus').textContent = 'üëÜ Toque para ouvir';
            });
        }

        async function salvarReflexao() {
            const texto = document.getElementById('reflexaoInput').value.trim();
            if (!texto) { mostrarToast('Escreva algo'); return; }
            
            await database.ref(`capsulas/${capsulaId}/reflexao`).set(texto);
            document.getElementById('reflexaoForm').style.display = 'none';
            document.getElementById('reflexaoSalva').style.display = 'block';
            document.getElementById('reflexaoTexto').textContent = texto;
            mostrarToast('‚úì Salvo!');
        }

        // ==========================================
        // COMPARTILHAR - ANIMA√á√ÉO DE ABERTURA √âPICA
        // ==========================================
        async function abrirCompartilhar() {
            const modal = document.getElementById('shareModal');
            modal.classList.add('active');
            
            document.getElementById('btnBaixarVideo').disabled = true;
            document.getElementById('btnBaixarImg').disabled = true;
            document.getElementById('sharePreview').innerHTML = `
                <div class="share-status" id="shareStatus">
                    <div class="spinner"></div>
                    <span>Criando anima√ß√£o √©pica de abertura...</span>
                    <div class="share-progress">
                        <div class="share-progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
            `;
            
            try {
                await criarAnimacaoAbrir();
            } catch (err) {
                console.error('Erro na anima√ß√£o:', err);
                await criarImagemEstatica();
            }
        }

        async function criarAnimacaoAbrir() {
            const preview = document.getElementById('sharePreview');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            preview.innerHTML = '';
            preview.appendChild(canvas);
            
            // Dados
            const nome = capsulaData.nome;
            const palavra = capsulaData.perguntas?.palavra || '';
            const felicidade = capsulaData.perguntas?.felicidade || 0;
            const prioridades = (capsulaData.desejos || []).slice(0, 4).join(' ‚Ä¢ ');
            const dataCriacao = formatarData(capsulaData.dataCriacao);
            const dataAbertura = formatarData(new Date());
            
            // Elementos da anima√ß√£o
            const confetes = [];
            const particulas = [];
            const fogos = [];
            const estrelas = [];
            
            // Criar estrelas
            for (let i = 0; i < 120; i++) {
                estrelas.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 3 + 1,
                    twinkle: Math.random() * Math.PI * 2,
                    speed: Math.random() * 0.1 + 0.05
                });
            }
            
            // Criar confetes
            for (let i = 0; i < 100; i++) {
                confetes.push({
                    x: Math.random() * canvas.width,
                    y: -100 - Math.random() * 800,
                    size: Math.random() * 18 + 8,
                    color: ['#ffd700', '#c41e3a', '#165b33', '#ff6b6b', '#4ecdc4', '#fff', '#ff69b4', '#00ffff'][Math.floor(Math.random() * 8)],
                    speedY: Math.random() * 10 + 5,
                    speedX: Math.random() * 6 - 3,
                    rotation: Math.random() * 360,
                    rotSpeed: Math.random() * 15 - 7.5
                });
            }
            
            // Criar part√≠culas de explos√£o
            for (let i = 0; i < 80; i++) {
                const angle = (i / 80) * Math.PI * 2;
                const speed = Math.random() * 25 + 10;
                particulas.push({
                    x: canvas.width / 2,
                    y: 600,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    life: 1,
                    color: ['#ffd700', '#ff6b6b', '#4ecdc4', '#fff'][Math.floor(Math.random() * 4)],
                    size: Math.random() * 8 + 4
                });
            }
            
            // Criar fogos de artif√≠cio
            for (let i = 0; i < 5; i++) {
                fogos.push({
                    x: 200 + Math.random() * 680,
                    y: 300 + Math.random() * 400,
                    radius: 0,
                    maxRadius: 150 + Math.random() * 100,
                    color: ['#ffd700', '#ff6b6b', '#4ecdc4', '#ff69b4'][Math.floor(Math.random() * 4)],
                    delay: i * 20,
                    alpha: 0
                });
            }
            
            // Anima√ß√£o
            let frame = 0;
            const totalFrames = 210; // 3.5 segundos
            const chunks = [];
            
            const stream = canvas.captureStream(30);
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
            
            recorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };
            
            recorder.onstop = () => {
                videoBlob = new Blob(chunks, { type: 'video/webm' });
                
                canvas.toBlob((blob) => {
                    imagemBlob = blob;
                    document.getElementById('btnBaixarImg').disabled = false;
                }, 'image/png');
                
                const videoUrl = URL.createObjectURL(videoBlob);
                preview.innerHTML = `<video src="${videoUrl}" autoplay loop muted playsinline style="width:100%;height:100%;object-fit:contain;border-radius:20px"></video>`;
                
                document.getElementById('btnBaixarVideo').disabled = false;
                mostrarToast('üé¨ V√≠deo criado!');
            };
            
            recorder.start();
            
            function animate() {
                frame++;
                const progress = frame / totalFrames;
                document.getElementById('progressBar').style.width = (progress * 100) + '%';
                
                // Background √©pico
                ctx.fillStyle = '#0a0e14';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Gradiente radial que pulsa
                const pulseSize = 800 + Math.sin(frame * 0.1) * 100;
                const bgGrad = ctx.createRadialGradient(canvas.width/2, canvas.height/2, 0, canvas.width/2, canvas.height/2, pulseSize);
                bgGrad.addColorStop(0, 'rgba(255, 215, 0, 0.15)');
                bgGrad.addColorStop(0.3, 'rgba(196, 30, 58, 0.1)');
                bgGrad.addColorStop(0.6, 'rgba(22, 91, 51, 0.08)');
                bgGrad.addColorStop(1, 'transparent');
                ctx.fillStyle = bgGrad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Estrelas com twinkle
                estrelas.forEach(s => {
                    s.twinkle += s.speed;
                    const alpha = 0.3 + Math.sin(s.twinkle) * 0.7;
                    ctx.fillStyle = `rgba(255,255,255,${alpha})`;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // Fase 1: Explos√£o inicial (frames 0-60)
                if (frame < 60) {
                    // C√°psula tremendo e explodindo
                    const shake = Math.sin(frame * 0.8) * (10 - frame * 0.15);
                    const scale = frame < 40 ? 1 : 1 + (frame - 40) * 0.05;
                    const alpha = frame < 50 ? 1 : 1 - (frame - 50) * 0.1;
                    
                    ctx.save();
                    ctx.translate(canvas.width/2 + shake, 600);
                    ctx.scale(scale, scale);
                    ctx.globalAlpha = alpha;
                    ctx.font = '200px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('üéÅ', 0, 0);
                    ctx.restore();
                    
                    // Flash de explos√£o
                    if (frame > 45 && frame < 60) {
                        const flashAlpha = (frame - 45) / 15 * 0.8;
                        ctx.fillStyle = `rgba(255,255,255,${flashAlpha})`;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                }
                
                // Fase 2: Part√≠culas de explos√£o (frames 30-100)
                if (frame > 30) {
                    particulas.forEach(p => {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.5; // Gravidade
                        p.life -= 0.015;
                        p.vx *= 0.98;
                        
                        if (p.life > 0) {
                            ctx.globalAlpha = p.life;
                            ctx.fillStyle = p.color;
                            ctx.beginPath();
                            ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2);
                            ctx.fill();
                            ctx.globalAlpha = 1;
                        }
                    });
                }
                
                // Fase 3: Fogos de artif√≠cio (frames 60-150)
                if (frame > 60) {
                    fogos.forEach((f, i) => {
                        if (frame > 60 + f.delay) {
                            f.radius += 8;
                            f.alpha = f.radius < f.maxRadius * 0.5 ? f.radius / (f.maxRadius * 0.5) : 1 - (f.radius - f.maxRadius * 0.5) / (f.maxRadius * 0.5);
                            
                            if (f.alpha > 0) {
                                // C√≠rculo de fogo
                                ctx.strokeStyle = f.color;
                                ctx.lineWidth = 4;
                                ctx.globalAlpha = f.alpha * 0.8;
                                ctx.beginPath();
                                ctx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
                                ctx.stroke();
                                
                                // Part√≠culas do fogo
                                for (let j = 0; j < 12; j++) {
                                    const angle = (j / 12) * Math.PI * 2 + frame * 0.05;
                                    const px = f.x + Math.cos(angle) * f.radius;
                                    const py = f.y + Math.sin(angle) * f.radius;
                                    ctx.fillStyle = f.color;
                                    ctx.beginPath();
                                    ctx.arc(px, py, 6, 0, Math.PI * 2);
                                    ctx.fill();
                                }
                                ctx.globalAlpha = 1;
                            }
                        }
                    });
                }
                
                // T√≠tulo C√ÅPSULA ABERTA com efeito de apari√ß√£o
                if (frame > 50) {
                    const titleAlpha = Math.min(1, (frame - 50) / 30);
                    const titleScale = 0.5 + titleAlpha * 0.5;
                    
                    ctx.save();
                    ctx.translate(canvas.width/2, 200);
                    ctx.scale(titleScale, titleScale);
                    ctx.globalAlpha = titleAlpha;
                    
                    // Glow
                    ctx.shadowColor = '#ffd700';
                    ctx.shadowBlur = 40;
                    ctx.font = 'bold 72px Arial';
                    ctx.fillStyle = '#ffd700';
                    ctx.textAlign = 'center';
                    ctx.fillText('üéâ C√ÅPSULA ABERTA! üéâ', 0, 0);
                    ctx.shadowBlur = 0;
                    
                    ctx.restore();
                    
                    // Subt√≠tulo
                    ctx.globalAlpha = titleAlpha;
                    ctx.font = '36px Arial';
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.textAlign = 'center';
                    ctx.fillText(eventoData?.nome || 'C√°psula do Tempo', canvas.width/2, 280);
                    ctx.globalAlpha = 1;
                }
                
                // Foto circular com anima√ß√£o de revela√ß√£o
                if (frame > 80 && fotoImg && fotoImg.complete) {
                    const fotoY = 500;
                    const fotoSize = 300;
                    const fotoAlpha = Math.min(1, (frame - 80) / 30);
                    const fotoScale = 0.3 + fotoAlpha * 0.7;
                    
                    ctx.save();
                    ctx.translate(canvas.width/2, fotoY);
                    ctx.scale(fotoScale, fotoScale);
                    ctx.globalAlpha = fotoAlpha;
                    
                    // Borda brilhante animada
                    const hue = (frame * 3) % 360;
                    ctx.beginPath();
                    ctx.arc(0, 0, fotoSize/2 + 20, 0, Math.PI * 2);
                    const borderGrad = ctx.createLinearGradient(-200, 0, 200, 0);
                    borderGrad.addColorStop(0, `hsl(${hue}, 100%, 60%)`);
                    borderGrad.addColorStop(0.5, '#ffd700');
                    borderGrad.addColorStop(1, `hsl(${(hue + 120) % 360}, 100%, 60%)`);
                    ctx.fillStyle = borderGrad;
                    ctx.fill();
                    
                    // Foto
                    ctx.beginPath();
                    ctx.arc(0, 0, fotoSize/2, 0, Math.PI * 2);
                    ctx.clip();
                    
                    const imgRatio = fotoImg.width / fotoImg.height;
                    let drawW = fotoSize, drawH = fotoSize;
                    if (imgRatio > 1) drawW = fotoSize * imgRatio;
                    else drawH = fotoSize / imgRatio;
                    ctx.drawImage(fotoImg, -drawW/2, -drawH/2, drawW, drawH);
                    
                    ctx.restore();
                }
                
                // Nome com typewriter
                if (frame > 100) {
                    const nameChars = Math.min(nome.length, Math.floor((frame - 100) / 2));
                    ctx.font = 'bold 64px Arial';
                    ctx.fillStyle = '#ffd700';
                    ctx.textAlign = 'center';
                    ctx.shadowColor = '#ffd700';
                    ctx.shadowBlur = 25;
                    ctx.fillText(nome.substring(0, nameChars), canvas.width/2, 720);
                    ctx.shadowBlur = 0;
                }
                
                // Datas
                if (frame > 120) {
                    ctx.font = '28px Arial';
                    ctx.fillStyle = 'rgba(255,255,255,0.8)';
                    ctx.fillText(`Criada: ${dataCriacao}  ‚Üí  Aberta: ${dataAbertura}`, canvas.width/2, 790);
                }
                
                // Palavra do momento com destaque
                if (frame > 140 && palavra) {
                    ctx.font = '28px Arial';
                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.fillText('Palavra que me definia:', canvas.width/2, 880);
                    
                    const wordScale = 1 + Math.sin(frame * 0.1) * 0.05;
                    ctx.save();
                    ctx.translate(canvas.width/2, 950);
                    ctx.scale(wordScale, wordScale);
                    ctx.font = 'bold 52px Arial';
                    ctx.fillStyle = '#ffd700';
                    ctx.fillText(`"${palavra}"`, 0, 0);
                    ctx.restore();
                }
                
                // Felicidade com barra animada
                if (frame > 160 && felicidade) {
                    ctx.font = '28px Arial';
                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.fillText('Felicidade naquela √©poca:', canvas.width/2, 1050);
                    
                    // Barra
                    const barWidth = 500;
                    const barX = (canvas.width - barWidth) / 2;
                    const barY = 1090;
                    const fillProgress = Math.min(1, (frame - 160) / 30);
                    
                    ctx.fillStyle = 'rgba(255,255,255,0.2)';
                    ctx.fillRect(barX, barY, barWidth, 30);
                    
                    const fillGrad = ctx.createLinearGradient(barX, 0, barX + barWidth, 0);
                    fillGrad.addColorStop(0, '#ffd700');
                    fillGrad.addColorStop(1, '#ff6b6b');
                    ctx.fillStyle = fillGrad;
                    ctx.fillRect(barX, barY, barWidth * (felicidade / 10) * fillProgress, 30);
                    
                    ctx.font = 'bold 48px Arial';
                    ctx.fillStyle = '#ffd700';
                    ctx.fillText(`${felicidade}/10 ‚≠ê`, canvas.width/2, 1180);
                }
                
                // Prioridades
                if (frame > 180 && prioridades) {
                    ctx.font = '26px Arial';
                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.fillText('Minhas prioridades eram:', canvas.width/2, 1280);
                    ctx.font = 'bold 30px Arial';
                    ctx.fillStyle = '#ffd700';
                    ctx.fillText(prioridades, canvas.width/2, 1330);
                }
                
                // Confetes caindo (sempre ap√≥s frame 60)
                if (frame > 60) {
                    confetes.forEach(c => {
                        c.y += c.speedY;
                        c.x += c.speedX;
                        c.rotation += c.rotSpeed;
                        
                        if (c.y > canvas.height + 50) {
                            c.y = -50;
                            c.x = Math.random() * canvas.width;
                        }
                        
                        ctx.save();
                        ctx.translate(c.x, c.y);
                        ctx.rotate(c.rotation * Math.PI / 180);
                        ctx.fillStyle = c.color;
                        ctx.fillRect(-c.size/2, -c.size/2, c.size, c.size);
                        ctx.restore();
                    });
                }
                
                // Rodap√©
                ctx.font = '28px Arial';
                ctx.fillStyle = 'rgba(255,255,255,0.5)';
                ctx.textAlign = 'center';
                ctx.fillText('üéÑ capsuladotempo.com üéÑ', canvas.width/2, canvas.height - 60);
                
                // Continuar
                if (frame < totalFrames) {
                    requestAnimationFrame(animate);
                } else {
                    recorder.stop();
                }
            }
            
            animate();
        }

        async function criarImagemEstatica() {
            const preview = document.getElementById('sharePreview');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = 1080;
            canvas.height = 1920;
            
            // Background
            const bg = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            bg.addColorStop(0, '#0a0e14');
            bg.addColorStop(0.3, '#1a3a1a');
            bg.addColorStop(0.7, '#2a1a2a');
            bg.addColorStop(1, '#0a0e14');
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Estrelas
            for (let i = 0; i < 150; i++) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.8})`;
                ctx.beginPath();
                ctx.arc(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 2 + 1, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Confetes
            const cores = ['#ffd700', '#c41e3a', '#165b33', '#ff6b6b', '#4ecdc4'];
            for (let i = 0; i < 60; i++) {
                ctx.fillStyle = cores[Math.floor(Math.random() * cores.length)];
                ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, Math.random() * 15 + 5, Math.random() * 15 + 5);
            }
            
            // T√≠tulo
            ctx.font = 'bold 64px Arial';
            ctx.fillStyle = '#ffd700';
            ctx.textAlign = 'center';
            ctx.fillText('üéâ C√ÅPSULA ABERTA! üéâ', canvas.width/2, 180);
            
            // Subt√≠tulo
            ctx.font = '36px Arial';
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillText(eventoData?.nome || 'C√°psula do Tempo', canvas.width/2, 250);
            
            // Foto
            if (fotoImg && fotoImg.complete) {
                const fotoY = 450;
                const fotoSize = 280;
                
                ctx.beginPath();
                ctx.arc(canvas.width/2, fotoY, fotoSize/2 + 15, 0, Math.PI * 2);
                ctx.fillStyle = '#ffd700';
                ctx.fill();
                
                ctx.save();
                ctx.beginPath();
                ctx.arc(canvas.width/2, fotoY, fotoSize/2, 0, Math.PI * 2);
                ctx.clip();
                const imgRatio = fotoImg.width / fotoImg.height;
                let drawW = fotoSize, drawH = fotoSize;
                if (imgRatio > 1) drawW = fotoSize * imgRatio;
                else drawH = fotoSize / imgRatio;
                ctx.drawImage(fotoImg, canvas.width/2 - drawW/2, fotoY - drawH/2, drawW, drawH);
                ctx.restore();
            }
            
            // Nome
            ctx.font = 'bold 56px Arial';
            ctx.fillStyle = '#ffd700';
            ctx.fillText(capsulaData.nome, canvas.width/2, 680);
            
            // Datas
            ctx.font = '28px Arial';
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillText(`Criada: ${formatarData(capsulaData.dataCriacao)}`, canvas.width/2, 750);
            ctx.fillText(`Aberta: ${formatarData(new Date())}`, canvas.width/2, 790);
            
            // Palavra
            if (capsulaData.perguntas?.palavra) {
                ctx.font = '28px Arial';
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fillText('Palavra que me definia:', canvas.width/2, 880);
                ctx.font = 'bold 48px Arial';
                ctx.fillStyle = '#ffd700';
                ctx.fillText(`"${capsulaData.perguntas.palavra}"`, canvas.width/2, 940);
            }
            
            // Felicidade
            if (capsulaData.perguntas?.felicidade) {
                const barWidth = 400;
                const barX = (canvas.width - barWidth) / 2;
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.fillRect(barX, 1020, barWidth, 25);
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(barX, 1020, barWidth * (capsulaData.perguntas.felicidade / 10), 25);
                
                ctx.font = 'bold 40px Arial';
                ctx.fillText(`${capsulaData.perguntas.felicidade}/10 ‚≠ê`, canvas.width/2, 1100);
            }
            
            // Prioridades
            if (capsulaData.desejos?.length > 0) {
                ctx.font = '28px Arial';
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fillText('Minhas prioridades eram:', canvas.width/2, 1200);
                ctx.font = 'bold 30px Arial';
                ctx.fillStyle = '#ffd700';
                ctx.fillText(capsulaData.desejos.slice(0, 4).join(' ‚Ä¢ '), canvas.width/2, 1250);
            }
            
            // Rodap√©
            ctx.font = '28px Arial';
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fillText('üéÑ capsuladotempo.com üéÑ', canvas.width/2, canvas.height - 60);
            
            // Converter
            canvas.toBlob((blob) => {
                imagemBlob = blob;
                const url = URL.createObjectURL(blob);
                preview.innerHTML = `<img src="${url}" style="width:100%;height:auto">`;
                document.getElementById('btnBaixarImg').disabled = false;
                document.getElementById('btnBaixarVideo').disabled = true;
                document.getElementById('progressBar').style.width = '100%';
            }, 'image/png');
        }

        function baixarVideo() {
            if (!videoBlob) { mostrarToast('Aguarde...'); return; }
            const url = URL.createObjectURL(videoBlob);
            const link = document.createElement('a');
            link.download = `capsula-aberta-${Date.now()}.webm`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            mostrarToast('üé¨ V√≠deo salvo!');
        }
        
        function baixarImagem() {
            if (!imagemBlob) { mostrarToast('Aguarde...'); return; }
            const url = URL.createObjectURL(imagemBlob);
            const link = document.createElement('a');
            link.download = `capsula-aberta-${Date.now()}.png`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            mostrarToast('üì∏ Imagem salva!');
        }
        
        function copiarLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => mostrarToast('üîó Link copiado!')).catch(() => {
                const i = document.createElement('textarea');
                i.value = url;
                document.body.appendChild(i);
                i.select();
                document.execCommand('copy');
                document.body.removeChild(i);
                mostrarToast('üîó Link copiado!');
            });
        }
        
        function fecharCompartilhar() {
            document.getElementById('shareModal').classList.remove('active');
        }
    </script>
</body>
</html>
