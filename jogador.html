<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÅ Criar C√°psula do Tempo</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;500;600;700;800&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        :root { --natal-red: #c41e3a; --natal-green: #165b33; --natal-gold: #ffd700; --midnight: #0a0e14; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(180deg, #0a0e14 0%, #1a2e1a 50%, #2a1a1a 100%); min-height: 100vh; color: white; overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Pacifico', cursive; }

        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; top: -20px; color: rgba(255,255,255,0.8); animation: snowfall linear infinite; }
        @keyframes snowfall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .container { max-width: 520px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }

        .tela { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.5s ease; }
        .tela.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .progress-bar { display: flex; gap: 6px; margin-bottom: 24px; padding: 0 10px; }
        .progress-step { flex: 1; height: 8px; border-radius: 4px; background: rgba(255,255,255,0.2); transition: all 0.3s; }
        .progress-step.active { background: var(--natal-gold); }
        .progress-step.done { background: var(--natal-green); }

        .tela-boas { align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
        .icone-presente { font-size: 5rem; animation: bounce 2s ease-in-out infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .titulo-evento { font-size: 2.2rem; color: var(--natal-gold); margin: 24px 0 12px; text-shadow: 0 0 30px rgba(255,215,0,0.5); }
        .subtitulo { color: rgba(255,255,255,0.8); margin-bottom: 8px; font-size: 1.1rem; }
        .data-abertura { background: rgba(255,215,0,0.15); color: var(--natal-gold); padding: 14px 28px; border-radius: 12px; margin: 20px 0 40px; font-weight: 600; font-size: 1.1rem; }
        .btn-iniciar { background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; padding: 20px 52px; border-radius: 16px; font-size: 1.3rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; box-shadow: 0 8px 30px rgba(255,215,0,0.4); transition: all 0.3s; }
        .btn-iniciar:hover { transform: translateY(-3px) scale(1.02); }

        .header-tela { text-align: center; margin-bottom: 28px; }
        .header-tela h2 { font-size: 1.8rem; color: var(--natal-gold); margin-bottom: 10px; }
        .header-tela p { color: rgba(255,255,255,0.8); font-size: 1.05rem; }
        .passo { font-size: 0.9rem; color: var(--natal-gold); margin-bottom: 8px; opacity: 0.9; font-weight: 500; }

        .foto-section { text-align: center; margin-bottom: 28px; }
        .foto-container { width: 180px; height: 180px; border-radius: 50%; margin: 0 auto 20px; position: relative; overflow: hidden; border: 5px solid rgba(255,215,0,0.5); background: rgba(255,255,255,0.08); transition: all 0.3s; }
        .foto-container.has-photo { border-color: var(--natal-gold); box-shadow: 0 0 40px rgba(255,215,0,0.4); }
        .foto-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--natal-gold); cursor: pointer; }
        .foto-placeholder span { font-size: 3.5rem; }
        .foto-placeholder p { font-size: 1rem; margin-top: 8px; font-weight: 500; }
        .foto-preview { width: 100%; height: 100%; object-fit: cover; }
        
        .foto-opcoes { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn-foto { background: rgba(255,255,255,0.1); border: 3px solid rgba(255,255,255,0.3); color: white; padding: 14px 24px; border-radius: 14px; font-size: 1.05rem; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-foto:hover { border-color: var(--natal-gold); background: rgba(255,215,0,0.1); }
        
        .camera-container { display: none; flex-direction: column; align-items: center; margin-top: 20px; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 20px; }
        .camera-container.active { display: flex; }
        .camera-video { width: 100%; max-width: 300px; border-radius: 16px; background: #000; transform: scaleX(-1); }
        .camera-actions { display: flex; gap: 12px; margin-top: 16px; }
        .btn-capturar { width: 70px; height: 70px; border-radius: 50%; background: var(--natal-red); border: 4px solid white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .btn-capturar:hover { transform: scale(1.1); }
        .btn-cancelar-camera { background: transparent; border: 2px solid rgba(255,255,255,0.4); color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: 'Poppins', sans-serif; }
        
        .foto-input { display: none; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 600; color: #ffffff; font-size: 1.1rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 18px 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 14px; background: rgba(255,255,255,0.15); color: #ffffff; font-size: 1.15rem; font-family: 'Poppins', sans-serif; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--natal-gold); background: rgba(255,255,255,0.2); box-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .form-group input::placeholder, .form-group textarea::placeholder { color: rgba(255,255,255,0.5); font-size: 1rem; }
        .form-group textarea { resize: none; min-height: 140px; line-height: 1.6; }
        .char-counter { text-align: right; font-size: 0.95rem; color: rgba(255,255,255,0.6); margin-top: 8px; font-weight: 500; }

        .btn-continuar { width: 100%; background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; padding: 18px; border-radius: 14px; font-size: 1.2rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; margin-top: 20px; transition: all 0.3s; }
        .btn-continuar:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255,215,0,0.4); }
        .btn-continuar:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-voltar { background: transparent; border: 3px solid rgba(255,255,255,0.4); color: white; padding: 14px; border-radius: 12px; font-size: 1.05rem; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; margin-top: 12px; transition: all 0.3s; width: 100%; }
        .btn-voltar:hover { border-color: white; background: rgba(255,255,255,0.1); }

        .btn-lacrar { width: 100%; background: linear-gradient(135deg, var(--natal-red), #a01830); color: white; border: none; padding: 20px; border-radius: 14px; font-size: 1.3rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; box-shadow: 0 8px 30px rgba(196,30,58,0.4); transition: all 0.3s; margin-top: 24px; }
        .btn-lacrar:hover { transform: translateY(-2px); }
        .btn-lacrar:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .tags-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 14px; }
        .tag { padding: 12px 20px; border-radius: 25px; background: rgba(255,255,255,0.1); border: 3px solid rgba(255,255,255,0.25); color: #ffffff; font-size: 1.05rem; cursor: pointer; transition: all 0.3s; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .tag:hover { border-color: rgba(255,215,0,0.6); background: rgba(255,215,0,0.15); }
        .tag.selected { background: rgba(255,215,0,0.25); border-color: var(--natal-gold); color: var(--natal-gold); font-weight: 700; transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.3); }

        .categoria { margin-bottom: 24px; }
        .categoria-titulo { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-size: 1.15rem; color: var(--natal-gold); font-weight: 600; }
        .contador-selecao { text-align: center; padding: 14px; background: rgba(255,215,0,0.15); border-radius: 12px; color: var(--natal-gold); font-weight: 700; margin-bottom: 20px; font-size: 1.1rem; border: 2px solid rgba(255,215,0,0.3); }

        .pessoas-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 16px; }
        .pessoa-card { background: rgba(255,255,255,0.08); border: 3px solid rgba(255,255,255,0.2); border-radius: 18px; padding: 20px 16px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .pessoa-card:hover { border-color: rgba(255,215,0,0.5); background: rgba(255,215,0,0.08); }
        .pessoa-card.selected { border-color: var(--natal-gold); background: rgba(255,215,0,0.2); box-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .pessoa-card .emoji { font-size: 2.5rem; margin-bottom: 10px; }
        .pessoa-card .nome { font-size: 1.05rem; font-weight: 600; }

        .audio-section { background: rgba(255,255,255,0.08); border-radius: 24px; padding: 28px; text-align: center; border: 3px solid rgba(255,255,255,0.15); }
        .audio-icon { font-size: 4.5rem; margin-bottom: 16px; }
        .audio-title { font-size: 1.3rem; color: var(--natal-gold); margin-bottom: 10px; font-weight: 600; }
        .audio-desc { color: rgba(255,255,255,0.8); font-size: 1.05rem; margin-bottom: 24px; line-height: 1.5; }
        
        .btn-gravar { width: 110px; height: 110px; border-radius: 50%; background: linear-gradient(135deg, var(--natal-red), #ff4444); border: none; color: white; font-size: 2.8rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 30px rgba(196,30,58,0.5); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; }
        .btn-gravar:hover { transform: scale(1.1); }
        .btn-gravar.gravando { animation: pulseRecord 1s infinite; background: #ff0000; }
        @keyframes pulseRecord { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 0 25px rgba(255,0,0,0); } }
        
        .tempo-gravacao { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; color: var(--natal-gold); margin-bottom: 16px; }
        .tempo-limite { font-size: 1rem; color: rgba(255,255,255,0.6); font-weight: 500; }
        
        .audio-preview { margin-top: 24px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 16px; }
        .audio-preview audio { width: 100%; height: 50px; margin-bottom: 16px; }
        .audio-actions { display: flex; gap: 12px; }
        .audio-actions button { flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s; font-size: 1rem; }
        .btn-regravar { background: transparent; border: 3px solid rgba(255,255,255,0.4); color: white; }
        .btn-confirmar-audio { background: var(--natal-green); border: none; color: white; }
        
        .audio-confirmado { display: flex; align-items: center; gap: 14px; padding: 18px; background: rgba(22,91,51,0.25); border-radius: 14px; margin-top: 20px; border: 2px solid rgba(22,91,51,0.5); }
        .audio-confirmado .check { font-size: 2rem; }
        .audio-confirmado .info { flex: 1; text-align: left; }
        .audio-confirmado .info strong { font-size: 1.1rem; }
        .audio-confirmado .duracao { color: var(--natal-gold); font-size: 1rem; margin-top: 4px; }

        .btn-pular { background: transparent; border: none; color: rgba(255,255,255,0.6); font-size: 1rem; cursor: pointer; margin-top: 20px; text-decoration: underline; font-weight: 500; }

        .pergunta-box { background: rgba(255,255,255,0.1); border-radius: 18px; padding: 22px; margin-bottom: 20px; border-left: 5px solid var(--natal-gold); }
        .pergunta-box label { display: block; margin-bottom: 14px; font-weight: 600; color: var(--natal-gold); font-size: 1.1rem; line-height: 1.4; }
        .pergunta-box input, .pergunta-box textarea { background: rgba(0,0,0,0.3); border: 3px solid rgba(255,255,255,0.25); color: #ffffff; font-size: 1.15rem; padding: 16px 18px; }
        .pergunta-box input:focus, .pergunta-box textarea:focus { border-color: var(--natal-gold); background: rgba(0,0,0,0.4); }
        .pergunta-box input::placeholder, .pergunta-box textarea::placeholder { color: rgba(255,255,255,0.45); font-size: 1rem; }
        
        .escala-felicidade { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 14px; }
        .escala-num { width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.15); border: 3px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 700; font-size: 1.2rem; transition: all 0.3s; }
        .escala-num:hover { border-color: var(--natal-gold); background: rgba(255,215,0,0.2); }
        .escala-num.selected { background: var(--natal-gold); color: var(--midnight); border-color: var(--natal-gold); transform: scale(1.15); box-shadow: 0 0 15px rgba(255,215,0,0.5); }

        .resumo-section { background: rgba(255,255,255,0.08); border-radius: 18px; padding: 22px; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.15); }
        .resumo-section h4 { color: var(--natal-gold); margin-bottom: 14px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .resumo-item { color: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 10px; }
        .mini-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .mini-tag { background: var(--natal-gold); color: var(--midnight); padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .loading-overlay.active { opacity: 1; visibility: visible; }
        .loading-capsula { font-size: 6rem; animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .loading-text { margin-top: 24px; font-size: 1.4rem; color: var(--natal-gold); animation: pulse 1.5s infinite; }

        .tela-sucesso { align-items: center; justify-content: flex-start; text-align: center; padding: 30px 20px; }
        .sucesso-foto { width: 130px; height: 130px; border-radius: 50%; margin: 0 auto 24px; border: 5px solid var(--natal-gold); overflow: hidden; background: linear-gradient(135deg, var(--natal-red), var(--natal-green)); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; animation: successPop 0.6s ease; }
        @keyframes successPop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .sucesso-titulo { font-size: 2rem; color: var(--natal-gold); margin-bottom: 14px; }
        .sucesso-msg { color: rgba(255,255,255,0.85); margin-bottom: 24px; font-size: 1.1rem; line-height: 1.5; }
        .sucesso-data { background: rgba(255,215,0,0.15); color: var(--natal-gold); padding: 14px 24px; border-radius: 12px; margin-bottom: 10px; font-weight: 700; font-size: 1.1rem; }
        .sucesso-dias { color: rgba(255,255,255,0.6); font-size: 1rem; margin-bottom: 28px; }

        .sucesso-btns { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .sucesso-btns button { padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-compartilhar { background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); border: none; color: white; }
        .btn-ver { background: var(--natal-gold); border: none; color: var(--midnight); }

        /* MODAL COMPARTILHAR */
        .share-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: flex-start; padding: 20px; overflow-y: auto; }
        .share-modal.active { display: flex; }
        .share-modal-content { max-width: 400px; width: 100%; text-align: center; padding-top: 20px; }
        .share-modal h3 { color: var(--natal-gold); font-size: 1.5rem; margin-bottom: 20px; font-family: 'Pacifico', cursive; }
        .share-preview { width: 100%; max-height: 50vh; overflow: hidden; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); background: #111; }
        .share-preview img { width: 100%; height: auto; display: block; }
        .share-preview canvas { width: 100%; height: auto; display: block; border-radius: 16px; }
        .share-btns { display: flex; flex-direction: column; gap: 12px; }
        .share-btns button { padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 1.1rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; }
        .btn-baixar-img { background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; }
        .btn-copiar-link { background: var(--natal-green); color: white; border: none; }
        .btn-fechar-share { background: transparent; border: 2px solid rgba(255,255,255,0.3); color: white; }
        .share-loading { color: var(--natal-gold); font-size: 1.1rem; padding: 40px; }

        .tela-erro { align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
        .erro-icon { font-size: 5rem; margin-bottom: 20px; }
        .erro-msg { color: rgba(255,255,255,0.7); font-size: 1.1rem; }

        .confetes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; }
        .confete { position: absolute; animation: confeteFall 3s ease-out forwards; }
        @keyframes confeteFall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(720deg); } }

        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--natal-green); color: white; padding: 16px 28px; border-radius: 14px; font-weight: 600; z-index: 3000; opacity: 0; transition: all 0.4s; font-size: 1.05rem; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--natal-red); }

        @media (max-width: 400px) {
            .container { padding: 16px; }
            .header-tela h2 { font-size: 1.5rem; }
            .pessoas-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .escala-num { width: 42px; height: 42px; font-size: 1rem; }
            .foto-opcoes { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="confetes" id="confetes"></div>

    <div class="container">
        <!-- TELA BOAS VINDAS -->
        <div class="tela tela-boas active" id="telaBoas">
            <div class="icone-presente">üéÅ</div>
            <h1 class="titulo-evento" id="nomeEvento">C√°psula do Tempo</h1>
            <p class="subtitulo">Guarde suas mem√≥rias, sonhos e desejos</p>
            <p class="subtitulo">para o seu eu do futuro! ‚ú®</p>
            <div class="data-abertura">üìÖ Abertura: <span id="dataEvento">--/--/----</span></div>
            <button class="btn-iniciar" onclick="iniciar()">üéÅ CRIAR MINHA C√ÅPSULA</button>
        </div>

        <!-- PASSO 1: FOTO E NOME -->
        <div class="tela" id="telaCadastro">
            <div class="progress-bar">
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 1 de 6</p>
                <h2>üì∏ Quem √© voc√™?</h2>
                <p>Tire uma foto para reconhecer no futuro</p>
            </div>
            
            <div class="foto-section">
                <div class="foto-container" id="fotoContainer">
                    <div class="foto-placeholder" id="fotoPlaceholder">
                        <span>üì∑</span>
                        <p>Toque para adicionar foto</p>
                    </div>
                </div>
                
                <div class="foto-opcoes" id="fotoOpcoes">
                    <button class="btn-foto" onclick="abrirCamera()">
                        <span>üì∏</span> Tirar Selfie
                    </button>
                    <button class="btn-foto" onclick="abrirGaleria()">
                        <span>üñºÔ∏è</span> Escolher da Galeria
                    </button>
                </div>
                
                <div class="camera-container" id="cameraContainer">
                    <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
                    <div class="camera-actions">
                        <button class="btn-cancelar-camera" onclick="fecharCamera()">Cancelar</button>
                        <button class="btn-capturar" onclick="capturarFoto()">üì∑</button>
                    </div>
                </div>
                
                <input type="file" id="fotoInput" class="foto-input" accept="image/*" onchange="processarFotoGaleria(event)">
                <canvas id="fotoCanvas" style="display:none"></canvas>
            </div>
            
            <div class="form-group">
                <label>Seu nome</label>
                <input type="text" id="nome" placeholder="Como voc√™ se chama?" maxlength="30">
            </div>
            <div class="form-group">
                <label>Seu sobrenome</label>
                <input type="text" id="sobrenome" placeholder="Seu sobrenome" maxlength="30">
            </div>
            <button class="btn-continuar" onclick="irParaDesejos()">Continuar ‚Üí</button>
        </div>

        <!-- PASSO 2: DESEJOS / PRIORIDADES -->
        <div class="tela" id="telaDesejos">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 2 de 6</p>
                <h2>üåü Suas Prioridades</h2>
                <p>Quais s√£o suas prioridades para o ano que vem chegando?</p>
            </div>
            <div class="contador-selecao">‚ú® Selecionados: <span id="contadorDesejos">0</span> / 10</div>
            
            <div class="categoria">
                <div class="categoria-titulo">‚ù§Ô∏è Vida Pessoal</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Sa√∫de</span>
                    <span class="tag" onclick="toggleTag(this)">Fam√≠lia</span>
                    <span class="tag" onclick="toggleTag(this)">Romance</span>
                    <span class="tag" onclick="toggleTag(this)">Amizades</span>
                    <span class="tag" onclick="toggleTag(this)">Paz interior</span>
                    <span class="tag" onclick="toggleTag(this)">Felicidade</span>
                </div>
            </div>
            <div class="categoria">
                <div class="categoria-titulo">üéØ Conquistas</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Viajar</span>
                    <span class="tag" onclick="toggleTag(this)">Carreira</span>
                    <span class="tag" onclick="toggleTag(this)">Estudos</span>
                    <span class="tag" onclick="toggleTag(this)">Promo√ß√£o</span>
                    <span class="tag" onclick="toggleTag(this)">Neg√≥cio pr√≥prio</span>
                    <span class="tag" onclick="toggleTag(this)">Casa pr√≥pria</span>
                </div>
            </div>
            <div class="categoria">
                <div class="categoria-titulo">üí∞ Financeiro</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Economizar</span>
                    <span class="tag" onclick="toggleTag(this)">Investir</span>
                    <span class="tag" onclick="toggleTag(this)">Quitar d√≠vidas</span>
                    <span class="tag" onclick="toggleTag(this)">Carro novo</span>
                    <span class="tag" onclick="toggleTag(this)">Renda extra</span>
                </div>
            </div>
            <div class="categoria">
                <div class="categoria-titulo">üåà Bem-estar</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Exerc√≠cios</span>
                    <span class="tag" onclick="toggleTag(this)">Medita√ß√£o</span>
                    <span class="tag" onclick="toggleTag(this)">Terapia</span>
                    <span class="tag" onclick="toggleTag(this)">Hobby novo</span>
                    <span class="tag" onclick="toggleTag(this)">Menos stress</span>
                    <span class="tag" onclick="toggleTag(this)">Ler mais</span>
                    <span class="tag" onclick="toggleTag(this)">Dormir melhor</span>
                </div>
            </div>
            <button class="btn-continuar" onclick="irParaPessoas()">Continuar ‚Üí</button>
            <button class="btn-voltar" onclick="voltarPara('telaCadastro')">‚Üê Voltar</button>
        </div>

        <!-- PASSO 3: PESSOAS -->
        <div class="tela" id="telaPessoas">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 3 de 6</p>
                <h2>üë• Pessoas Importantes</h2>
                <p>Quem voc√™ quer se dedicar mais este ano?</p>
            </div>
            
            <div class="pessoas-grid">
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Fam√≠lia">
                    <div class="emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <div class="nome">Fam√≠lia</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Amigos">
                    <div class="emoji">üëØ</div>
                    <div class="nome">Amigos</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Parceiro(a)">
                    <div class="emoji">üíë</div>
                    <div class="nome">Parceiro(a)</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Filhos">
                    <div class="emoji">üë∂</div>
                    <div class="nome">Filhos</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Colegas">
                    <div class="emoji">üíº</div>
                    <div class="nome">Colegas</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Eu mesmo">
                    <div class="emoji">ü™û</div>
                    <div class="nome">Eu mesmo</div>
                </div>
            </div>
            
            <button class="btn-continuar" onclick="irParaPerguntas()">Continuar ‚Üí</button>
            <button class="btn-voltar" onclick="voltarPara('telaDesejos')">‚Üê Voltar</button>
        </div>

        <!-- PASSO 4: PERGUNTAS -->
        <div class="tela" id="telaPerguntas">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 4 de 6</p>
                <h2>üí≠ Reflex√µes</h2>
                <p>Responda para seu eu do futuro</p>
            </div>
            
            <div class="pergunta-box">
                <label>üéØ O que voc√™ acha que vai conquistar at√© l√°?</label>
                <input type="text" id="perguntaConquista" placeholder="Ex: Falar ingl√™s, aprender a dirigir...">
            </div>
            
            <div class="pergunta-box">
                <label>‚ú® Qual foi o momento mais marcante do seu ano at√© agora?</label>
                <textarea id="perguntaMomento" placeholder="Conte aqui o que te marcou esse ano..." rows="3"></textarea>
            </div>
            
            <div class="pergunta-box">
                <label>üìù Uma palavra que define seu momento atual:</label>
                <input type="text" id="perguntaPalavra" placeholder="Esperan√ßa, Gratid√£o, Luta, F√©..." maxlength="25">
            </div>
            
            <div class="pergunta-box">
                <label>üòä De 1 a 10, qual sua felicidade hoje?</label>
                <div class="escala-felicidade" id="escalaFelicidade">
                    <div class="escala-num" onclick="selecionarNota(1)">1</div>
                    <div class="escala-num" onclick="selecionarNota(2)">2</div>
                    <div class="escala-num" onclick="selecionarNota(3)">3</div>
                    <div class="escala-num" onclick="selecionarNota(4)">4</div>
                    <div class="escala-num" onclick="selecionarNota(5)">5</div>
                    <div class="escala-num" onclick="selecionarNota(6)">6</div>
                    <div class="escala-num" onclick="selecionarNota(7)">7</div>
                    <div class="escala-num" onclick="selecionarNota(8)">8</div>
                    <div class="escala-num" onclick="selecionarNota(9)">9</div>
                    <div class="escala-num" onclick="selecionarNota(10)">10</div>
                </div>
            </div>
            
            <div class="pergunta-box">
                <label>üîÆ Fa√ßa uma previs√£o para o ano que vem:</label>
                <textarea id="perguntaPrevisao" placeholder="O que voc√™ acha que vai acontecer? Pode ser sobre voc√™, sua fam√≠lia, o mundo..." rows="3"></textarea>
            </div>
            
            <button class="btn-continuar" onclick="irParaAudio()">Continuar ‚Üí</button>
            <button class="btn-voltar" onclick="voltarPara('telaPessoas')">‚Üê Voltar</button>
        </div>

        <!-- PASSO 5: √ÅUDIO -->
        <div class="tela" id="telaAudio">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 5 de 6</p>
                <h2>üé§ Mensagem de Voz</h2>
                <p>Grave um recado para seu eu do futuro!</p>
            </div>
            
            <div class="audio-section">
                <div class="audio-icon">üéôÔ∏è</div>
                <div class="audio-title">Fale para voc√™ mesmo!</div>
                <div class="audio-desc">E a√≠, futuro eu! O que voc√™ gostaria de dizer?<br>Conte seus sonhos, medos, esperan√ßas...</div>
                
                <div class="tempo-gravacao" id="tempoGravacao">00:00</div>
                <button class="btn-gravar" id="btnGravar" onclick="toggleGravacao()">üé§</button>
                <div class="tempo-limite">‚è±Ô∏è M√°ximo: 60 segundos</div>
                
                <div class="audio-preview" id="audioPreview" style="display:none">
                    <audio id="audioPlayer" controls></audio>
                    <div class="audio-actions">
                        <button class="btn-regravar" onclick="regravar()">üîÑ Regravar</button>
                        <button class="btn-confirmar-audio" onclick="confirmarAudio()">‚úì Usar este</button>
                    </div>
                </div>
                
                <div class="audio-confirmado" id="audioConfirmado" style="display:none">
                    <span class="check">‚úÖ</span>
                    <div class="info">
                        <strong>√Åudio gravado com sucesso!</strong>
                        <div class="duracao" id="duracaoAudio">00:00</div>
                    </div>
                    <button style="background:transparent;border:none;color:white;cursor:pointer;font-size:1.3rem" onclick="regravar()">üîÑ</button>
                </div>
            </div>
            
            <button class="btn-continuar" onclick="irParaMensagem()">Continuar ‚Üí</button>
            <button class="btn-pular" onclick="pularAudio()">Pular esta etapa</button>
            <button class="btn-voltar" onclick="voltarPara('telaPerguntas')">‚Üê Voltar</button>
        </div>

        <!-- PASSO 6: MENSAGEM FINAL -->
        <div class="tela" id="telaMensagem">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 6 de 6 - √öltimo!</p>
                <h2>üíå Carta para o Futuro</h2>
                <p>Escreva uma mensagem especial</p>
            </div>
            
            <div class="resumo-section">
                <h4>üìã Resumo da sua c√°psula</h4>
                <div class="resumo-item"><strong>Prioridades:</strong></div>
                <div class="mini-tags" id="resumoDesejos"></div>
                <div class="resumo-item" style="margin-top:14px"><strong>Dedica√ß√£o:</strong> <span id="resumoPessoas">-</span></div>
                <div class="resumo-item"><strong>Felicidade atual:</strong> <span id="resumoFelicidade">-</span>/10</div>
                <div class="resumo-item"><strong>√Åudio:</strong> <span id="resumoAudio">N√£o gravado</span></div>
            </div>
            
            <div class="form-group">
                <label>‚úçÔ∏è Sua mensagem para o futuro:</label>
                <textarea id="mensagem" placeholder="Querido eu do futuro...

O que voc√™ est√° sentindo agora? 
O que espera para o pr√≥ximo ano?
O que te faz feliz hoje?
Tem algum medo ou preocupa√ß√£o?

Escreva tudo que quiser lembrar quando abrir esta c√°psula..." maxlength="5000" rows="10" oninput="atualizarContador()"></textarea>
                <div class="char-counter"><span id="charCounter">0</span> / 5000</div>
            </div>
            
            <button class="btn-lacrar" id="btnLacrar" onclick="lacrarCapsula()">üîí LACRAR MINHA C√ÅPSULA</button>
            <button class="btn-voltar" onclick="voltarPara('telaAudio')">‚Üê Voltar</button>
        </div>

        <!-- TELA SUCESSO -->
        <div class="tela tela-sucesso" id="telaSucesso">
            <div class="sucesso-foto" id="sucessoFoto">üéâ</div>
            <h2 class="sucesso-titulo">C√°psula Lacrada!</h2>
            <p class="sucesso-msg" id="sucessoMsg">Sua c√°psula est√° segura at√© a cerim√¥nia!</p>
            <div class="sucesso-data">üìÖ <span id="sucessoData">--/--/----</span></div>
            <div class="sucesso-dias" id="sucessoDias">-- dias restantes</div>
            <div class="sucesso-btns">
                <button class="btn-compartilhar" onclick="abrirCompartilhar()">üì∏ Compartilhar nas Redes</button>
                <button class="btn-ver" onclick="verCapsula()">üëÅÔ∏è Ver Minha C√°psula</button>
            </div>
        </div>

        <!-- TELA ERRO -->
        <div class="tela tela-erro" id="telaErro">
            <div class="erro-icon">üòï</div>
            <h2 style="color:var(--natal-gold);margin-bottom:12px">Ops!</h2>
            <p class="erro-msg">Evento n√£o encontrado ou j√° encerrado.</p>
        </div>
    </div>

    <!-- MODAL COMPARTILHAR -->
    <div class="share-modal" id="shareModal">
        <div class="share-modal-content">
            <h3>üì∏ Compartilhe sua C√°psula!</h3>
            <div class="share-preview" id="sharePreview">
                <div class="share-loading">‚è≥ Gerando imagem...</div>
            </div>
            <div class="share-btns">
                <button class="btn-baixar-img" id="btnBaixar" onclick="baixarImagem()">üì• Salvar Imagem no Celular</button>
                <button class="btn-copiar-link" onclick="copiarLink()">üîó Copiar Link da C√°psula</button>
                <button class="btn-fechar-share" onclick="fecharCompartilhar()">‚úï Fechar</button>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div class="loading-overlay" id="loading">
        <div class="loading-capsula">üéÅ</div>
        <div class="loading-text">Lacrando sua c√°psula...</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==========================================
        // FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyB2cNiBL1SU_QfjH_S_QGv_KSiFoocfqd4",
            authDomain: "capsuladotempo-f86bf.firebaseapp.com",
            databaseURL: "https://capsuladotempo-f86bf-default-rtdb.firebaseio.com",
            projectId: "capsuladotempo-f86bf",
            storageBucket: "capsuladotempo-f86bf.firebasestorage.app",
            messagingSenderId: "43014678980",
            appId: "1:43014678980:web:0c84f48037ee6924afdc91"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // ==========================================
        // VARI√ÅVEIS GLOBAIS
        // ==========================================
        let eventoId = null;
        let eventoData = null;
        let capsulaId = null;
        let fotoBase64 = null;
        let linkCapsula = null;
        let imagemGeradaBlob = null;
        
        let desejosSelecionados = [];
        let pessoasSelecionadas = [];
        let notaFelicidade = null;
        
        let cameraStream = null;
        
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBase64 = null;
        let audioConfirmadoFlag = false;
        let tempoInicio = null;
        let timerInterval = null;
        let duracaoFinal = 0;

        // ==========================================
        // UTILS
        // ==========================================
        const gerarID = (prefix) => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
        const formatarData = (d) => new Date(d).toLocaleDateString('pt-BR');
        
        const mostrarToast = (msg, tipo='success') => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (tipo === 'error' ? ' error' : '');
            setTimeout(() => t.className = 'toast', 3000);
        };

        function criarParticulas() {
            const c = document.getElementById('particles');
            ['‚ùÑ','‚ùÖ','‚ùÜ','‚úß'].forEach(f => {
                for(let i=0;i<6;i++) {
                    const e = document.createElement('div');
                    e.className = 'snowflake';
                    e.textContent = f;
                    e.style.left = Math.random()*100+'vw';
                    e.style.animationDuration = (8+Math.random()*5)+'s';
                    e.style.animationDelay = Math.random()*10+'s';
                    e.style.fontSize = (0.5+Math.random()*0.8)+'rem';
                    c.appendChild(e);
                }
            });
            for(let i=0;i<30;i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.left = Math.random()*100+'vw';
                s.style.top = Math.random()*100+'vh';
                const sz = 1+Math.random()*2;
                s.style.width = sz+'px';
                s.style.height = sz+'px';
                s.style.animationDuration = (2+Math.random()*3)+'s';
                c.appendChild(s);
            }
        }

        function criarConfetes() {
            const c = document.getElementById('confetes');
            c.innerHTML = '';
            const cores = ['#c41e3a','#165b33','#ffd700','#fff','#ff6b6b','#4ecdc4'];
            for(let i=0;i<100;i++) {
                const cf = document.createElement('div');
                cf.className = 'confete';
                cf.style.left = Math.random()*100+'vw';
                cf.style.background = cores[Math.floor(Math.random()*cores.length)];
                cf.style.animationDelay = Math.random()*2+'s';
                const sz = 5+Math.random()*10;
                cf.style.width = sz+'px';
                cf.style.height = sz+'px';
                cf.style.borderRadius = Math.random()>0.5?'50%':'0';
                c.appendChild(cf);
            }
        }

        function mostrarTela(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0);
        }

        function voltarPara(id) { mostrarTela(id); }

        // ==========================================
        // CARREGAR EVENTO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            criarParticulas();
            
            const params = new URLSearchParams(window.location.search);
            eventoId = params.get('evento');
            
            if (!eventoId) {
                mostrarTela('telaErro');
                return;
            }
            
            try {
                const snap = await database.ref(`eventos/${eventoId}`).once('value');
                eventoData = snap.val();
                
                if (!eventoData || eventoData.arquivado) {
                    mostrarTela('telaErro');
                    return;
                }
                
                document.getElementById('nomeEvento').textContent = eventoData.nome;
                document.getElementById('dataEvento').textContent = formatarData(eventoData.dataAbertura);
                
            } catch (err) {
                console.error(err);
                mostrarTela('telaErro');
            }
        });

        function iniciar() { mostrarTela('telaCadastro'); }

        // ==========================================
        // C√ÇMERA E FOTO
        // ==========================================
        async function abrirCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
                });
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraContainer').classList.add('active');
                document.getElementById('fotoOpcoes').style.display = 'none';
            } catch (err) {
                mostrarToast('N√£o foi poss√≠vel acessar a c√¢mera.', 'error');
            }
        }
        
        function fecharCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraContainer').classList.remove('active');
            document.getElementById('fotoOpcoes').style.display = 'flex';
        }
        
        function capturarFoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('fotoCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
            mostrarPreviewFoto(fotoBase64);
            fecharCamera();
        }
        
        function abrirGaleria() { document.getElementById('fotoInput').click(); }
        
        function processarFotoGaleria(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('fotoCanvas');
                    const max = 800;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } }
                    else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    mostrarPreviewFoto(fotoBase64);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function mostrarPreviewFoto(src) {
            const container = document.getElementById('fotoContainer');
            container.classList.add('has-photo');
            container.innerHTML = `<img class="foto-preview" src="${src}"><div style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,0.7);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer" onclick="removerFoto(event)">üîÑ</div>`;
        }
        
        function removerFoto(event) {
            event.stopPropagation();
            fotoBase64 = null;
            const container = document.getElementById('fotoContainer');
            container.classList.remove('has-photo');
            container.innerHTML = `<div class="foto-placeholder"><span>üì∑</span><p>Toque para adicionar foto</p></div>`;
            document.getElementById('fotoInput').value = '';
        }

        function irParaDesejos() {
            const nome = document.getElementById('nome').value.trim();
            const sobrenome = document.getElementById('sobrenome').value.trim();
            if (!nome || !sobrenome) { mostrarToast('Preencha nome e sobrenome', 'error'); return; }
            mostrarTela('telaDesejos');
        }

        // ==========================================
        // DESEJOS
        // ==========================================
        function toggleTag(el) {
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                desejosSelecionados = desejosSelecionados.filter(d => d !== el.textContent);
            } else {
                if (desejosSelecionados.length >= 10) { mostrarToast('M√°ximo 10!', 'error'); return; }
                el.classList.add('selected');
                desejosSelecionados.push(el.textContent);
            }
            document.getElementById('contadorDesejos').textContent = desejosSelecionados.length;
        }

        function irParaPessoas() {
            if (desejosSelecionados.length === 0) { mostrarToast('Selecione pelo menos 1', 'error'); return; }
            mostrarTela('telaPessoas');
        }

        // ==========================================
        // PESSOAS
        // ==========================================
        function togglePessoa(el) {
            const pessoa = el.dataset.pessoa;
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                pessoasSelecionadas = pessoasSelecionadas.filter(p => p !== pessoa);
            } else {
                el.classList.add('selected');
                pessoasSelecionadas.push(pessoa);
            }
        }

        function irParaPerguntas() { mostrarTela('telaPerguntas'); }

        // ==========================================
        // PERGUNTAS
        // ==========================================
        function selecionarNota(n) {
            notaFelicidade = n;
            document.querySelectorAll('.escala-num').forEach((el, i) => el.classList.toggle('selected', i+1 === n));
        }

        function irParaAudio() { mostrarTela('telaAudio'); }

        // ==========================================
        // √ÅUDIO
        // ==========================================
        async function toggleGravacao() {
            const btn = document.getElementById('btnGravar');
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
                    let mimeType = 'audio/webm';
                    if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];
                    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                    mediaRecorder.onstop = async () => {
                        duracaoFinal = Math.floor((Date.now() - tempoInicio) / 1000);
                        const audioBlob = new Blob(audioChunks, { type: mimeType });
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            audioBase64 = reader.result;
                            document.getElementById('audioPlayer').src = URL.createObjectURL(audioBlob);
                            document.getElementById('audioPreview').style.display = 'block';
                            document.getElementById('btnGravar').style.display = 'none';
                            document.getElementById('tempoGravacao').style.display = 'none';
                        };
                        reader.readAsDataURL(audioBlob);
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start(100);
                    btn.classList.add('gravando');
                    btn.innerHTML = '‚èπÔ∏è';
                    tempoInicio = Date.now();
                    timerInterval = setInterval(atualizarTempo, 100);
                    setTimeout(() => { if (mediaRecorder?.state === 'recording') pararGravacao(); }, 60000);
                } catch (err) { mostrarToast('Erro no microfone', 'error'); }
            } else { pararGravacao(); }
        }

        function pararGravacao() {
            if (mediaRecorder?.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(timerInterval);
                document.getElementById('btnGravar').classList.remove('gravando');
            }
        }

        function atualizarTempo() {
            const elapsed = Math.floor((Date.now() - tempoInicio) / 1000);
            document.getElementById('tempoGravacao').textContent = `${Math.floor(elapsed/60).toString().padStart(2,'0')}:${(elapsed%60).toString().padStart(2,'0')}`;
        }

        function regravar() {
            audioBase64 = null; audioConfirmadoFlag = false; mediaRecorder = null;
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('audioConfirmado').style.display = 'none';
            document.getElementById('btnGravar').style.display = 'flex';
            document.getElementById('btnGravar').innerHTML = 'üé§';
            document.getElementById('tempoGravacao').style.display = 'block';
            document.getElementById('tempoGravacao').textContent = '00:00';
        }

        function confirmarAudio() {
            audioConfirmadoFlag = true;
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('audioConfirmado').style.display = 'flex';
            document.getElementById('duracaoAudio').textContent = `Dura√ß√£o: ${Math.floor(duracaoFinal/60).toString().padStart(2,'0')}:${(duracaoFinal%60).toString().padStart(2,'0')}`;
            mostrarToast('‚úì √Åudio confirmado!');
        }

        function pularAudio() { audioBase64 = null; audioConfirmadoFlag = false; irParaMensagem(); }

        function irParaMensagem() {
            document.getElementById('resumoDesejos').innerHTML = desejosSelecionados.map(d => `<span class="mini-tag">${d}</span>`).join('');
            document.getElementById('resumoPessoas').textContent = pessoasSelecionadas.length > 0 ? pessoasSelecionadas.join(', ') : '-';
            document.getElementById('resumoFelicidade').textContent = notaFelicidade || '-';
            document.getElementById('resumoAudio').textContent = audioConfirmadoFlag ? '‚úÖ Gravado' : '‚ùå N√£o';
            mostrarTela('telaMensagem');
        }

        function atualizarContador() {
            document.getElementById('charCounter').textContent = document.getElementById('mensagem').value.length;
        }

        // ==========================================
        // LACRAR C√ÅPSULA
        // ==========================================
        async function lacrarCapsula() {
            const nome = document.getElementById('nome').value.trim();
            const sobrenome = document.getElementById('sobrenome').value.trim();
            const mensagem = document.getElementById('mensagem').value.trim();
            const conquista = document.getElementById('perguntaConquista').value.trim();
            const momento = document.getElementById('perguntaMomento').value.trim();
            const palavra = document.getElementById('perguntaPalavra').value.trim();
            const previsao = document.getElementById('perguntaPrevisao').value.trim();

            document.getElementById('btnLacrar').disabled = true;
            document.getElementById('loading').classList.add('active');

            try {
                capsulaId = gerarID('cap');
                let fotoUrl = null, audioUrl = null;

                if (fotoBase64) {
                    const fotoRef = storage.ref(`capsulas/${capsulaId}/foto.jpg`);
                    const fotoBlob = await (await fetch(fotoBase64)).blob();
                    await fotoRef.put(fotoBlob, { contentType: 'image/jpeg' });
                    fotoUrl = await fotoRef.getDownloadURL();
                }

                if (audioBase64 && audioConfirmadoFlag) {
                    try {
                        const audioBlob = await (await fetch(audioBase64)).blob();
                        const audioRef = storage.ref(`capsulas/${capsulaId}/audio.webm`);
                        await audioRef.put(audioBlob);
                        audioUrl = await audioRef.getDownloadURL();
                    } catch (e) { console.log('Audio storage error:', e); }
                }

                await database.ref(`capsulas/${capsulaId}`).set({
                    eventoId, nome, sobrenome, foto: fotoUrl,
                    desejos: desejosSelecionados, pessoas: pessoasSelecionadas,
                    perguntas: { conquista, momento, palavra, previsao, felicidade: notaFelicidade },
                    audioUrl, audioBase64: audioConfirmadoFlag ? audioBase64 : null,
                    mensagemPessoal: mensagem,
                    dataCriacao: new Date().toISOString(),
                    dataAbertura: eventoData.dataAbertura,
                    liberada: false, aberta: false
                });

                const base = window.location.origin + window.location.pathname.replace('jogador.html', '');
                linkCapsula = `${base}capsula.html?id=${capsulaId}`;

                document.getElementById('loading').classList.remove('active');
                mostrarSucesso(fotoUrl || fotoBase64, nome);
                
            } catch (err) {
                console.error(err);
                document.getElementById('loading').classList.remove('active');
                mostrarToast('Erro ao salvar', 'error');
                document.getElementById('btnLacrar').disabled = false;
            }
        }

        function mostrarSucesso(fotoSrc, nome) {
            const foto = document.getElementById('sucessoFoto');
            if (fotoSrc) foto.innerHTML = `<img src="${fotoSrc}" style="width:100%;height:100%;object-fit:cover">`;
            document.getElementById('sucessoMsg').textContent = `${nome}, sua c√°psula est√° segura!`;
            document.getElementById('sucessoData').textContent = formatarData(eventoData.dataAbertura);
            const dias = Math.ceil((new Date(eventoData.dataAbertura) - new Date()) / (1000*60*60*24));
            document.getElementById('sucessoDias').textContent = `${dias} dias restantes`;
            mostrarTela('telaSucesso');
            criarConfetes();
        }

        // ==========================================
        // COMPARTILHAR - GERAR IMAGEM
        // ==========================================
        async function abrirCompartilhar() {
            const modal = document.getElementById('shareModal');
            const preview = document.getElementById('sharePreview');
            modal.classList.add('active');
            preview.innerHTML = '<div class="share-loading">‚è≥ Gerando imagem...</div>';
            
            try {
                await gerarImagemCompartilhar();
            } catch (err) {
                console.error('Erro ao gerar imagem:', err);
                preview.innerHTML = '<div class="share-loading">‚ùå Erro ao gerar imagem</div>';
            }
        }

        async function gerarImagemCompartilhar() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Tamanho 9:16 para Stories
            const w = 1080;
            const h = 1920;
            canvas.width = w;
            canvas.height = h;
            
            // Background gradiente natalino
            const bg = ctx.createLinearGradient(0, 0, 0, h);
            bg.addColorStop(0, '#0a0e14');
            bg.addColorStop(0.3, '#1a2e1a');
            bg.addColorStop(0.6, '#2a1a1a');
            bg.addColorStop(1, '#0a0e14');
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, w, h);
            
            // Estrelas decorativas
            for (let i = 0; i < 150; i++) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random() * 0.8})`;
                ctx.beginPath();
                ctx.arc(Math.random() * w, Math.random() * h, Math.random() * 2 + 1, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // C√≠rculo decorativo dourado
            ctx.beginPath();
            ctx.arc(w/2, 200, 500, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255,215,0,0.08)';
            ctx.fill();
            
            // Emoji de presente no topo
            ctx.font = '120px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üéÅ', w/2, 180);
            
            // T√≠tulo
            ctx.font = 'bold 72px Arial, sans-serif';
            ctx.fillStyle = '#ffd700';
            ctx.fillText('C√ÅPSULA DO TEMPO', w/2, 320);
            
            // Subt√≠tulo evento
            ctx.font = '40px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillText(eventoData?.nome || 'Natal 2024', w/2, 390);
            
            // Foto do usu√°rio
            const fotoY = 480;
            const fotoSize = 320;
            
            // Borda dourada da foto
            ctx.beginPath();
            ctx.arc(w/2, fotoY + fotoSize/2, fotoSize/2 + 15, 0, Math.PI * 2);
            const borderGrad = ctx.createLinearGradient(w/2 - 200, fotoY, w/2 + 200, fotoY + fotoSize);
            borderGrad.addColorStop(0, '#ffd700');
            borderGrad.addColorStop(0.5, '#fff8dc');
            borderGrad.addColorStop(1, '#ffd700');
            ctx.fillStyle = borderGrad;
            ctx.fill();
            
            // Foto circular
            if (fotoBase64) {
                try {
                    const img = await loadImage(fotoBase64);
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(w/2, fotoY + fotoSize/2, fotoSize/2, 0, Math.PI * 2);
                    ctx.clip();
                    
                    // Centralizar e cobrir
                    const imgRatio = img.width / img.height;
                    let drawW, drawH, drawX, drawY;
                    if (imgRatio > 1) {
                        drawH = fotoSize;
                        drawW = fotoSize * imgRatio;
                        drawX = w/2 - drawW/2;
                        drawY = fotoY;
                    } else {
                        drawW = fotoSize;
                        drawH = fotoSize / imgRatio;
                        drawX = w/2 - fotoSize/2;
                        drawY = fotoY - (drawH - fotoSize) / 2;
                    }
                    ctx.drawImage(img, drawX, drawY, drawW, drawH);
                    ctx.restore();
                } catch (e) {
                    // C√≠rculo placeholder
                    ctx.beginPath();
                    ctx.arc(w/2, fotoY + fotoSize/2, fotoSize/2, 0, Math.PI * 2);
                    ctx.fillStyle = '#333';
                    ctx.fill();
                    ctx.font = '100px Arial';
                    ctx.fillText('üë§', w/2, fotoY + fotoSize/2 + 35);
                }
            } else {
                ctx.beginPath();
                ctx.arc(w/2, fotoY + fotoSize/2, fotoSize/2, 0, Math.PI * 2);
                ctx.fillStyle = '#333';
                ctx.fill();
                ctx.font = '100px Arial';
                ctx.fillText('üë§', w/2, fotoY + fotoSize/2 + 35);
            }
            
            // Nome
            const nome = document.getElementById('nome').value.trim();
            ctx.font = 'bold 64px Arial, sans-serif';
            ctx.fillStyle = '#ffd700';
            ctx.fillText(nome, w/2, fotoY + fotoSize + 80);
            
            // Cadeado
            ctx.font = '140px Arial';
            ctx.fillText('üîí', w/2, fotoY + fotoSize + 240);
            
            // Status
            ctx.font = 'bold 48px Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.fillText('C√ÅPSULA LACRADA!', w/2, fotoY + fotoSize + 340);
            
            // Data de abertura
            ctx.font = '36px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.fillText(`üìÖ Abre em: ${formatarData(eventoData?.dataAbertura)}`, w/2, fotoY + fotoSize + 410);
            
            // Dias restantes
            const dias = Math.ceil((new Date(eventoData?.dataAbertura) - new Date()) / (1000*60*60*24));
            ctx.font = 'bold 72px Arial, sans-serif';
            ctx.fillStyle = '#ffd700';
            ctx.fillText(`${dias} DIAS`, w/2, fotoY + fotoSize + 510);
            
            // Prioridades
            if (desejosSelecionados.length > 0) {
                ctx.font = '30px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fillText('Minhas prioridades:', w/2, fotoY + fotoSize + 590);
                
                ctx.font = 'bold 36px Arial, sans-serif';
                ctx.fillStyle = '#ffd700';
                const tags = desejosSelecionados.slice(0, 4).join(' ‚Ä¢ ');
                ctx.fillText(tags, w/2, fotoY + fotoSize + 640);
            }
            
            // Felicidade
            if (notaFelicidade) {
                ctx.font = '30px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255,255,255,0.7)';
                ctx.fillText(`Felicidade hoje: ${notaFelicidade}/10 ‚≠ê`, w/2, fotoY + fotoSize + 720);
            }
            
            // Rodap√© decorativo
            ctx.beginPath();
            ctx.arc(w/2, h + 150, 400, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(196,30,58,0.1)';
            ctx.fill();
            
            // Cr√©ditos
            ctx.font = '28px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fillText('üéÑ C√°psula do Tempo üéÑ', w/2, h - 80);
            
            // Converter para blob e mostrar
            canvas.toBlob((blob) => {
                imagemGeradaBlob = blob;
                const url = URL.createObjectURL(blob);
                const preview = document.getElementById('sharePreview');
                preview.innerHTML = `<img src="${url}" alt="Compartilhar">`;
            }, 'image/png', 1.0);
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        function baixarImagem() {
            if (!imagemGeradaBlob) {
                mostrarToast('Aguarde a imagem carregar', 'error');
                return;
            }
            
            const url = URL.createObjectURL(imagemGeradaBlob);
            const link = document.createElement('a');
            link.download = `capsula-${Date.now()}.png`;
            link.href = url;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            mostrarToast('üì• Imagem salva!');
        }
        
        function copiarLink() {
            if (!linkCapsula) return;
            navigator.clipboard.writeText(linkCapsula).then(() => {
                mostrarToast('üîó Link copiado!');
            }).catch(() => {
                const i = document.createElement('textarea');
                i.value = linkCapsula;
                document.body.appendChild(i);
                i.select();
                document.execCommand('copy');
                document.body.removeChild(i);
                mostrarToast('üîó Link copiado!');
            });
        }
        
        function fecharCompartilhar() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function verCapsula() {
            if (linkCapsula) window.location.href = linkCapsula;
        }
    </script>
</body>
</html>
