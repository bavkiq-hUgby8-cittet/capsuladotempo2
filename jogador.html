<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÅ Criar C√°psula do Tempo</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;500;600;700;800&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- GIF.js para criar GIFs animados -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        :root { --natal-red: #c41e3a; --natal-green: #165b33; --natal-gold: #ffd700; --midnight: #0a0e14; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(180deg, #0a0e14 0%, #1a2e1a 50%, #2a1a1a 100%); min-height: 100vh; color: white; overflow-x: hidden; }
        h1, h2, h3 { font-family: 'Pacifico', cursive; }

        .particles { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .snowflake { position: absolute; top: -20px; color: rgba(255,255,255,0.8); animation: snowfall linear infinite; }
        @keyframes snowfall { 0% { transform: translateY(-10vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(360deg); } }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle ease-in-out infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .container { max-width: 520px; margin: 0 auto; padding: 20px; min-height: 100vh; display: flex; flex-direction: column; position: relative; z-index: 1; }

        .tela { display: none; flex-direction: column; flex: 1; animation: fadeIn 0.5s ease; }
        .tela.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .progress-bar { display: flex; gap: 6px; margin-bottom: 24px; padding: 0 10px; }
        .progress-step { flex: 1; height: 8px; border-radius: 4px; background: rgba(255,255,255,0.2); transition: all 0.3s; }
        .progress-step.active { background: var(--natal-gold); }
        .progress-step.done { background: var(--natal-green); }

        .tela-boas { align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
        .icone-presente { font-size: 5rem; animation: bounce 2s ease-in-out infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .titulo-evento { font-size: 2.2rem; color: var(--natal-gold); margin: 24px 0 12px; text-shadow: 0 0 30px rgba(255,215,0,0.5); }
        .subtitulo { color: rgba(255,255,255,0.8); margin-bottom: 8px; font-size: 1.1rem; }
        .data-abertura { background: rgba(255,215,0,0.15); color: var(--natal-gold); padding: 14px 28px; border-radius: 12px; margin: 20px 0 40px; font-weight: 600; font-size: 1.1rem; }
        .btn-iniciar { background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; padding: 20px 52px; border-radius: 16px; font-size: 1.3rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; box-shadow: 0 8px 30px rgba(255,215,0,0.4); transition: all 0.3s; }
        .btn-iniciar:hover { transform: translateY(-3px) scale(1.02); }

        .header-tela { text-align: center; margin-bottom: 28px; }
        .header-tela h2 { font-size: 1.8rem; color: var(--natal-gold); margin-bottom: 10px; }
        .header-tela p { color: rgba(255,255,255,0.8); font-size: 1.05rem; }
        .passo { font-size: 0.9rem; color: var(--natal-gold); margin-bottom: 8px; opacity: 0.9; font-weight: 500; }

        .foto-section { text-align: center; margin-bottom: 28px; }
        .foto-container { width: 180px; height: 180px; border-radius: 50%; margin: 0 auto 20px; position: relative; overflow: hidden; border: 5px solid rgba(255,215,0,0.5); background: rgba(255,255,255,0.08); transition: all 0.3s; }
        .foto-container.has-photo { border-color: var(--natal-gold); box-shadow: 0 0 40px rgba(255,215,0,0.4); }
        .foto-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--natal-gold); cursor: pointer; }
        .foto-placeholder span { font-size: 3.5rem; }
        .foto-placeholder p { font-size: 1rem; margin-top: 8px; font-weight: 500; }
        .foto-preview { width: 100%; height: 100%; object-fit: cover; }
        
        .foto-opcoes { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .btn-foto { background: rgba(255,255,255,0.1); border: 3px solid rgba(255,255,255,0.3); color: white; padding: 14px 24px; border-radius: 14px; font-size: 1.05rem; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn-foto:hover { border-color: var(--natal-gold); background: rgba(255,215,0,0.1); }
        
        .camera-container { display: none; flex-direction: column; align-items: center; margin-top: 20px; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 20px; }
        .camera-container.active { display: flex; }
        .camera-video { width: 100%; max-width: 300px; border-radius: 16px; background: #000; transform: scaleX(-1); }
        .camera-actions { display: flex; gap: 12px; margin-top: 16px; }
        .btn-capturar { width: 70px; height: 70px; border-radius: 50%; background: var(--natal-red); border: 4px solid white; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .btn-capturar:hover { transform: scale(1.1); }
        .btn-cancelar-camera { background: transparent; border: 2px solid rgba(255,255,255,0.4); color: white; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-family: 'Poppins', sans-serif; }
        
        .foto-input { display: none; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: 600; color: #ffffff; font-size: 1.1rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 18px 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 14px; background: rgba(255,255,255,0.15); color: #ffffff; font-size: 1.15rem; font-family: 'Poppins', sans-serif; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: var(--natal-gold); background: rgba(255,255,255,0.2); box-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .form-group input::placeholder, .form-group textarea::placeholder { color: rgba(255,255,255,0.5); font-size: 1rem; }
        .form-group textarea { resize: none; min-height: 140px; line-height: 1.6; }
        .char-counter { text-align: right; font-size: 0.95rem; color: rgba(255,255,255,0.6); margin-top: 8px; font-weight: 500; }

        .btn-continuar { width: 100%; background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); border: none; padding: 18px; border-radius: 14px; font-size: 1.2rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; margin-top: 20px; transition: all 0.3s; }
        .btn-continuar:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(255,215,0,0.4); }
        .btn-continuar:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-voltar { background: transparent; border: 3px solid rgba(255,255,255,0.4); color: white; padding: 14px; border-radius: 12px; font-size: 1.05rem; font-weight: 600; cursor: pointer; font-family: 'Poppins', sans-serif; margin-top: 12px; transition: all 0.3s; width: 100%; }
        .btn-voltar:hover { border-color: white; background: rgba(255,255,255,0.1); }

        .btn-lacrar { width: 100%; background: linear-gradient(135deg, var(--natal-red), #a01830); color: white; border: none; padding: 20px; border-radius: 14px; font-size: 1.3rem; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; box-shadow: 0 8px 30px rgba(196,30,58,0.4); transition: all 0.3s; margin-top: 24px; }
        .btn-lacrar:hover { transform: translateY(-2px); }
        .btn-lacrar:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .tags-grid { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 14px; }
        .tag { padding: 12px 20px; border-radius: 25px; background: rgba(255,255,255,0.1); border: 3px solid rgba(255,255,255,0.25); color: #ffffff; font-size: 1.05rem; cursor: pointer; transition: all 0.3s; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .tag:hover { border-color: rgba(255,215,0,0.6); background: rgba(255,215,0,0.15); }
        .tag.selected { background: rgba(255,215,0,0.25); border-color: var(--natal-gold); color: var(--natal-gold); font-weight: 700; transform: scale(1.05); box-shadow: 0 0 15px rgba(255,215,0,0.3); }

        .categoria { margin-bottom: 24px; }
        .categoria-titulo { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; font-size: 1.15rem; color: var(--natal-gold); font-weight: 600; }
        .contador-selecao { text-align: center; padding: 14px; background: rgba(255,215,0,0.15); border-radius: 12px; color: var(--natal-gold); font-weight: 700; margin-bottom: 20px; font-size: 1.1rem; border: 2px solid rgba(255,215,0,0.3); }

        .pessoas-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 16px; }
        .pessoa-card { background: rgba(255,255,255,0.08); border: 3px solid rgba(255,255,255,0.2); border-radius: 18px; padding: 20px 16px; text-align: center; cursor: pointer; transition: all 0.3s; }
        .pessoa-card:hover { border-color: rgba(255,215,0,0.5); background: rgba(255,215,0,0.08); }
        .pessoa-card.selected { border-color: var(--natal-gold); background: rgba(255,215,0,0.2); box-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .pessoa-card .emoji { font-size: 2.5rem; margin-bottom: 10px; }
        .pessoa-card .nome { font-size: 1.05rem; font-weight: 600; }

        .audio-section { background: rgba(255,255,255,0.08); border-radius: 24px; padding: 28px; text-align: center; border: 3px solid rgba(255,255,255,0.15); }
        .audio-icon { font-size: 4.5rem; margin-bottom: 16px; }
        .audio-title { font-size: 1.3rem; color: var(--natal-gold); margin-bottom: 10px; font-weight: 600; }
        .audio-desc { color: rgba(255,255,255,0.8); font-size: 1.05rem; margin-bottom: 24px; line-height: 1.5; }
        
        .btn-gravar { width: 110px; height: 110px; border-radius: 50%; background: linear-gradient(135deg, var(--natal-red), #ff4444); border: none; color: white; font-size: 2.8rem; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 30px rgba(196,30,58,0.5); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; }
        .btn-gravar:hover { transform: scale(1.1); }
        .btn-gravar.gravando { animation: pulseRecord 1s infinite; background: #ff0000; }
        @keyframes pulseRecord { 0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 0 25px rgba(255,0,0,0); } }
        
        .tempo-gravacao { font-family: 'Orbitron', sans-serif; font-size: 2.5rem; color: var(--natal-gold); margin-bottom: 16px; }
        .tempo-limite { font-size: 1rem; color: rgba(255,255,255,0.6); font-weight: 500; }
        
        .audio-preview { margin-top: 24px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 16px; }
        .audio-preview audio { width: 100%; height: 50px; margin-bottom: 16px; }
        .audio-actions { display: flex; gap: 12px; }
        .audio-actions button { flex: 1; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s; font-size: 1rem; }
        .btn-regravar { background: transparent; border: 3px solid rgba(255,255,255,0.4); color: white; }
        .btn-confirmar-audio { background: var(--natal-green); border: none; color: white; }
        
        .audio-confirmado { display: flex; align-items: center; gap: 14px; padding: 18px; background: rgba(22,91,51,0.25); border-radius: 14px; margin-top: 20px; border: 2px solid rgba(22,91,51,0.5); }
        .audio-confirmado .check { font-size: 2rem; }
        .audio-confirmado .info { flex: 1; text-align: left; }
        .audio-confirmado .info strong { font-size: 1.1rem; }
        .audio-confirmado .duracao { color: var(--natal-gold); font-size: 1rem; margin-top: 4px; }

        .btn-pular { background: transparent; border: none; color: rgba(255,255,255,0.6); font-size: 1rem; cursor: pointer; margin-top: 20px; text-decoration: underline; font-weight: 500; }

        .pergunta-box { background: rgba(255,255,255,0.1); border-radius: 18px; padding: 22px; margin-bottom: 20px; border-left: 5px solid var(--natal-gold); }
        .pergunta-box label { display: block; margin-bottom: 14px; font-weight: 600; color: var(--natal-gold); font-size: 1.1rem; line-height: 1.4; }
        .pergunta-box input, .pergunta-box textarea { background: rgba(0,0,0,0.3); border: 3px solid rgba(255,255,255,0.25); color: #ffffff; font-size: 1.15rem; padding: 16px 18px; }
        .pergunta-box input:focus, .pergunta-box textarea:focus { border-color: var(--natal-gold); background: rgba(0,0,0,0.4); }
        .pergunta-box input::placeholder, .pergunta-box textarea::placeholder { color: rgba(255,255,255,0.45); font-size: 1rem; }
        
        .escala-felicidade { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 14px; }
        .escala-num { width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.15); border: 3px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 700; font-size: 1.2rem; transition: all 0.3s; }
        .escala-num:hover { border-color: var(--natal-gold); background: rgba(255,215,0,0.2); }
        .escala-num.selected { background: var(--natal-gold); color: var(--midnight); border-color: var(--natal-gold); transform: scale(1.15); box-shadow: 0 0 15px rgba(255,215,0,0.5); }

        .resumo-section { background: rgba(255,255,255,0.08); border-radius: 18px; padding: 22px; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.15); }
        .resumo-section h4 { color: var(--natal-gold); margin-bottom: 14px; font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .resumo-item { color: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 10px; }
        .mini-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .mini-tag { background: var(--natal-gold); color: var(--midnight); padding: 6px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.92); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .loading-overlay.active { opacity: 1; visibility: visible; }
        .loading-capsula { font-size: 6rem; animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } }
        .loading-text { margin-top: 24px; font-size: 1.4rem; color: var(--natal-gold); animation: pulse 1.5s infinite; }

        .tela-sucesso { align-items: center; justify-content: flex-start; text-align: center; padding: 30px 20px; }
        .sucesso-foto { width: 130px; height: 130px; border-radius: 50%; margin: 0 auto 24px; border: 5px solid var(--natal-gold); overflow: hidden; background: linear-gradient(135deg, var(--natal-red), var(--natal-green)); display: flex; align-items: center; justify-content: center; font-size: 3.5rem; animation: successPop 0.6s ease; }
        @keyframes successPop { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .sucesso-titulo { font-size: 2rem; color: var(--natal-gold); margin-bottom: 14px; }
        .sucesso-msg { color: rgba(255,255,255,0.85); margin-bottom: 24px; font-size: 1.1rem; line-height: 1.5; }
        .sucesso-data { background: rgba(255,215,0,0.15); color: var(--natal-gold); padding: 14px 24px; border-radius: 12px; margin-bottom: 10px; font-weight: 700; font-size: 1.1rem; }
        .sucesso-dias { color: rgba(255,255,255,0.6); font-size: 1rem; margin-bottom: 28px; }

        .sucesso-btns { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .sucesso-btns button { padding: 16px; border-radius: 12px; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; transition: all 0.3s; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-compartilhar { background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); border: none; color: white; }
        .btn-ver { background: var(--natal-gold); border: none; color: var(--midnight); }

        /* MODAL COMPARTILHAR - ULTRA PROFISSIONAL */
        .share-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 2000; display: none; flex-direction: column; align-items: center; padding: 15px; overflow-y: auto; }
        .share-modal.active { display: flex; }
        .share-modal-content { max-width: 420px; width: 100%; text-align: center; }
        .share-modal h3 { color: var(--natal-gold); font-size: 1.5rem; margin: 15px 0; font-family: 'Pacifico', cursive; }
        .share-preview { width: 100%; max-width: 280px; margin: 0 auto 20px; border-radius: 20px; overflow: hidden; box-shadow: 0 10px 50px rgba(255,215,0,0.4); background: #000; }
        .share-preview img { width: 100%; display: block; }
        .share-preview canvas { width: 100%; display: block; }
        
        .share-status { background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .share-status .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,215,0,0.3); border-top-color: var(--natal-gold); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .share-status p { color: var(--natal-gold); font-weight: 600; }
        .share-progress { width: 100%; height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; margin-top: 10px; overflow: hidden; }
        .share-progress-bar { height: 100%; background: linear-gradient(90deg, var(--natal-gold), #ff6b6b, var(--natal-gold)); width: 0%; transition: width 0.3s; background-size: 200% 100%; animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .share-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .share-btns button { padding: 14px 10px; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: 'Poppins', sans-serif; font-size: 0.95rem; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; transition: all 0.3s; border: none; }
        .share-btns button:disabled { opacity: 0.4; cursor: not-allowed; }
        .share-btns button span.icon { font-size: 1.5rem; }
        .btn-img { background: linear-gradient(135deg, var(--natal-gold), #ffaa00); color: var(--midnight); }
        .btn-gif { background: linear-gradient(135deg, #ff416c, #ff4b2b); color: white; }
        .btn-link { background: var(--natal-green); color: white; }
        .btn-fechar { background: rgba(255,255,255,0.1); color: white; border: 2px solid rgba(255,255,255,0.3) !important; }
        .share-btns .full-width { grid-column: span 2; }

        .tela-erro { align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
        .erro-icon { font-size: 5rem; margin-bottom: 20px; }
        .erro-msg { color: rgba(255,255,255,0.7); font-size: 1.1rem; }

        .confetes { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1500; }
        .confete { position: absolute; animation: confeteFall 3s ease-out forwards; }
        @keyframes confeteFall { 0% { transform: translateY(-100vh) rotate(0deg); } 100% { transform: translateY(110vh) rotate(720deg); } }

        .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--natal-green); color: white; padding: 16px 28px; border-radius: 14px; font-weight: 600; z-index: 3000; opacity: 0; transition: all 0.4s; font-size: 1.05rem; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.error { background: var(--natal-red); }

        @media (max-width: 400px) {
            .container { padding: 16px; }
            .header-tela h2 { font-size: 1.5rem; }
            .pessoas-grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .escala-num { width: 42px; height: 42px; font-size: 1rem; }
            .foto-opcoes { flex-direction: column; }
            .share-btns { grid-template-columns: 1fr; }
            .share-btns .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <div class="particles" id="particles"></div>
    <div class="confetes" id="confetes"></div>

    <div class="container">
        <!-- TELA BOAS VINDAS -->
        <div class="tela tela-boas active" id="telaBoas">
            <div class="icone-presente">üéÅ</div>
            <h1 class="titulo-evento" id="nomeEvento">C√°psula do Tempo</h1>
            <p class="subtitulo">Guarde suas mem√≥rias, sonhos e desejos</p>
            <p class="subtitulo">para o seu eu do futuro! ‚ú®</p>
            <div class="data-abertura">üìÖ Abertura: <span id="dataEvento">--/--/----</span></div>
            <button class="btn-iniciar" onclick="iniciar()">üéÅ CRIAR MINHA C√ÅPSULA</button>
        </div>

        <!-- PASSO 1: FOTO E NOME -->
        <div class="tela" id="telaCadastro">
            <div class="progress-bar">
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 1 de 6</p>
                <h2>üì∏ Quem √© voc√™?</h2>
                <p>Tire uma foto para reconhecer no futuro</p>
            </div>
            
            <div class="foto-section">
                <div class="foto-container" id="fotoContainer">
                    <div class="foto-placeholder" id="fotoPlaceholder" onclick="abrirGaleria()">
                        <span>üì∑</span>
                        <p>Toque para adicionar foto</p>
                    </div>
                </div>
                
                <div class="foto-opcoes" id="fotoOpcoes">
                    <button class="btn-foto" onclick="abrirCamera()">
                        <span>üì∏</span> Tirar Selfie
                    </button>
                    <button class="btn-foto" onclick="abrirGaleria()">
                        <span>üñºÔ∏è</span> Escolher da Galeria
                    </button>
                </div>
                
                <div class="camera-container" id="cameraContainer">
                    <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
                    <div class="camera-actions">
                        <button class="btn-cancelar-camera" onclick="fecharCamera()">Cancelar</button>
                        <button class="btn-capturar" onclick="capturarFoto()">üì∑</button>
                    </div>
                </div>
                
                <input type="file" id="fotoInput" class="foto-input" accept="image/*" onchange="processarFotoGaleria(event)">
                <canvas id="fotoCanvas" style="display:none"></canvas>
            </div>
            
            <div class="form-group">
                <label>Seu nome</label>
                <input type="text" id="nome" placeholder="Como voc√™ se chama?" maxlength="30">
            </div>
            <div class="form-group">
                <label>Seu sobrenome</label>
                <input type="text" id="sobrenome" placeholder="Seu sobrenome" maxlength="30">
            </div>
            <button class="btn-continuar" onclick="irParaDesejos()">Continuar ‚Üí</button>
        </div>

        <!-- PASSO 2: DESEJOS / PRIORIDADES -->
        <div class="tela" id="telaDesejos">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 2 de 6</p>
                <h2>üåü Suas Prioridades</h2>
                <p>Quais s√£o suas prioridades para o ano que vem chegando?</p>
            </div>
            <div class="contador-selecao">‚ú® Selecionados: <span id="contadorDesejos">0</span> / 10</div>
            
            <div class="categoria">
                <div class="categoria-titulo">‚ù§Ô∏è Vida Pessoal</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Sa√∫de</span>
                    <span class="tag" onclick="toggleTag(this)">Fam√≠lia</span>
                    <span class="tag" onclick="toggleTag(this)">Romance</span>
                    <span class="tag" onclick="toggleTag(this)">Amizades</span>
                    <span class="tag" onclick="toggleTag(this)">Paz interior</span>
                    <span class="tag" onclick="toggleTag(this)">Felicidade</span>
                </div>
            </div>
            <div class="categoria">
                <div class="categoria-titulo">üéØ Conquistas</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Viajar</span>
                    <span class="tag" onclick="toggleTag(this)">Carreira</span>
                    <span class="tag" onclick="toggleTag(this)">Estudos</span>
                    <span class="tag" onclick="toggleTag(this)">Promo√ß√£o</span>
                    <span class="tag" onclick="toggleTag(this)">Neg√≥cio pr√≥prio</span>
                    <span class="tag" onclick="toggleTag(this)">Casa pr√≥pria</span>
                </div>
            </div>
            <div class="categoria">
                <div class="categoria-titulo">üí∞ Financeiro</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Economizar</span>
                    <span class="tag" onclick="toggleTag(this)">Investir</span>
                    <span class="tag" onclick="toggleTag(this)">Quitar d√≠vidas</span>
                    <span class="tag" onclick="toggleTag(this)">Carro novo</span>
                    <span class="tag" onclick="toggleTag(this)">Renda extra</span>
                </div>
            </div>
            <div class="categoria">
                <div class="categoria-titulo">üåà Bem-estar</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Exerc√≠cios</span>
                    <span class="tag" onclick="toggleTag(this)">Medita√ß√£o</span>
                    <span class="tag" onclick="toggleTag(this)">Terapia</span>
                    <span class="tag" onclick="toggleTag(this)">Hobby novo</span>
                    <span class="tag" onclick="toggleTag(this)">Menos stress</span>
                    <span class="tag" onclick="toggleTag(this)">Ler mais</span>
                    <span class="tag" onclick="toggleTag(this)">Dormir melhor</span>
                </div>
            </div>
            <button class="btn-continuar" onclick="irParaPessoas()">Continuar ‚Üí</button>
            <button class="btn-voltar" onclick="voltarPara('telaCadastro')">‚Üê Voltar</button>
        </div>

        <!-- PASSO 3: PESSOAS -->
        <div class="tela" id="telaPessoas">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 3 de 6</p>
                <h2>üë• Pessoas Importantes</h2>
                <p>Quem voc√™ quer se dedicar mais este ano?</p>
            </div>
            
            <div class="pessoas-grid">
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Fam√≠lia">
                    <div class="emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <div class="nome">Fam√≠lia</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Amigos">
                    <div class="emoji">üëØ</div>
                    <div class="nome">Amigos</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Parceiro(a)">
                    <div class="emoji">üíë</div>
                    <div class="nome">Parceiro(a)</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Filhos">
                    <div class="emoji">üë∂</div>
                    <div class="nome">Filhos</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Colegas">
                    <div class="emoji">üíº</div>
                    <div class="nome">Colegas</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Eu mesmo">
                    <div class="emoji">ü™û</div>
                    <div class="nome">Eu mesmo</div>
                </div>
            </div>
            
            <button class="btn-continuar" onclick="irParaPerguntas()">Continuar ‚Üí</button>
            <button class="btn-voltar" onclick="voltarPara('telaDesejos')">‚Üê Voltar</button>
        </div>

        <!-- PASSO 4: PERGUNTAS -->
        <div class="tela" id="telaPerguntas">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 4 de 6</p>
                <h2>üí≠ Reflex√µes</h2>
                <p>Responda para seu eu do futuro</p>
            </div>
            
            <div class="pergunta-box">
                <label>üéØ O que voc√™ acha que vai conquistar at√© l√°?</label>
                <input type="text" id="perguntaConquista" placeholder="Ex: Falar ingl√™s, aprender a dirigir...">
            </div>
            
            <div class="pergunta-box">
                <label>‚ú® Qual foi o momento mais marcante do seu ano at√© agora?</label>
                <textarea id="perguntaMomento" placeholder="Conte aqui o que te marcou esse ano..." rows="3"></textarea>
            </div>
            
            <div class="pergunta-box">
                <label>üìù Uma palavra que define seu momento atual:</label>
                <input type="text" id="perguntaPalavra" placeholder="Esperan√ßa, Gratid√£o, Luta, F√©..." maxlength="25">
            </div>
            
            <div class="pergunta-box">
                <label>üòä De 1 a 10, qual sua felicidade hoje?</label>
                <div class="escala-felicidade" id="escalaFelicidade">
                    <div class="escala-num" onclick="selecionarNota(1)">1</div>
                    <div class="escala-num" onclick="selecionarNota(2)">2</div>
                    <div class="escala-num" onclick="selecionarNota(3)">3</div>
                    <div class="escala-num" onclick="selecionarNota(4)">4</div>
                    <div class="escala-num" onclick="selecionarNota(5)">5</div>
                    <div class="escala-num" onclick="selecionarNota(6)">6</div>
                    <div class="escala-num" onclick="selecionarNota(7)">7</div>
                    <div class="escala-num" onclick="selecionarNota(8)">8</div>
                    <div class="escala-num" onclick="selecionarNota(9)">9</div>
                    <div class="escala-num" onclick="selecionarNota(10)">10</div>
                </div>
            </div>
            
            <div class="pergunta-box">
                <label>üîÆ Fa√ßa uma previs√£o para o ano que vem:</label>
                <textarea id="perguntaPrevisao" placeholder="O que voc√™ acha que vai acontecer? Pode ser sobre voc√™, sua fam√≠lia, o mundo..." rows="3"></textarea>
            </div>
            
            <button class="btn-continuar" onclick="irParaAudio()">Continuar ‚Üí</button>
            <button class="btn-voltar" onclick="voltarPara('telaPessoas')">‚Üê Voltar</button>
        </div>

        <!-- PASSO 5: √ÅUDIO -->
        <div class="tela" id="telaAudio">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 5 de 6</p>
                <h2>üé§ Mensagem de Voz</h2>
                <p>Grave um recado para seu eu do futuro!</p>
            </div>
            
            <div class="audio-section">
                <div class="audio-icon">üéôÔ∏è</div>
                <div class="audio-title">Fale para voc√™ mesmo!</div>
                <div class="audio-desc">E a√≠, futuro eu! O que voc√™ gostaria de dizer?<br>Conte seus sonhos, medos, esperan√ßas...</div>
                
                <div class="tempo-gravacao" id="tempoGravacao">00:00</div>
                <button class="btn-gravar" id="btnGravar" onclick="toggleGravacao()">üé§</button>
                <div class="tempo-limite">‚è±Ô∏è M√°ximo: 60 segundos</div>
                
                <div class="audio-preview" id="audioPreview" style="display:none">
                    <audio id="audioPlayer" controls></audio>
                    <div class="audio-actions">
                        <button class="btn-regravar" onclick="regravar()">üîÑ Regravar</button>
                        <button class="btn-confirmar-audio" onclick="confirmarAudio()">‚úì Usar este</button>
                    </div>
                </div>
                
                <div class="audio-confirmado" id="audioConfirmado" style="display:none">
                    <span class="check">‚úÖ</span>
                    <div class="info">
                        <strong>√Åudio gravado com sucesso!</strong>
                        <div class="duracao" id="duracaoAudio">00:00</div>
                    </div>
                    <button style="background:transparent;border:none;color:white;cursor:pointer;font-size:1.3rem" onclick="regravar()">üîÑ</button>
                </div>
            </div>
            
            <button class="btn-continuar" onclick="irParaMensagem()">Continuar ‚Üí</button>
            <button class="btn-pular" onclick="pularAudio()">Pular esta etapa</button>
            <button class="btn-voltar" onclick="voltarPara('telaPerguntas')">‚Üê Voltar</button>
        </div>

        <!-- PASSO 6: MENSAGEM FINAL -->
        <div class="tela" id="telaMensagem">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
            </div>
            <div class="header-tela">
                <p class="passo">Passo 6 de 6 - √öltimo!</p>
                <h2>üíå Carta para o Futuro</h2>
                <p>Escreva uma mensagem especial</p>
            </div>
            
            <div class="resumo-section">
                <h4>üìã Resumo da sua c√°psula</h4>
                <div class="resumo-item"><strong>Prioridades:</strong></div>
                <div class="mini-tags" id="resumoDesejos"></div>
                <div class="resumo-item" style="margin-top:14px"><strong>Dedica√ß√£o:</strong> <span id="resumoPessoas">-</span></div>
                <div class="resumo-item"><strong>Felicidade atual:</strong> <span id="resumoFelicidade">-</span>/10</div>
                <div class="resumo-item"><strong>√Åudio:</strong> <span id="resumoAudio">N√£o gravado</span></div>
            </div>
            
            <div class="form-group">
                <label>‚úçÔ∏è Sua mensagem para o futuro:</label>
                <textarea id="mensagem" placeholder="Querido eu do futuro...

O que voc√™ est√° sentindo agora? 
O que espera para o pr√≥ximo ano?
O que te faz feliz hoje?
Tem algum medo ou preocupa√ß√£o?

Escreva tudo que quiser lembrar quando abrir esta c√°psula..." maxlength="5000" rows="10" oninput="atualizarContador()"></textarea>
                <div class="char-counter"><span id="charCounter">0</span> / 5000</div>
            </div>
            
            <button class="btn-lacrar" id="btnLacrar" onclick="lacrarCapsula()">üîí LACRAR MINHA C√ÅPSULA</button>
            <button class="btn-voltar" onclick="voltarPara('telaAudio')">‚Üê Voltar</button>
        </div>

        <!-- TELA SUCESSO -->
        <div class="tela tela-sucesso" id="telaSucesso">
            <div class="sucesso-foto" id="sucessoFoto">üéâ</div>
            <h2 class="sucesso-titulo">C√°psula Lacrada!</h2>
            <p class="sucesso-msg" id="sucessoMsg">Sua c√°psula est√° segura at√© a cerim√¥nia!</p>
            <div class="sucesso-data">üìÖ <span id="sucessoData">--/--/----</span></div>
            <div class="sucesso-dias" id="sucessoDias">-- dias restantes</div>
            <div class="sucesso-btns">
                <button class="btn-compartilhar" onclick="abrirCompartilhar()">üì∏ Criar Imagem p/ Stories</button>
                <button class="btn-ver" onclick="verCapsula()">üëÅÔ∏è Ver Minha C√°psula</button>
            </div>
        </div>

        <!-- TELA ERRO -->
        <div class="tela tela-erro" id="telaErro">
            <div class="erro-icon">üòï</div>
            <h2 style="color:var(--natal-gold);margin-bottom:12px">Ops!</h2>
            <p class="erro-msg">Evento n√£o encontrado ou j√° encerrado.</p>
        </div>
    </div>

    <!-- MODAL COMPARTILHAR -->
    <div class="share-modal" id="shareModal">
        <div class="share-modal-content">
            <h3>‚ú® Sua Arte para Stories</h3>
            
            <div class="share-preview" id="sharePreview">
                <!-- Canvas ou imagem aqui -->
            </div>
            
            <div class="share-status" id="shareStatus">
                <div class="spinner"></div>
                <p>Criando sua arte...</p>
                <div class="share-progress">
                    <div class="share-progress-bar" id="progressBar"></div>
                </div>
            </div>
            
            <div class="share-btns">
                <button class="btn-img" id="btnSalvarImg" onclick="salvarImagem()" disabled>
                    <span class="icon">üì∏</span>
                    Salvar Imagem
                </button>
                <button class="btn-gif" id="btnSalvarGif" onclick="criarGifAnimado()" disabled>
                    <span class="icon">üé¨</span>
                    Criar GIF Animado
                </button>
                <button class="btn-link full-width" onclick="copiarLink()">
                    <span class="icon">üîó</span>
                    Copiar Link da C√°psula
                </button>
                <button class="btn-fechar full-width" onclick="fecharCompartilhar()">
                    ‚úï Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- LOADING -->
    <div class="loading-overlay" id="loading">
        <div class="loading-capsula">üéÅ</div>
        <div class="loading-text">Lacrando sua c√°psula...</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ==========================================
        // FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyB2cNiBL1SU_QfjH_S_QGv_KSiFoocfqd4",
            authDomain: "capsuladotempo-f86bf.firebaseapp.com",
            databaseURL: "https://capsuladotempo-f86bf-default-rtdb.firebaseio.com",
            projectId: "capsuladotempo-f86bf",
            storageBucket: "capsuladotempo-f86bf.firebasestorage.app",
            messagingSenderId: "43014678980",
            appId: "1:43014678980:web:0c84f48037ee6924afdc91"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // ==========================================
        // VARI√ÅVEIS GLOBAIS
        // ==========================================
        let eventoId = null;
        let eventoData = null;
        let capsulaId = null;
        let fotoBase64 = null;
        let linkCapsula = null;
        let imagemCanvas = null;
        let imagemBlob = null;
        
        let desejosSelecionados = [];
        let pessoasSelecionadas = [];
        let notaFelicidade = null;
        
        let cameraStream = null;
        
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBase64 = null;
        let audioConfirmadoFlag = false;
        let tempoInicio = null;
        let timerInterval = null;
        let duracaoFinal = 0;

        // ==========================================
        // UTILS
        // ==========================================
        const gerarID = (prefix) => `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
        const formatarData = (d) => new Date(d).toLocaleDateString('pt-BR');
        
        const mostrarToast = (msg, tipo='success') => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (tipo === 'error' ? ' error' : '');
            setTimeout(() => t.className = 'toast', 3000);
        };

        function criarParticulas() {
            const c = document.getElementById('particles');
            ['‚ùÑ','‚ùÖ','‚ùÜ','‚úß'].forEach(f => {
                for(let i=0;i<6;i++) {
                    const e = document.createElement('div');
                    e.className = 'snowflake';
                    e.textContent = f;
                    e.style.left = Math.random()*100+'vw';
                    e.style.animationDuration = (8+Math.random()*5)+'s';
                    e.style.animationDelay = Math.random()*10+'s';
                    e.style.fontSize = (0.5+Math.random()*0.8)+'rem';
                    c.appendChild(e);
                }
            });
            for(let i=0;i<30;i++) {
                const s = document.createElement('div');
                s.className = 'star';
                s.style.left = Math.random()*100+'vw';
                s.style.top = Math.random()*100+'vh';
                const sz = 1+Math.random()*2;
                s.style.width = sz+'px';
                s.style.height = sz+'px';
                s.style.animationDuration = (2+Math.random()*3)+'s';
                c.appendChild(s);
            }
        }

        function criarConfetes() {
            const c = document.getElementById('confetes');
            c.innerHTML = '';
            const cores = ['#c41e3a','#165b33','#ffd700','#fff','#ff6b6b','#4ecdc4'];
            for(let i=0;i<100;i++) {
                const cf = document.createElement('div');
                cf.className = 'confete';
                cf.style.left = Math.random()*100+'vw';
                cf.style.background = cores[Math.floor(Math.random()*cores.length)];
                cf.style.animationDelay = Math.random()*2+'s';
                const sz = 5+Math.random()*10;
                cf.style.width = sz+'px';
                cf.style.height = sz+'px';
                cf.style.borderRadius = Math.random()>0.5?'50%':'0';
                c.appendChild(cf);
            }
        }

        function mostrarTela(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0);
        }

        function voltarPara(id) { mostrarTela(id); }

        // ==========================================
        // CARREGAR EVENTO
        // ==========================================
        document.addEventListener('DOMContentLoaded', async () => {
            criarParticulas();
            
            const params = new URLSearchParams(window.location.search);
            eventoId = params.get('evento');
            
            if (!eventoId) {
                mostrarTela('telaErro');
                return;
            }
            
            try {
                const snap = await database.ref(`eventos/${eventoId}`).once('value');
                eventoData = snap.val();
                
                if (!eventoData || eventoData.arquivado) {
                    mostrarTela('telaErro');
                    return;
                }
                
                document.getElementById('nomeEvento').textContent = eventoData.nome;
                document.getElementById('dataEvento').textContent = formatarData(eventoData.dataAbertura);
                
            } catch (err) {
                console.error(err);
                mostrarTela('telaErro');
            }
        });

        function iniciar() { mostrarTela('telaCadastro'); }

        // ==========================================
        // C√ÇMERA E FOTO
        // ==========================================
        async function abrirCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
                });
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraContainer').classList.add('active');
                document.getElementById('fotoOpcoes').style.display = 'none';
            } catch (err) {
                mostrarToast('N√£o foi poss√≠vel acessar a c√¢mera.', 'error');
            }
        }
        
        function fecharCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraContainer').classList.remove('active');
            document.getElementById('fotoOpcoes').style.display = 'flex';
        }
        
        function capturarFoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('fotoCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
            mostrarPreviewFoto(fotoBase64);
            fecharCamera();
        }
        
        function abrirGaleria() { document.getElementById('fotoInput').click(); }
        
        function processarFotoGaleria(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('fotoCanvas');
                    const max = 800;
                    let w = img.width, h = img.height;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } }
                    else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    mostrarPreviewFoto(fotoBase64);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function mostrarPreviewFoto(src) {
            const container = document.getElementById('fotoContainer');
            container.classList.add('has-photo');
            container.innerHTML = `<img class="foto-preview" src="${src}"><div style="position:absolute;bottom:10px;right:10px;background:rgba(0,0,0,0.7);border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer" onclick="removerFoto(event)">üîÑ</div>`;
        }
        
        function removerFoto(event) {
            event.stopPropagation();
            fotoBase64 = null;
            const container = document.getElementById('fotoContainer');
            container.classList.remove('has-photo');
            container.innerHTML = `<div class="foto-placeholder" onclick="abrirGaleria()"><span>üì∑</span><p>Toque para adicionar foto</p></div>`;
            document.getElementById('fotoInput').value = '';
        }

        function irParaDesejos() {
            const nome = document.getElementById('nome').value.trim();
            const sobrenome = document.getElementById('sobrenome').value.trim();
            if (!nome || !sobrenome) { mostrarToast('Preencha nome e sobrenome', 'error'); return; }
            mostrarTela('telaDesejos');
        }

        // ==========================================
        // DESEJOS
        // ==========================================
        function toggleTag(el) {
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                desejosSelecionados = desejosSelecionados.filter(d => d !== el.textContent);
            } else {
                if (desejosSelecionados.length >= 10) { mostrarToast('M√°ximo 10!', 'error'); return; }
                el.classList.add('selected');
                desejosSelecionados.push(el.textContent);
            }
            document.getElementById('contadorDesejos').textContent = desejosSelecionados.length;
        }

        function irParaPessoas() {
            if (desejosSelecionados.length === 0) { mostrarToast('Selecione pelo menos 1', 'error'); return; }
            mostrarTela('telaPessoas');
        }

        // ==========================================
        // PESSOAS
        // ==========================================
        function togglePessoa(el) {
            const pessoa = el.dataset.pessoa;
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                pessoasSelecionadas = pessoasSelecionadas.filter(p => p !== pessoa);
            } else {
                el.classList.add('selected');
                pessoasSelecionadas.push(pessoa);
            }
        }

        function irParaPerguntas() { mostrarTela('telaPerguntas'); }

        // ==========================================
        // PERGUNTAS
        // ==========================================
        function selecionarNota(n) {
            notaFelicidade = n;
            document.querySelectorAll('.escala-num').forEach((el, i) => el.classList.toggle('selected', i+1 === n));
        }

        function irParaAudio() { mostrarTela('telaAudio'); }

        // ==========================================
        // √ÅUDIO
        // ==========================================
        async function toggleGravacao() {
            const btn = document.getElementById('btnGravar');
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: true, noiseSuppression: true } });
                    let mimeType = 'audio/webm';
                    if (MediaRecorder.isTypeSupported('audio/mp4')) mimeType = 'audio/mp4';
                    mediaRecorder = new MediaRecorder(stream, { mimeType });
                    audioChunks = [];
                    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                    mediaRecorder.onstop = async () => {
                        duracaoFinal = Math.floor((Date.now() - tempoInicio) / 1000);
                        const audioBlob = new Blob(audioChunks, { type: mimeType });
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            audioBase64 = reader.result;
                            document.getElementById('audioPlayer').src = URL.createObjectURL(audioBlob);
                            document.getElementById('audioPreview').style.display = 'block';
                            document.getElementById('btnGravar').style.display = 'none';
                            document.getElementById('tempoGravacao').style.display = 'none';
                        };
                        reader.readAsDataURL(audioBlob);
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start(100);
                    btn.classList.add('gravando');
                    btn.innerHTML = '‚èπÔ∏è';
                    tempoInicio = Date.now();
                    timerInterval = setInterval(atualizarTempo, 100);
                    setTimeout(() => { if (mediaRecorder?.state === 'recording') pararGravacao(); }, 60000);
                } catch (err) { mostrarToast('Erro no microfone', 'error'); }
            } else { pararGravacao(); }
        }

        function pararGravacao() {
            if (mediaRecorder?.state === 'recording') {
                mediaRecorder.stop();
                clearInterval(timerInterval);
                document.getElementById('btnGravar').classList.remove('gravando');
            }
        }

        function atualizarTempo() {
            const elapsed = Math.floor((Date.now() - tempoInicio) / 1000);
            document.getElementById('tempoGravacao').textContent = `${Math.floor(elapsed/60).toString().padStart(2,'0')}:${(elapsed%60).toString().padStart(2,'0')}`;
        }

        function regravar() {
            audioBase64 = null; audioConfirmadoFlag = false; mediaRecorder = null;
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('audioConfirmado').style.display = 'none';
            document.getElementById('btnGravar').style.display = 'flex';
            document.getElementById('btnGravar').innerHTML = 'üé§';
            document.getElementById('tempoGravacao').style.display = 'block';
            document.getElementById('tempoGravacao').textContent = '00:00';
        }

        function confirmarAudio() {
            audioConfirmadoFlag = true;
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('audioConfirmado').style.display = 'flex';
            document.getElementById('duracaoAudio').textContent = `Dura√ß√£o: ${Math.floor(duracaoFinal/60).toString().padStart(2,'0')}:${(duracaoFinal%60).toString().padStart(2,'0')}`;
            mostrarToast('‚úì √Åudio confirmado!');
        }

        function pularAudio() { audioBase64 = null; audioConfirmadoFlag = false; irParaMensagem(); }

        function irParaMensagem() {
            document.getElementById('resumoDesejos').innerHTML = desejosSelecionados.map(d => `<span class="mini-tag">${d}</span>`).join('');
            document.getElementById('resumoPessoas').textContent = pessoasSelecionadas.length > 0 ? pessoasSelecionadas.join(', ') : '-';
            document.getElementById('resumoFelicidade').textContent = notaFelicidade || '-';
            document.getElementById('resumoAudio').textContent = audioConfirmadoFlag ? '‚úÖ Gravado' : '‚ùå N√£o';
            mostrarTela('telaMensagem');
        }

        function atualizarContador() {
            document.getElementById('charCounter').textContent = document.getElementById('mensagem').value.length;
        }

        // ==========================================
        // LACRAR C√ÅPSULA
        // ==========================================
        async function lacrarCapsula() {
            const nome = document.getElementById('nome').value.trim();
            const sobrenome = document.getElementById('sobrenome').value.trim();
            const mensagem = document.getElementById('mensagem').value.trim();
            const conquista = document.getElementById('perguntaConquista').value.trim();
            const momento = document.getElementById('perguntaMomento').value.trim();
            const palavra = document.getElementById('perguntaPalavra').value.trim();
            const previsao = document.getElementById('perguntaPrevisao').value.trim();

            document.getElementById('btnLacrar').disabled = true;
            document.getElementById('loading').classList.add('active');

            try {
                capsulaId = gerarID('cap');
                let fotoUrl = null, audioUrl = null;

                if (fotoBase64) {
                    const fotoRef = storage.ref(`capsulas/${capsulaId}/foto.jpg`);
                    const fotoBlob = await (await fetch(fotoBase64)).blob();
                    await fotoRef.put(fotoBlob, { contentType: 'image/jpeg' });
                    fotoUrl = await fotoRef.getDownloadURL();
                }

                if (audioBase64 && audioConfirmadoFlag) {
                    try {
                        const audioBlob = await (await fetch(audioBase64)).blob();
                        const audioRef = storage.ref(`capsulas/${capsulaId}/audio.webm`);
                        await audioRef.put(audioBlob);
                        audioUrl = await audioRef.getDownloadURL();
                    } catch (e) { console.log('Audio storage error:', e); }
                }

                await database.ref(`capsulas/${capsulaId}`).set({
                    eventoId, nome, sobrenome, foto: fotoUrl,
                    desejos: desejosSelecionados, pessoas: pessoasSelecionadas,
                    perguntas: { conquista, momento, palavra, previsao, felicidade: notaFelicidade },
                    audioUrl, audioBase64: audioConfirmadoFlag ? audioBase64 : null,
                    mensagemPessoal: mensagem,
                    dataCriacao: new Date().toISOString(),
                    dataAbertura: eventoData.dataAbertura,
                    liberada: false, aberta: false
                });

                const base = window.location.origin + window.location.pathname.replace('jogador.html', '');
                linkCapsula = `${base}capsula.html?id=${capsulaId}`;

                document.getElementById('loading').classList.remove('active');
                mostrarSucesso(fotoUrl || fotoBase64, nome);
                
            } catch (err) {
                console.error(err);
                document.getElementById('loading').classList.remove('active');
                mostrarToast('Erro ao salvar', 'error');
                document.getElementById('btnLacrar').disabled = false;
            }
        }

        function mostrarSucesso(fotoSrc, nome) {
            const foto = document.getElementById('sucessoFoto');
            if (fotoSrc) foto.innerHTML = `<img src="${fotoSrc}" style="width:100%;height:100%;object-fit:cover">`;
            document.getElementById('sucessoMsg').textContent = `${nome}, sua c√°psula est√° segura!`;
            document.getElementById('sucessoData').textContent = formatarData(eventoData.dataAbertura);
            const dias = Math.ceil((new Date(eventoData.dataAbertura) - new Date()) / (1000*60*60*24));
            document.getElementById('sucessoDias').textContent = `${dias} dias restantes`;
            mostrarTela('telaSucesso');
            criarConfetes();
        }

        // ==========================================
        // COMPARTILHAR - GERA√á√ÉO DE IMAGEM
        // ==========================================
        async function abrirCompartilhar() {
            const modal = document.getElementById('shareModal');
            modal.classList.add('active');
            
            // Reset
            document.getElementById('btnSalvarImg').disabled = true;
            document.getElementById('btnSalvarGif').disabled = true;
            document.getElementById('shareStatus').style.display = 'block';
            document.getElementById('progressBar').style.width = '0%';
            
            // Criar imagem
            await gerarImagemStories();
        }

        async function gerarImagemStories() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Tamanho Stories (9:16)
            const w = 1080;
            const h = 1920;
            canvas.width = w;
            canvas.height = h;
            
            // Dados
            const nome = document.getElementById('nome').value.trim();
            const dataAbertura = formatarData(eventoData?.dataAbertura);
            const dias = Math.max(0, Math.ceil((new Date(eventoData?.dataAbertura) - new Date()) / (1000*60*60*24)));
            const prioridades = desejosSelecionados.slice(0, 4);
            
            // Atualizar progresso
            const updateProgress = (p) => {
                document.getElementById('progressBar').style.width = p + '%';
            };
            
            updateProgress(10);
            
            // ========== BACKGROUND ==========
            const bgGrad = ctx.createLinearGradient(0, 0, w, h);
            bgGrad.addColorStop(0, '#0f0c29');
            bgGrad.addColorStop(0.5, '#302b63');
            bgGrad.addColorStop(1, '#24243e');
            ctx.fillStyle = bgGrad;
            ctx.fillRect(0, 0, w, h);
            
            // Overlay com textura
            ctx.fillStyle = 'rgba(255, 215, 0, 0.03)';
            for (let i = 0; i < w; i += 4) {
                for (let j = 0; j < h; j += 4) {
                    if (Math.random() > 0.5) ctx.fillRect(i, j, 2, 2);
                }
            }
            
            updateProgress(20);
            
            // ========== ESTRELAS ==========
            for (let i = 0; i < 150; i++) {
                const x = Math.random() * w;
                const y = Math.random() * h;
                const size = Math.random() * 3 + 1;
                const alpha = Math.random() * 0.8 + 0.2;
                
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.fill();
                
                // Brilho
                if (Math.random() > 0.7) {
                    ctx.fillStyle = `rgba(255, 215, 0, ${alpha * 0.5})`;
                    ctx.beginPath();
                    ctx.arc(x, y, size * 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            updateProgress(30);
            
            // ========== CONFETES ==========
            const cores = ['#ffd700', '#c41e3a', '#165b33', '#ff6b6b', '#4ecdc4', '#fff', '#ff69b4', '#00ffff'];
            for (let i = 0; i < 100; i++) {
                ctx.fillStyle = cores[Math.floor(Math.random() * cores.length)];
                ctx.save();
                ctx.translate(Math.random() * w, Math.random() * h);
                ctx.rotate(Math.random() * Math.PI * 2);
                
                if (Math.random() > 0.5) {
                    ctx.fillRect(-5, -10, 10, 20);
                } else {
                    ctx.beginPath();
                    ctx.arc(0, 0, 6 + Math.random() * 4, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.restore();
            }
            
            updateProgress(40);
            
            // ========== GLOW CENTRAL ==========
            const glowGrad = ctx.createRadialGradient(w/2, 500, 0, w/2, 500, 400);
            glowGrad.addColorStop(0, 'rgba(255, 215, 0, 0.3)');
            glowGrad.addColorStop(0.5, 'rgba(255, 215, 0, 0.1)');
            glowGrad.addColorStop(1, 'transparent');
            ctx.fillStyle = glowGrad;
            ctx.fillRect(0, 0, w, h);
            
            // ========== T√çTULO ==========
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Sombra do t√≠tulo
            ctx.shadowColor = '#ffd700';
            ctx.shadowBlur = 40;
            ctx.font = 'bold 80px Arial, sans-serif';
            ctx.fillStyle = '#ffd700';
            ctx.fillText('üéÅ C√ÅPSULA DO TEMPO üéÅ', w/2, 150);
            ctx.shadowBlur = 0;
            
            // Subt√≠tulo
            ctx.font = '40px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillText(eventoData?.nome || 'Natal 2024', w/2, 230);
            
            updateProgress(50);
            
            // ========== C√ÅPSULA 3D ==========
            const capX = w / 2;
            const capY = 520;
            
            // Glow da c√°psula
            const capsGlow = ctx.createRadialGradient(capX, capY, 0, capX, capY, 280);
            capsGlow.addColorStop(0, 'rgba(255, 215, 0, 0.5)');
            capsGlow.addColorStop(0.5, 'rgba(255, 215, 0, 0.2)');
            capsGlow.addColorStop(1, 'transparent');
            ctx.fillStyle = capsGlow;
            ctx.beginPath();
            ctx.arc(capX, capY, 280, 0, Math.PI * 2);
            ctx.fill();
            
            // Corpo da c√°psula - gradiente 3D
            const bodyGrad = ctx.createLinearGradient(capX - 150, capY - 200, capX + 150, capY + 200);
            bodyGrad.addColorStop(0, '#ffd700');
            bodyGrad.addColorStop(0.2, '#ffec80');
            bodyGrad.addColorStop(0.4, '#ffd700');
            bodyGrad.addColorStop(0.6, '#cc9900');
            bodyGrad.addColorStop(0.8, '#996600');
            bodyGrad.addColorStop(1, '#664400');
            
            ctx.fillStyle = bodyGrad;
            ctx.beginPath();
            ctx.ellipse(capX, capY, 150, 200, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Borda dourada
            ctx.strokeStyle = '#ffcc00';
            ctx.lineWidth = 6;
            ctx.stroke();
            
            // Reflexo de luz
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.beginPath();
            ctx.ellipse(capX - 60, capY - 100, 40, 70, -0.4, 0, Math.PI * 2);
            ctx.fill();
            
            // Tampa
            const tampaGrad = ctx.createLinearGradient(capX - 100, capY - 200, capX + 100, capY - 150);
            tampaGrad.addColorStop(0, '#ffcc00');
            tampaGrad.addColorStop(0.5, '#ffd700');
            tampaGrad.addColorStop(1, '#cc9900');
            ctx.fillStyle = tampaGrad;
            ctx.beginPath();
            ctx.ellipse(capX, capY - 180, 100, 40, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = '#996600';
            ctx.lineWidth = 3;
            ctx.stroke();
            
            // Cadeado
            ctx.font = '120px Arial';
            ctx.fillText('üîí', capX, capY + 20);
            
            updateProgress(60);
            
            // ========== FOTO ==========
            if (fotoBase64) {
                try {
                    const img = await loadImage(fotoBase64);
                    const fotoY = 900;
                    const fotoSize = 300;
                    
                    // Borda arco-√≠ris
                    const borderGrad = ctx.createLinearGradient(capX - 180, fotoY - 180, capX + 180, fotoY + 180);
                    borderGrad.addColorStop(0, '#ff0000');
                    borderGrad.addColorStop(0.17, '#ff8800');
                    borderGrad.addColorStop(0.33, '#ffff00');
                    borderGrad.addColorStop(0.5, '#00ff00');
                    borderGrad.addColorStop(0.67, '#0088ff');
                    borderGrad.addColorStop(0.83, '#8800ff');
                    borderGrad.addColorStop(1, '#ff0088');
                    
                    ctx.fillStyle = borderGrad;
                    ctx.beginPath();
                    ctx.arc(capX, fotoY, fotoSize/2 + 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Clip e foto
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(capX, fotoY, fotoSize/2, 0, Math.PI * 2);
                    ctx.clip();
                    
                    const ratio = img.width / img.height;
                    let dw, dh;
                    if (ratio > 1) {
                        dh = fotoSize;
                        dw = fotoSize * ratio;
                    } else {
                        dw = fotoSize;
                        dh = fotoSize / ratio;
                    }
                    ctx.drawImage(img, capX - dw/2, fotoY - dh/2, dw, dh);
                    ctx.restore();
                    
                } catch (e) {
                    console.log('Erro foto:', e);
                }
            }
            
            updateProgress(70);
            
            // ========== NOME ==========
            ctx.shadowColor = '#ffd700';
            ctx.shadowBlur = 30;
            ctx.font = 'bold 72px Arial, sans-serif';
            ctx.fillStyle = '#ffd700';
            ctx.fillText(nome, w/2, 1130);
            ctx.shadowBlur = 0;
            
            // Status
            ctx.font = 'bold 48px Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.fillText('‚ú® C√ÅPSULA LACRADA! ‚ú®', w/2, 1210);
            
            // Data
            ctx.font = '38px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillText(`üìÖ Abre em: ${dataAbertura}`, w/2, 1300);
            
            updateProgress(80);
            
            // ========== DIAS RESTANTES ==========
            // Box de destaque
            ctx.fillStyle = 'rgba(255, 215, 0, 0.15)';
            roundRect(ctx, w/2 - 200, 1350, 400, 120, 20);
            ctx.fill();
            ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
            ctx.lineWidth = 3;
            roundRect(ctx, w/2 - 200, 1350, 400, 120, 20);
            ctx.stroke();
            
            ctx.shadowColor = '#ff6b6b';
            ctx.shadowBlur = 30;
            ctx.font = 'bold 100px Arial, sans-serif';
            ctx.fillStyle = '#ffd700';
            ctx.fillText(`${dias}`, w/2 - 50, 1425);
            ctx.font = 'bold 50px Arial, sans-serif';
            ctx.fillText('DIAS', w/2 + 90, 1425);
            ctx.shadowBlur = 0;
            
            // ========== PRIORIDADES ==========
            if (prioridades.length > 0) {
                ctx.font = '30px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.fillText('Minhas prioridades:', w/2, 1530);
                
                ctx.font = 'bold 34px Arial, sans-serif';
                ctx.fillStyle = '#ffd700';
                ctx.fillText(prioridades.join(' ‚Ä¢ '), w/2, 1580);
            }
            
            // ========== FELICIDADE ==========
            if (notaFelicidade) {
                ctx.font = '32px Arial, sans-serif';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fillText(`Felicidade hoje: ${notaFelicidade}/10 ‚≠ê`, w/2, 1670);
            }
            
            updateProgress(90);
            
            // ========== RODAP√â ==========
            ctx.font = '28px Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.fillText('üéÑ C√°psula do Tempo üéÑ', w/2, h - 100);
            ctx.font = '22px Arial, sans-serif';
            ctx.fillText('Compartilhe nos Stories!', w/2, h - 60);
            
            // Salvar canvas
            imagemCanvas = canvas;
            
            // Converter para blob
            canvas.toBlob((blob) => {
                imagemBlob = blob;
                
                // Mostrar preview
                const preview = document.getElementById('sharePreview');
                preview.innerHTML = '';
                preview.appendChild(canvas);
                
                // Habilitar bot√µes
                document.getElementById('btnSalvarImg').disabled = false;
                document.getElementById('btnSalvarGif').disabled = false;
                document.getElementById('shareStatus').style.display = 'none';
                
                updateProgress(100);
                mostrarToast('‚ú® Imagem criada com sucesso!');
                
            }, 'image/png', 1.0);
        }
        
        // Fun√ß√£o auxiliar para ret√¢ngulo arredondado
        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }
        
        // Carregar imagem
        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        // ==========================================
        // SALVAR IMAGEM
        // ==========================================
        function salvarImagem() {
            if (!imagemBlob) {
                mostrarToast('Aguarde a imagem ser gerada', 'error');
                return;
            }
            
            const url = URL.createObjectURL(imagemBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `capsula-${nome}-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            mostrarToast('üì∏ Imagem salva! Compartilhe nos Stories!');
        }

        // ==========================================
        // CRIAR GIF ANIMADO
        // ==========================================
        async function criarGifAnimado() {
            if (!imagemCanvas) {
                mostrarToast('Aguarde a imagem ser gerada', 'error');
                return;
            }
            
            document.getElementById('btnSalvarGif').disabled = true;
            document.getElementById('btnSalvarGif').innerHTML = '<span class="icon">‚è≥</span>Criando GIF...';
            
            mostrarToast('üé¨ Criando GIF animado... Aguarde!');
            
            try {
                // Criar GIF com gif.js
                const gif = new GIF({
                    workers: 2,
                    quality: 10,
                    width: 540,
                    height: 960,
                    workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
                });
                
                const w = 540, h = 960;
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = w;
                tempCanvas.height = h;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Dados
                const nome = document.getElementById('nome').value.trim();
                const dataAbertura = formatarData(eventoData?.dataAbertura);
                const dias = Math.max(0, Math.ceil((new Date(eventoData?.dataAbertura) - new Date()) / (1000*60*60*24)));
                
                // Gerar 30 frames (3 segundos a 10fps)
                const totalFrames = 30;
                
                // Pr√©-carregar foto
                let fotoImg = null;
                if (fotoBase64) {
                    try {
                        fotoImg = await loadImage(fotoBase64);
                    } catch(e) {}
                }
                
                for (let frame = 0; frame < totalFrames; frame++) {
                    const progress = frame / totalFrames;
                    
                    // Limpar
                    const bgGrad = tempCtx.createLinearGradient(0, 0, w, h);
                    bgGrad.addColorStop(0, '#0f0c29');
                    bgGrad.addColorStop(0.5, '#302b63');
                    bgGrad.addColorStop(1, '#24243e');
                    tempCtx.fillStyle = bgGrad;
                    tempCtx.fillRect(0, 0, w, h);
                    
                    // Estrelas com twinkle
                    for (let i = 0; i < 80; i++) {
                        const x = (i * 7) % w;
                        const y = (i * 13) % h;
                        const size = 1 + Math.sin(frame * 0.3 + i) * 0.5;
                        const alpha = 0.5 + Math.sin(frame * 0.2 + i * 0.5) * 0.5;
                        tempCtx.fillStyle = `rgba(255,255,255,${alpha})`;
                        tempCtx.beginPath();
                        tempCtx.arc(x, y, size, 0, Math.PI * 2);
                        tempCtx.fill();
                    }
                    
                    // Confetes caindo
                    const cores = ['#ffd700', '#c41e3a', '#165b33', '#ff6b6b', '#4ecdc4', '#fff'];
                    for (let i = 0; i < 40; i++) {
                        const baseY = (i * 30 + frame * 15) % (h + 100) - 50;
                        const x = (i * 17 + Math.sin(frame * 0.1 + i) * 20) % w;
                        const rot = frame * 0.2 + i;
                        
                        tempCtx.save();
                        tempCtx.translate(x, baseY);
                        tempCtx.rotate(rot);
                        tempCtx.fillStyle = cores[i % cores.length];
                        tempCtx.fillRect(-4, -8, 8, 16);
                        tempCtx.restore();
                    }
                    
                    // Glow central pulsante
                    const glowSize = 150 + Math.sin(frame * 0.3) * 30;
                    const glowGrad = tempCtx.createRadialGradient(w/2, 250, 0, w/2, 250, glowSize);
                    glowGrad.addColorStop(0, 'rgba(255, 215, 0, 0.4)');
                    glowGrad.addColorStop(1, 'transparent');
                    tempCtx.fillStyle = glowGrad;
                    tempCtx.fillRect(0, 0, w, h);
                    
                    // T√≠tulo
                    tempCtx.textAlign = 'center';
                    tempCtx.font = 'bold 36px Arial';
                    tempCtx.fillStyle = '#ffd700';
                    tempCtx.shadowColor = '#ffd700';
                    tempCtx.shadowBlur = 15;
                    tempCtx.fillText('üéÅ C√ÅPSULA DO TEMPO üéÅ', w/2, 70);
                    tempCtx.shadowBlur = 0;
                    
                    // Subt√≠tulo
                    tempCtx.font = '18px Arial';
                    tempCtx.fillStyle = 'rgba(255,255,255,0.9)';
                    tempCtx.fillText(eventoData?.nome || 'Natal 2024', w/2, 105);
                    
                    // C√°psula animada
                    const capY = 260 + Math.sin(frame * 0.2) * 8;
                    const capScale = 1 + Math.sin(frame * 0.15) * 0.05;
                    const shake = frame < 10 ? Math.sin(frame * 0.8) * 3 : 0;
                    
                    tempCtx.save();
                    tempCtx.translate(w/2 + shake, capY);
                    tempCtx.scale(capScale, capScale);
                    
                    // Glow
                    const capsGlow = tempCtx.createRadialGradient(0, 0, 0, 0, 0, 130);
                    capsGlow.addColorStop(0, 'rgba(255, 215, 0, 0.4)');
                    capsGlow.addColorStop(1, 'transparent');
                    tempCtx.fillStyle = capsGlow;
                    tempCtx.beginPath();
                    tempCtx.arc(0, 0, 130, 0, Math.PI * 2);
                    tempCtx.fill();
                    
                    // Corpo
                    const bodyGrad = tempCtx.createLinearGradient(-75, -100, 75, 100);
                    bodyGrad.addColorStop(0, '#ffd700');
                    bodyGrad.addColorStop(0.3, '#ffec80');
                    bodyGrad.addColorStop(0.7, '#cc9900');
                    bodyGrad.addColorStop(1, '#996600');
                    tempCtx.fillStyle = bodyGrad;
                    tempCtx.beginPath();
                    tempCtx.ellipse(0, 0, 75, 100, 0, 0, Math.PI * 2);
                    tempCtx.fill();
                    
                    // Reflexo
                    tempCtx.fillStyle = 'rgba(255,255,255,0.4)';
                    tempCtx.beginPath();
                    tempCtx.ellipse(-30, -50, 20, 35, -0.3, 0, Math.PI * 2);
                    tempCtx.fill();
                    
                    // Tampa
                    tempCtx.fillStyle = '#ffcc00';
                    tempCtx.beginPath();
                    tempCtx.ellipse(0, -90, 50, 20, 0, 0, Math.PI * 2);
                    tempCtx.fill();
                    
                    // Cadeado (aparece gradualmente)
                    if (frame > 5) {
                        const lockAlpha = Math.min(1, (frame - 5) / 10);
                        tempCtx.globalAlpha = lockAlpha;
                        tempCtx.font = '50px Arial';
                        tempCtx.fillText('üîí', 0, 15);
                        tempCtx.globalAlpha = 1;
                    }
                    
                    tempCtx.restore();
                    
                    // Foto (aparece depois)
                    if (frame > 8 && fotoImg) {
                        const fotoAlpha = Math.min(1, (frame - 8) / 8);
                        const fotoY = 460;
                        const fotoSize = 140;
                        
                        tempCtx.globalAlpha = fotoAlpha;
                        
                        // Borda
                        const borderGrad = tempCtx.createLinearGradient(w/2 - 80, fotoY - 80, w/2 + 80, fotoY + 80);
                        borderGrad.addColorStop(0, '#ffd700');
                        borderGrad.addColorStop(0.5, '#ff6b6b');
                        borderGrad.addColorStop(1, '#ffd700');
                        tempCtx.fillStyle = borderGrad;
                        tempCtx.beginPath();
                        tempCtx.arc(w/2, fotoY, fotoSize/2 + 8, 0, Math.PI * 2);
                        tempCtx.fill();
                        
                        tempCtx.save();
                        tempCtx.beginPath();
                        tempCtx.arc(w/2, fotoY, fotoSize/2, 0, Math.PI * 2);
                        tempCtx.clip();
                        const ratio = fotoImg.width / fotoImg.height;
                        let dw = fotoSize, dh = fotoSize;
                        if (ratio > 1) dw = fotoSize * ratio;
                        else dh = fotoSize / ratio;
                        tempCtx.drawImage(fotoImg, w/2 - dw/2, fotoY - dh/2, dw, dh);
                        tempCtx.restore();
                        
                        tempCtx.globalAlpha = 1;
                    }
                    
                    // Nome (typewriter)
                    if (frame > 12) {
                        const chars = Math.min(nome.length, Math.floor((frame - 12) / 1.5));
                        tempCtx.font = 'bold 32px Arial';
                        tempCtx.fillStyle = '#ffd700';
                        tempCtx.shadowColor = '#ffd700';
                        tempCtx.shadowBlur = 10;
                        tempCtx.fillText(nome.substring(0, chars), w/2, 570);
                        tempCtx.shadowBlur = 0;
                    }
                    
                    // Status
                    if (frame > 16) {
                        tempCtx.font = 'bold 22px Arial';
                        tempCtx.fillStyle = '#fff';
                        tempCtx.fillText('‚ú® C√ÅPSULA LACRADA! ‚ú®', w/2, 615);
                    }
                    
                    // Data
                    if (frame > 18) {
                        tempCtx.font = '18px Arial';
                        tempCtx.fillStyle = 'rgba(255,255,255,0.9)';
                        tempCtx.fillText(`üìÖ Abre em: ${dataAbertura}`, w/2, 660);
                    }
                    
                    // Dias (pulsante)
                    if (frame > 20) {
                        const diasScale = 1 + Math.sin(frame * 0.3) * 0.1;
                        tempCtx.save();
                        tempCtx.translate(w/2, 720);
                        tempCtx.scale(diasScale, diasScale);
                        tempCtx.font = 'bold 50px Arial';
                        tempCtx.fillStyle = '#ffd700';
                        tempCtx.shadowColor = '#ff6b6b';
                        tempCtx.shadowBlur = 20;
                        tempCtx.fillText(`${dias} DIAS`, 0, 0);
                        tempCtx.shadowBlur = 0;
                        tempCtx.restore();
                    }
                    
                    // Prioridades
                    if (frame > 24 && desejosSelecionados.length > 0) {
                        tempCtx.font = '14px Arial';
                        tempCtx.fillStyle = 'rgba(255,255,255,0.7)';
                        tempCtx.fillText('Prioridades: ' + desejosSelecionados.slice(0,3).join(' ‚Ä¢ '), w/2, 800);
                    }
                    
                    // Rodap√©
                    tempCtx.font = '14px Arial';
                    tempCtx.fillStyle = 'rgba(255,255,255,0.5)';
                    tempCtx.fillText('üéÑ C√°psula do Tempo üéÑ', w/2, h - 40);
                    
                    // Adicionar frame ao GIF
                    gif.addFrame(tempCtx, { copy: true, delay: 100 });
                }
                
                // Renderizar GIF
                gif.on('finished', function(blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `capsula-animada-${Date.now()}.gif`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    document.getElementById('btnSalvarGif').disabled = false;
                    document.getElementById('btnSalvarGif').innerHTML = '<span class="icon">üé¨</span>Criar GIF Animado';
                    mostrarToast('üé¨ GIF animado salvo! Perfeito para Stories!');
                });
                
                gif.render();
                
            } catch (err) {
                console.error('Erro ao criar GIF:', err);
                document.getElementById('btnSalvarGif').disabled = false;
                document.getElementById('btnSalvarGif').innerHTML = '<span class="icon">üé¨</span>Criar GIF Animado';
                mostrarToast('Erro ao criar GIF. Tente novamente.', 'error');
            }
        }

        // ==========================================
        // OUTRAS FUN√á√ïES
        // ==========================================
        function copiarLink() {
            if (!linkCapsula) {
                mostrarToast('Link n√£o dispon√≠vel', 'error');
                return;
            }
            navigator.clipboard.writeText(linkCapsula).then(() => {
                mostrarToast('üîó Link copiado!');
            }).catch(() => {
                const i = document.createElement('textarea');
                i.value = linkCapsula;
                document.body.appendChild(i);
                i.select();
                document.execCommand('copy');
                document.body.removeChild(i);
                mostrarToast('üîó Link copiado!');
            });
        }
        
        function fecharCompartilhar() {
            document.getElementById('shareModal').classList.remove('active');
        }

        function verCapsula() {
            if (linkCapsula) window.location.href = linkCapsula;
        }
    </script>
</body>
</html>
