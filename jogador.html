<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üéÅ Criar C√°psula do Tempo</title>
    
    <!-- Fontes Profissionais -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&family=Sora:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --accent: #fbbf24;
            --dark: #0f0f0f;
            --light: #fafafa;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--dark);
            min-height: 100vh;
            color: var(--light);
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a2e 50%, #16213e 100%);
        }
        
        .bg-animation::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 70% 70%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            animation: bgMove 20s ease-in-out infinite;
        }
        
        @keyframes bgMove {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-5%, -5%) rotate(5deg); }
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .tela {
            display: none;
            flex-direction: column;
            min-height: calc(100vh - 40px);
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .tela.active { display: flex; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Progress Bar Moderna */
        .progress-bar {
            display: flex;
            gap: 4px;
            margin-bottom: 32px;
        }
        
        .progress-step {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: rgba(255,255,255,0.1);
            overflow: hidden;
            position: relative;
        }
        
        .progress-step::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .progress-step.active::after,
        .progress-step.done::after { width: 100%; }

        /* Tela Boas Vindas */
        .tela-boas {
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
        }
        
        .logo-container {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            margin-bottom: 32px;
            animation: float 3s ease-in-out infinite;
            box-shadow: 0 20px 60px rgba(99, 102, 241, 0.4);
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        
        .titulo-principal {
            font-family: 'Sora', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.7) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }
        
        .subtitulo {
            color: rgba(255,255,255,0.6);
            font-size: 1rem;
            font-weight: 400;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .data-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            padding: 12px 24px;
            border-radius: 100px;
            margin: 24px 0 40px;
            font-weight: 500;
            color: var(--accent);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 18px 48px;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 50px rgba(99, 102, 241, 0.5);
        }

        /* Headers */
        .header-tela {
            margin-bottom: 32px;
        }
        
        .passo-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .header-tela h2 {
            font-family: 'Sora', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }
        
        .header-tela p {
            color: rgba(255,255,255,0.6);
            font-size: 0.95rem;
        }

        /* Foto Section */
        .foto-section { text-align: center; margin-bottom: 32px; }
        
        .foto-container {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            margin: 0 auto 24px;
            position: relative;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 4px;
        }
        
        .foto-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .foto-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
        }
        
        .foto-placeholder svg {
            width: 48px;
            height: 48px;
            stroke: currentColor;
        }
        
        .foto-preview { width: 100%; height: 100%; object-fit: cover; }
        
        .foto-opcoes { display: flex; gap: 12px; justify-content: center; }
        
        .btn-secondary {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.15);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-secondary:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.25);
        }
        
        .camera-container {
            display: none;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
        }
        
        .camera-container.active { display: flex; }
        
        .camera-video {
            width: 100%;
            max-width: 280px;
            border-radius: 16px;
            transform: scaleX(-1);
        }
        
        .camera-actions { display: flex; gap: 16px; margin-top: 20px; }
        
        .btn-capture {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: 4px solid white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn-capture:hover { transform: scale(1.1); }
        
        .foto-input { display: none; }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(255,255,255,0.3);
        }
        
        .form-group textarea {
            resize: none;
            min-height: 120px;
            line-height: 1.6;
        }
        
        .char-counter {
            text-align: right;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.4);
            margin-top: 8px;
        }

        /* Buttons */
        .btn-continuar {
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 18px;
            border-radius: 14px;
            font-size: 1.05rem;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            margin-top: 24px;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .btn-continuar:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
        }
        
        .btn-continuar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-voltar {
            width: 100%;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.7);
            padding: 14px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 500;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s;
        }
        
        .btn-voltar:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        /* Tags */
        .tags-section { margin-bottom: 24px; }
        
        .tags-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.7);
        }
        
        .contador-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 8px 16px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 20px;
            display: inline-block;
        }
        
        .tags-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tag {
            padding: 10px 18px;
            border-radius: 100px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            font-family: 'Outfit', sans-serif;
        }
        
        .tag:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }
        
        .tag.selected {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            color: white;
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(99, 102, 241, 0.4);
        }

        /* Pessoas Grid */
        .pessoas-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .pessoa-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .pessoa-card:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.15);
        }
        
        .pessoa-card.selected {
            background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(236,72,153,0.2));
            border-color: var(--primary);
            transform: scale(1.02);
        }
        
        .pessoa-card .emoji { font-size: 2rem; margin-bottom: 8px; }
        .pessoa-card .nome { font-weight: 500; font-size: 0.9rem; }

        /* Perguntas */
        .pergunta-box {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .pergunta-box label {
            display: block;
            margin-bottom: 12px;
            font-weight: 500;
            color: rgba(255,255,255,0.9);
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .pergunta-box input,
        .pergunta-box textarea {
            background: rgba(0,0,0,0.2);
            border-color: rgba(255,255,255,0.08);
        }
        
        .escala-felicidade {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .escala-num {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .escala-num:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .escala-num.selected {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            transform: scale(1.15);
        }

        /* Audio Section */
        .audio-section {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
        }
        
        .audio-icon { font-size: 3rem; margin-bottom: 16px; }
        
        .audio-title {
            font-family: 'Sora', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .audio-desc {
            color: rgba(255,255,255,0.6);
            font-size: 0.9rem;
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        .tempo-display {
            font-family: 'Space Grotesk', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 20px;
        }
        
        .btn-gravar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4);
        }
        
        .btn-gravar:hover { transform: scale(1.1); }
        
        .btn-gravar.gravando {
            animation: pulse-record 1s ease-in-out infinite;
        }
        
        @keyframes pulse-record {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
        }
        
        .audio-preview {
            margin-top: 24px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 16px;
        }
        
        .audio-preview audio { width: 100%; margin-bottom: 16px; }
        
        .audio-actions { display: flex; gap: 12px; }
        .audio-actions button { flex: 1; }
        
        .audio-confirmado {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 16px;
            margin-top: 20px;
        }
        
        .audio-confirmado .check { font-size: 2rem; }
        .audio-confirmado .info { flex: 1; text-align: left; }
        .audio-confirmado .info strong { display: block; margin-bottom: 4px; }
        .audio-confirmado .duracao { color: var(--primary); font-size: 0.9rem; }
        
        .btn-pular {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 20px;
            text-decoration: underline;
        }

        /* Resumo */
        .resumo-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .resumo-card h4 {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .resumo-item {
            font-size: 0.95rem;
            margin-bottom: 8px;
            color: rgba(255,255,255,0.8);
        }
        
        .mini-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        
        .mini-tag {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Bot√£o Lacrar */
        .btn-lacrar {
            width: 100%;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 16px;
            font-size: 1.15rem;
            font-weight: 700;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            margin-top: 24px;
            transition: all 0.3s;
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.4);
        }
        
        .btn-lacrar:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 50px rgba(239, 68, 68, 0.5);
        }
        
        .btn-lacrar:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 80px;
            height: 80px;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            animation: bounce-loading 1s ease-in-out infinite;
        }
        
        @keyframes bounce-loading {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(10deg); }
        }
        
        .loading-text {
            margin-top: 24px;
            font-size: 1.1rem;
            color: rgba(255,255,255,0.7);
        }

        /* Tela Sucesso */
        .tela-sucesso {
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
        }
        
        .sucesso-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 4px;
            margin-bottom: 24px;
            animation: success-pop 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        @keyframes success-pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        .sucesso-avatar-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            overflow: hidden;
        }
        
        .sucesso-avatar-inner img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .sucesso-titulo {
            font-family: 'Sora', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 12px;
        }
        
        .sucesso-msg {
            color: rgba(255,255,255,0.6);
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        .sucesso-info {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 32px;
            width: 100%;
        }
        
        .sucesso-data {
            font-weight: 600;
            color: var(--accent);
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .sucesso-dias {
            color: rgba(255,255,255,0.5);
            font-size: 0.9rem;
        }
        
        .sucesso-btns {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }
        
        .btn-share {
            background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);
            color: white;
            border: none;
            padding: 18px;
            border-radius: 14px;
            font-size: 1.05rem;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-share:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(131, 58, 180, 0.4);
        }

        /* Modal Share - Estilo Spotify */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
        }
        
        .share-modal.active { display: flex; }
        
        .share-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .share-header h3 {
            font-family: 'Sora', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .btn-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-close:hover { background: rgba(255,255,255,0.2); }
        
        .share-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        .share-preview-container {
            width: 100%;
            max-width: 300px;
            aspect-ratio: 9/16;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            margin-bottom: 24px;
            background: #111;
        }
        
        .share-preview-container canvas,
        .share-preview-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .share-status {
            text-align: center;
            padding: 20px;
        }
        
        .share-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .share-progress {
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin: 16px auto 0;
            overflow: hidden;
        }
        
        .share-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s;
        }
        
        .share-actions {
            padding: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .share-btn {
            padding: 16px;
            border-radius: 14px;
            border: none;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        
        .share-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .share-btn .icon { font-size: 1.5rem; }
        
        .share-btn.primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .share-btn.secondary {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .share-btn.full {
            grid-column: span 2;
        }

        /* Tela Erro */
        .tela-erro {
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }
        
        .erro-icon { font-size: 4rem; margin-bottom: 20px; }

        /* Confetes */
        .confetes-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1500;
            overflow: hidden;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(255,255,255,0.95);
            color: #111;
            padding: 14px 24px;
            border-radius: 100px;
            font-weight: 600;
            font-size: 0.95rem;
            z-index: 3000;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            background: #ef4444;
            color: white;
        }

        @media (max-width: 400px) {
            .container { padding: 16px; }
            .titulo-principal { font-size: 1.75rem; }
            .header-tela h2 { font-size: 1.5rem; }
            .pessoas-grid { gap: 8px; }
            .pessoa-card { padding: 16px; }
            .share-actions { grid-template-columns: 1fr; }
            .share-btn.full { grid-column: span 1; }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>
    <div class="confetes-container" id="confetes"></div>

    <div class="container">
        <!-- TELA BOAS VINDAS -->
        <div class="tela tela-boas active" id="telaBoas">
            <div class="logo-container">üéÅ</div>
            <h1 class="titulo-principal" id="nomeEvento">C√°psula do Tempo</h1>
            <p class="subtitulo">Guarde suas mem√≥rias e sonhos</p>
            <p class="subtitulo">para o seu eu do futuro ‚ú®</p>
            <div class="data-badge">
                <span>üìÖ</span>
                <span>Abertura: <strong id="dataEvento">--/--/----</strong></span>
            </div>
            <button class="btn-primary" onclick="iniciar()">Come√ßar</button>
        </div>

        <!-- PASSO 1: FOTO E NOME -->
        <div class="tela" id="telaCadastro">
            <div class="progress-bar">
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            
            <div class="header-tela">
                <p class="passo-label">Passo 1 de 6</p>
                <h2>Quem √© voc√™?</h2>
                <p>Adicione uma foto para se reconhecer no futuro</p>
            </div>
            
            <div class="foto-section">
                <div class="foto-container">
                    <div class="foto-inner" id="fotoContainer">
                        <div class="foto-placeholder" onclick="abrirGaleria()">
                            <svg viewBox="0 0 24 24" fill="none" stroke-width="1.5">
                                <path d="M6.827 6.175A2.31 2.31 0 015.186 7.23c-.38.054-.802.024-1.644-.036l-.377-.027c-.502-.037-.903-.066-1.233-.11a2.75 2.75 0 00-.638-.034c-.36.033-.702.17-.976.39-.29.23-.465.526-.59.882-.127.365-.21.813-.31 1.366l-.1.573c-.134.765-.26 1.487-.334 2.12-.073.63-.104 1.21-.034 1.716.076.543.272 1.04.64 1.45.353.393.796.642 1.272.818.463.17.992.273 1.567.359l.557.077c.737.098 1.435.196 2.092.358.66.163 1.248.385 1.77.725.536.35 1.017.815 1.426 1.402l.43.618c.395.568.685.985.981 1.32.291.329.56.543.82.655.277.12.566.166.878.14.327-.03.683-.14 1.109-.332.432-.196.91-.47 1.453-.797l.504-.305c.62-.375 1.215-.735 1.88-.996.67-.264 1.384-.413 2.13-.384a2.3 2.3 0 011.036.276c.345.18.646.42.907.69.254.26.487.567.706.897l.228.344c.276.416.492.746.71 1.02.224.28.418.461.597.57.19.115.378.166.607.158a1.72 1.72 0 00.553-.13c.19-.074.403-.182.659-.326l.512-.29"/>
                                <circle cx="15" cy="9" r="2"/>
                            </svg>
                            <span style="font-size:0.85rem">Adicionar foto</span>
                        </div>
                    </div>
                </div>
                
                <div class="foto-opcoes" id="fotoOpcoes">
                    <button class="btn-secondary" onclick="abrirCamera()">
                        üì∏ Selfie
                    </button>
                    <button class="btn-secondary" onclick="abrirGaleria()">
                        üñºÔ∏è Galeria
                    </button>
                </div>
                
                <div class="camera-container" id="cameraContainer">
                    <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
                    <div class="camera-actions">
                        <button class="btn-secondary" onclick="fecharCamera()">Cancelar</button>
                        <button class="btn-capture" onclick="capturarFoto()"></button>
                    </div>
                </div>
                
                <input type="file" id="fotoInput" class="foto-input" accept="image/*" onchange="processarFoto(event)">
                <canvas id="fotoCanvas" style="display:none"></canvas>
            </div>
            
            <div class="form-group">
                <label>Seu nome</label>
                <input type="text" id="nome" placeholder="Como voc√™ se chama?" maxlength="30">
            </div>
            
            <div class="form-group">
                <label>Sobrenome</label>
                <input type="text" id="sobrenome" placeholder="Seu sobrenome" maxlength="30">
            </div>
            
            <button class="btn-continuar" onclick="irPasso2()">Continuar</button>
        </div>

        <!-- PASSO 2: PRIORIDADES -->
        <div class="tela" id="telaDesejos">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            
            <div class="header-tela">
                <p class="passo-label">Passo 2 de 6</p>
                <h2>Suas prioridades</h2>
                <p>O que √© mais importante para voc√™?</p>
            </div>
            
            <div class="contador-badge">Selecionados: <span id="contadorDesejos">0</span>/10</div>
            
            <div class="tags-section">
                <div class="tags-header">‚ù§Ô∏è Vida Pessoal</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Sa√∫de</span>
                    <span class="tag" onclick="toggleTag(this)">Fam√≠lia</span>
                    <span class="tag" onclick="toggleTag(this)">Romance</span>
                    <span class="tag" onclick="toggleTag(this)">Amizades</span>
                    <span class="tag" onclick="toggleTag(this)">Paz interior</span>
                    <span class="tag" onclick="toggleTag(this)">Felicidade</span>
                </div>
            </div>
            
            <div class="tags-section">
                <div class="tags-header">üéØ Conquistas</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Viajar</span>
                    <span class="tag" onclick="toggleTag(this)">Carreira</span>
                    <span class="tag" onclick="toggleTag(this)">Estudos</span>
                    <span class="tag" onclick="toggleTag(this)">Promo√ß√£o</span>
                    <span class="tag" onclick="toggleTag(this)">Neg√≥cio pr√≥prio</span>
                    <span class="tag" onclick="toggleTag(this)">Casa pr√≥pria</span>
                </div>
            </div>
            
            <div class="tags-section">
                <div class="tags-header">üí∞ Financeiro</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Economizar</span>
                    <span class="tag" onclick="toggleTag(this)">Investir</span>
                    <span class="tag" onclick="toggleTag(this)">Quitar d√≠vidas</span>
                    <span class="tag" onclick="toggleTag(this)">Renda extra</span>
                </div>
            </div>
            
            <div class="tags-section">
                <div class="tags-header">üåà Bem-estar</div>
                <div class="tags-grid">
                    <span class="tag" onclick="toggleTag(this)">Exerc√≠cios</span>
                    <span class="tag" onclick="toggleTag(this)">Medita√ß√£o</span>
                    <span class="tag" onclick="toggleTag(this)">Hobby novo</span>
                    <span class="tag" onclick="toggleTag(this)">Ler mais</span>
                    <span class="tag" onclick="toggleTag(this)">Dormir melhor</span>
                </div>
            </div>
            
            <button class="btn-continuar" onclick="irPasso3()">Continuar</button>
            <button class="btn-voltar" onclick="mostrarTela('telaCadastro')">Voltar</button>
        </div>

        <!-- PASSO 3: PESSOAS -->
        <div class="tela" id="telaPessoas">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            
            <div class="header-tela">
                <p class="passo-label">Passo 3 de 6</p>
                <h2>Pessoas importantes</h2>
                <p>Quem voc√™ quer se dedicar mais?</p>
            </div>
            
            <div class="pessoas-grid">
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Fam√≠lia">
                    <div class="emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
                    <div class="nome">Fam√≠lia</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Amigos">
                    <div class="emoji">üëØ</div>
                    <div class="nome">Amigos</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Parceiro(a)">
                    <div class="emoji">üíë</div>
                    <div class="nome">Parceiro(a)</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Filhos">
                    <div class="emoji">üë∂</div>
                    <div class="nome">Filhos</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Colegas">
                    <div class="emoji">üíº</div>
                    <div class="nome">Colegas</div>
                </div>
                <div class="pessoa-card" onclick="togglePessoa(this)" data-pessoa="Eu mesmo">
                    <div class="emoji">ü™û</div>
                    <div class="nome">Eu mesmo</div>
                </div>
            </div>
            
            <button class="btn-continuar" onclick="irPasso4()">Continuar</button>
            <button class="btn-voltar" onclick="mostrarTela('telaDesejos')">Voltar</button>
        </div>

        <!-- PASSO 4: PERGUNTAS -->
        <div class="tela" id="telaPerguntas">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
                <div class="progress-step"></div>
            </div>
            
            <div class="header-tela">
                <p class="passo-label">Passo 4 de 6</p>
                <h2>Reflex√µes</h2>
                <p>Responda para seu eu do futuro</p>
            </div>
            
            <div class="pergunta-box">
                <label>üéØ O que voc√™ quer conquistar?</label>
                <input type="text" id="perguntaConquista" placeholder="Ex: Aprender um idioma, viajar...">
            </div>
            
            <div class="pergunta-box">
                <label>‚ú® Momento mais marcante do ano?</label>
                <textarea id="perguntaMomento" placeholder="O que te marcou esse ano?" rows="3"></textarea>
            </div>
            
            <div class="pergunta-box">
                <label>üìù Uma palavra que define voc√™ agora:</label>
                <input type="text" id="perguntaPalavra" placeholder="Esperan√ßa, Gratid√£o, For√ßa..." maxlength="25">
            </div>
            
            <div class="pergunta-box">
                <label>üòä Felicidade hoje (1-10)</label>
                <div class="escala-felicidade">
                    <div class="escala-num" onclick="selecionarNota(1)">1</div>
                    <div class="escala-num" onclick="selecionarNota(2)">2</div>
                    <div class="escala-num" onclick="selecionarNota(3)">3</div>
                    <div class="escala-num" onclick="selecionarNota(4)">4</div>
                    <div class="escala-num" onclick="selecionarNota(5)">5</div>
                    <div class="escala-num" onclick="selecionarNota(6)">6</div>
                    <div class="escala-num" onclick="selecionarNota(7)">7</div>
                    <div class="escala-num" onclick="selecionarNota(8)">8</div>
                    <div class="escala-num" onclick="selecionarNota(9)">9</div>
                    <div class="escala-num" onclick="selecionarNota(10)">10</div>
                </div>
            </div>
            
            <button class="btn-continuar" onclick="irPasso5()">Continuar</button>
            <button class="btn-voltar" onclick="mostrarTela('telaPessoas')">Voltar</button>
        </div>

        <!-- PASSO 5: √ÅUDIO -->
        <div class="tela" id="telaAudio">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
                <div class="progress-step"></div>
            </div>
            
            <div class="header-tela">
                <p class="passo-label">Passo 5 de 6</p>
                <h2>Mensagem de voz</h2>
                <p>Grave um recado para seu eu do futuro</p>
            </div>
            
            <div class="audio-section">
                <div class="audio-icon">üéôÔ∏è</div>
                <div class="audio-title">Fale para voc√™ mesmo</div>
                <div class="audio-desc">Conte seus sonhos, medos e esperan√ßas</div>
                
                <div class="tempo-display" id="tempoGravacao">00:00</div>
                <button class="btn-gravar" id="btnGravar" onclick="toggleGravacao()">üé§</button>
                <p style="color:rgba(255,255,255,0.4);font-size:0.85rem;margin-top:12px">M√°ximo: 60 segundos</p>
                
                <div class="audio-preview" id="audioPreview" style="display:none">
                    <audio id="audioPlayer" controls></audio>
                    <div class="audio-actions">
                        <button class="btn-secondary" onclick="regravar()">üîÑ Regravar</button>
                        <button class="btn-continuar" style="margin:0" onclick="confirmarAudio()">‚úì Usar</button>
                    </div>
                </div>
                
                <div class="audio-confirmado" id="audioConfirmado" style="display:none">
                    <span class="check">‚úÖ</span>
                    <div class="info">
                        <strong>√Åudio gravado!</strong>
                        <div class="duracao" id="duracaoAudio">00:00</div>
                    </div>
                    <button class="btn-secondary" style="padding:10px" onclick="regravar()">üîÑ</button>
                </div>
            </div>
            
            <button class="btn-continuar" onclick="irPasso6()">Continuar</button>
            <button class="btn-pular" onclick="pularAudio()">Pular esta etapa</button>
            <button class="btn-voltar" onclick="mostrarTela('telaPerguntas')">Voltar</button>
        </div>

        <!-- PASSO 6: MENSAGEM -->
        <div class="tela" id="telaMensagem">
            <div class="progress-bar">
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step done"></div>
                <div class="progress-step active"></div>
            </div>
            
            <div class="header-tela">
                <p class="passo-label">Passo 6 de 6</p>
                <h2>Carta para o futuro</h2>
                <p>Escreva uma mensagem especial</p>
            </div>
            
            <div class="resumo-card">
                <h4>üìã Resumo</h4>
                <div class="resumo-item"><strong>Prioridades:</strong></div>
                <div class="mini-tags" id="resumoDesejos"></div>
                <div class="resumo-item" style="margin-top:12px"><strong>Dedica√ß√£o:</strong> <span id="resumoPessoas">-</span></div>
                <div class="resumo-item"><strong>Felicidade:</strong> <span id="resumoFelicidade">-</span>/10</div>
            </div>
            
            <div class="form-group">
                <label>‚úçÔ∏è Sua mensagem</label>
                <textarea id="mensagem" placeholder="Querido eu do futuro...

O que voc√™ est√° sentindo agora?
Quais s√£o seus sonhos?
Do que voc√™ tem medo?

Escreva tudo..." maxlength="5000" rows="8" oninput="atualizarContador()"></textarea>
                <div class="char-counter"><span id="charCounter">0</span>/5000</div>
            </div>
            
            <button class="btn-lacrar" id="btnLacrar" onclick="lacrarCapsula()">üîí Lacrar C√°psula</button>
            <button class="btn-voltar" onclick="mostrarTela('telaAudio')">Voltar</button>
        </div>

        <!-- TELA SUCESSO -->
        <div class="tela tela-sucesso" id="telaSucesso">
            <div class="sucesso-avatar">
                <div class="sucesso-avatar-inner" id="sucessoFoto">üéâ</div>
            </div>
            <h2 class="sucesso-titulo">C√°psula Lacrada!</h2>
            <p class="sucesso-msg" id="sucessoMsg">Sua c√°psula est√° segura</p>
            
            <div class="sucesso-info">
                <div class="sucesso-data">üìÖ <span id="sucessoData">--/--/----</span></div>
                <div class="sucesso-dias" id="sucessoDias">-- dias restantes</div>
            </div>
            
            <div class="sucesso-btns">
                <button class="btn-share" onclick="abrirShare()">
                    <span>‚ú®</span> Criar Stories
                </button>
                <button class="btn-secondary" style="justify-content:center" onclick="verCapsula()">
                    üëÅÔ∏è Ver C√°psula
                </button>
            </div>
        </div>

        <!-- TELA ERRO -->
        <div class="tela tela-erro" id="telaErro">
            <div class="erro-icon">üòï</div>
            <h2 style="margin-bottom:12px">Ops!</h2>
            <p style="color:rgba(255,255,255,0.6)">Evento n√£o encontrado</p>
        </div>
    </div>

    <!-- MODAL SHARE -->
    <div class="share-modal" id="shareModal">
        <div class="share-header">
            <h3>Criar Stories</h3>
            <button class="btn-close" onclick="fecharShare()">‚úï</button>
        </div>
        
        <div class="share-content">
            <div class="share-preview-container" id="sharePreview">
                <div class="share-status" id="shareStatus">
                    <div class="share-spinner"></div>
                    <p style="color:rgba(255,255,255,0.7)">Criando anima√ß√£o...</p>
                    <div class="share-progress">
                        <div class="share-progress-bar" id="progressBar"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="share-actions">
            <button class="share-btn primary" id="btnSalvarVideo" onclick="salvarVideo()" disabled>
                <span class="icon">üé¨</span>
                Salvar V√≠deo
            </button>
            <button class="share-btn secondary" id="btnSalvarImg" onclick="salvarImagem()" disabled>
                <span class="icon">üì∏</span>
                Salvar Imagem
            </button>
            <button class="share-btn secondary full" onclick="copiarLink()">
                <span class="icon">üîó</span>
                Copiar Link
            </button>
        </div>
    </div>

    <!-- LOADING -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner">üéÅ</div>
        <div class="loading-text">Lacrando c√°psula...</div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB2cNiBL1SU_QfjH_S_QGv_KSiFoocfqd4",
            authDomain: "capsuladotempo-f86bf.firebaseapp.com",
            databaseURL: "https://capsuladotempo-f86bf-default-rtdb.firebaseio.com",
            projectId: "capsuladotempo-f86bf",
            storageBucket: "capsuladotempo-f86bf.firebasestorage.app",
            messagingSenderId: "43014678980",
            appId: "1:43014678980:web:0c84f48037ee6924afdc91"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // State
        let eventoId = null, eventoData = null, capsulaId = null;
        let fotoBase64 = null, linkCapsula = null;
        let desejosSelecionados = [], pessoasSelecionadas = [];
        let notaFelicidade = null;
        let cameraStream = null;
        let mediaRecorder = null, audioChunks = [], audioBase64 = null;
        let audioConfirmado = false, tempoInicio = null, timerInterval = null, duracaoFinal = 0;
        let videoBlob = null, imagemBlob = null;

        // Utils
        const gerarID = () => `cap_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
        const formatarData = (d) => new Date(d).toLocaleDateString('pt-BR');
        
        const toast = (msg, tipo='success') => {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (tipo === 'error' ? ' error' : '');
            setTimeout(() => t.className = 'toast', 3000);
        };

        function mostrarTela(id) {
            document.querySelectorAll('.tela').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0, 0);
        }

        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            eventoId = params.get('evento');
            
            if (!eventoId) { mostrarTela('telaErro'); return; }
            
            try {
                const snap = await database.ref(`eventos/${eventoId}`).once('value');
                eventoData = snap.val();
                
                if (!eventoData || eventoData.arquivado) { mostrarTela('telaErro'); return; }
                
                document.getElementById('nomeEvento').textContent = eventoData.nome;
                document.getElementById('dataEvento').textContent = formatarData(eventoData.dataAbertura);
            } catch (e) {
                console.error(e);
                mostrarTela('telaErro');
            }
        });

        function iniciar() { mostrarTela('telaCadastro'); }

        // Foto
        async function abrirCamera() {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                document.getElementById('cameraVideo').srcObject = cameraStream;
                document.getElementById('cameraContainer').classList.add('active');
                document.getElementById('fotoOpcoes').style.display = 'none';
            } catch (e) { toast('Erro ao acessar c√¢mera', 'error'); }
        }
        
        function fecharCamera() {
            if (cameraStream) { cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null; }
            document.getElementById('cameraContainer').classList.remove('active');
            document.getElementById('fotoOpcoes').style.display = 'flex';
        }
        
        function capturarFoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('fotoCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0);
            fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
            mostrarFoto(fotoBase64);
            fecharCamera();
        }
        
        function abrirGaleria() { document.getElementById('fotoInput').click(); }
        
        function processarFoto(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.getElementById('fotoCanvas');
                    const max = 800;
                    let w = img.width, h = img.height;
                    if (w > max) { h *= max/w; w = max; }
                    if (h > max) { w *= max/h; h = max; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    fotoBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    mostrarFoto(fotoBase64);
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function mostrarFoto(src) {
            const container = document.getElementById('fotoContainer');
            container.innerHTML = `
                <img class="foto-preview" src="${src}">
                <div style="position:absolute;bottom:5px;right:5px;background:rgba(0,0,0,0.7);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.9rem" onclick="removerFoto(event)">üîÑ</div>
            `;
            container.style.position = 'relative';
        }
        
        function removerFoto(e) {
            e.stopPropagation();
            fotoBase64 = null;
            document.getElementById('fotoContainer').innerHTML = `
                <div class="foto-placeholder" onclick="abrirGaleria()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <path d="M21 15l-5-5L5 21"/>
                    </svg>
                    <span style="font-size:0.85rem">Adicionar foto</span>
                </div>
            `;
            document.getElementById('fotoInput').value = '';
        }

        // Navigation
        function irPasso2() {
            const nome = document.getElementById('nome').value.trim();
            const sobrenome = document.getElementById('sobrenome').value.trim();
            if (!nome || !sobrenome) { toast('Preencha nome e sobrenome', 'error'); return; }
            mostrarTela('telaDesejos');
        }

        function toggleTag(el) {
            if (el.classList.contains('selected')) {
                el.classList.remove('selected');
                desejosSelecionados = desejosSelecionados.filter(d => d !== el.textContent);
            } else {
                if (desejosSelecionados.length >= 10) { toast('M√°ximo 10', 'error'); return; }
                el.classList.add('selected');
                desejosSelecionados.push(el.textContent);
            }
            document.getElementById('contadorDesejos').textContent = desejosSelecionados.length;
        }

        function irPasso3() {
            if (desejosSelecionados.length === 0) { toast('Selecione pelo menos 1', 'error'); return; }
            mostrarTela('telaPessoas');
        }

        function togglePessoa(el) {
            const pessoa = el.dataset.pessoa;
            el.classList.toggle('selected');
            if (el.classList.contains('selected')) {
                pessoasSelecionadas.push(pessoa);
            } else {
                pessoasSelecionadas = pessoasSelecionadas.filter(p => p !== pessoa);
            }
        }

        function irPasso4() { mostrarTela('telaPerguntas'); }

        function selecionarNota(n) {
            notaFelicidade = n;
            document.querySelectorAll('.escala-num').forEach((el, i) => {
                el.classList.toggle('selected', i + 1 === n);
            });
        }

        function irPasso5() { mostrarTela('telaAudio'); }

        // Audio
        async function toggleGravacao() {
            const btn = document.getElementById('btnGravar');
            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };
                    mediaRecorder.onstop = () => {
                        duracaoFinal = Math.floor((Date.now() - tempoInicio) / 1000);
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.onloadend = () => {
                            audioBase64 = reader.result;
                            document.getElementById('audioPlayer').src = URL.createObjectURL(blob);
                            document.getElementById('audioPreview').style.display = 'block';
                            btn.style.display = 'none';
                            document.getElementById('tempoGravacao').style.display = 'none';
                        };
                        reader.readAsDataURL(blob);
                        stream.getTracks().forEach(t => t.stop());
                    };
                    mediaRecorder.start(100);
                    btn.classList.add('gravando');
                    btn.innerHTML = '‚èπÔ∏è';
                    tempoInicio = Date.now();
                    timerInterval = setInterval(() => {
                        const s = Math.floor((Date.now() - tempoInicio) / 1000);
                        document.getElementById('tempoGravacao').textContent = `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
                    }, 100);
                    setTimeout(() => { if (mediaRecorder?.state === 'recording') { mediaRecorder.stop(); clearInterval(timerInterval); btn.classList.remove('gravando'); } }, 60000);
                } catch (e) { toast('Erro no microfone', 'error'); }
            } else {
                mediaRecorder.stop();
                clearInterval(timerInterval);
                btn.classList.remove('gravando');
            }
        }

        function regravar() {
            audioBase64 = null; audioConfirmado = false; mediaRecorder = null;
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('audioConfirmado').style.display = 'none';
            const btn = document.getElementById('btnGravar');
            btn.style.display = 'flex';
            btn.innerHTML = 'üé§';
            document.getElementById('tempoGravacao').style.display = 'block';
            document.getElementById('tempoGravacao').textContent = '00:00';
        }

        function confirmarAudio() {
            audioConfirmado = true;
            document.getElementById('audioPreview').style.display = 'none';
            document.getElementById('audioConfirmado').style.display = 'flex';
            document.getElementById('duracaoAudio').textContent = `${String(Math.floor(duracaoFinal/60)).padStart(2,'0')}:${String(duracaoFinal%60).padStart(2,'0')}`;
        }

        function pularAudio() { audioBase64 = null; audioConfirmado = false; irPasso6(); }

        function irPasso6() {
            document.getElementById('resumoDesejos').innerHTML = desejosSelecionados.slice(0,5).map(d => `<span class="mini-tag">${d}</span>`).join('');
            document.getElementById('resumoPessoas').textContent = pessoasSelecionadas.length > 0 ? pessoasSelecionadas.join(', ') : '-';
            document.getElementById('resumoFelicidade').textContent = notaFelicidade || '-';
            mostrarTela('telaMensagem');
        }

        function atualizarContador() {
            document.getElementById('charCounter').textContent = document.getElementById('mensagem').value.length;
        }

        // Lacrar
        async function lacrarCapsula() {
            const nome = document.getElementById('nome').value.trim();
            const sobrenome = document.getElementById('sobrenome').value.trim();
            const mensagem = document.getElementById('mensagem').value.trim();
            const conquista = document.getElementById('perguntaConquista').value.trim();
            const momento = document.getElementById('perguntaMomento').value.trim();
            const palavra = document.getElementById('perguntaPalavra').value.trim();

            document.getElementById('btnLacrar').disabled = true;
            document.getElementById('loading').classList.add('active');

            try {
                capsulaId = gerarID();
                let fotoUrl = null, audioUrl = null;

                if (fotoBase64) {
                    const ref = storage.ref(`capsulas/${capsulaId}/foto.jpg`);
                    const blob = await (await fetch(fotoBase64)).blob();
                    await ref.put(blob, { contentType: 'image/jpeg' });
                    fotoUrl = await ref.getDownloadURL();
                }

                if (audioBase64 && audioConfirmado) {
                    try {
                        const blob = await (await fetch(audioBase64)).blob();
                        const ref = storage.ref(`capsulas/${capsulaId}/audio.webm`);
                        await ref.put(blob);
                        audioUrl = await ref.getDownloadURL();
                    } catch (e) {}
                }

                await database.ref(`capsulas/${capsulaId}`).set({
                    eventoId, nome, sobrenome, foto: fotoUrl,
                    desejos: desejosSelecionados, pessoas: pessoasSelecionadas,
                    perguntas: { conquista, momento, palavra, felicidade: notaFelicidade },
                    audioUrl, audioBase64: audioConfirmado ? audioBase64 : null,
                    mensagemPessoal: mensagem,
                    dataCriacao: new Date().toISOString(),
                    dataAbertura: eventoData.dataAbertura,
                    liberada: false, aberta: false
                });

                linkCapsula = `${window.location.origin}${window.location.pathname.replace('jogador.html', '')}capsula.html?id=${capsulaId}`;

                document.getElementById('loading').classList.remove('active');
                mostrarSucesso(fotoUrl || fotoBase64, nome);
                criarConfetes();
                
            } catch (e) {
                console.error(e);
                document.getElementById('loading').classList.remove('active');
                toast('Erro ao salvar', 'error');
                document.getElementById('btnLacrar').disabled = false;
            }
        }

        function mostrarSucesso(foto, nome) {
            if (foto) {
                document.getElementById('sucessoFoto').innerHTML = `<img src="${foto}" style="width:100%;height:100%;object-fit:cover">`;
            }
            document.getElementById('sucessoMsg').textContent = `${nome}, sua c√°psula est√° segura!`;
            document.getElementById('sucessoData').textContent = formatarData(eventoData.dataAbertura);
            const dias = Math.ceil((new Date(eventoData.dataAbertura) - new Date()) / (1000*60*60*24));
            document.getElementById('sucessoDias').textContent = `${dias} dias restantes`;
            mostrarTela('telaSucesso');
        }

        function criarConfetes() {
            const container = document.getElementById('confetes');
            const cores = ['#6366f1', '#ec4899', '#fbbf24', '#22c55e', '#3b82f6', '#f43f5e'];
            for (let i = 0; i < 100; i++) {
                const el = document.createElement('div');
                el.style.cssText = `
                    position: absolute;
                    width: ${6 + Math.random() * 8}px;
                    height: ${6 + Math.random() * 8}px;
                    background: ${cores[Math.floor(Math.random() * cores.length)]};
                    left: ${Math.random() * 100}%;
                    top: -20px;
                    border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
                    animation: confetti ${2 + Math.random() * 2}s ease-out forwards;
                    animation-delay: ${Math.random() * 0.5}s;
                `;
                container.appendChild(el);
            }
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes confetti {
                    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
                    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => container.innerHTML = '', 4000);
        }

        // Share Modal
        function abrirShare() {
            document.getElementById('shareModal').classList.add('active');
            document.getElementById('btnSalvarVideo').disabled = true;
            document.getElementById('btnSalvarImg').disabled = true;
            document.getElementById('shareStatus').style.display = 'block';
            document.getElementById('progressBar').style.width = '0%';
            
            setTimeout(() => criarAnimacaoSpotify(), 100);
        }

        function fecharShare() {
            document.getElementById('shareModal').classList.remove('active');
        }

        // ========================================
        // ANIMA√á√ÉO ESTILO SPOTIFY WRAPPED
        // ========================================
        async function criarAnimacaoSpotify() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1080;
            canvas.height = 1920;
            
            const preview = document.getElementById('sharePreview');
            preview.innerHTML = '';
            preview.appendChild(canvas);
            
            // Dados
            const nome = document.getElementById('nome').value.trim();
            const dataAbertura = formatarData(eventoData?.dataAbertura);
            const dias = Math.max(0, Math.ceil((new Date(eventoData?.dataAbertura) - new Date()) / (1000*60*60*24)));
            const prioridades = desejosSelecionados.slice(0, 3);
            const palavra = document.getElementById('perguntaPalavra').value.trim() || 'Esperan√ßa';
            
            // Carregar foto
            let fotoImg = null;
            if (fotoBase64) {
                try {
                    fotoImg = await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = 'anonymous';
                        img.onload = () => resolve(img);
                        img.onerror = reject;
                        img.src = fotoBase64;
                    });
                } catch(e) {}
            }
            
            // Configurar grava√ß√£o
            const stream = canvas.captureStream(30);
            const chunks = [];
            let recorder;
            
            try {
                recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
            } catch(e) {
                recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            }
            
            recorder.ondataavailable = (e) => { if (e.data.size > 0) chunks.push(e.data); };
            recorder.onstop = () => {
                videoBlob = new Blob(chunks, { type: 'video/webm' });
                document.getElementById('btnSalvarVideo').disabled = false;
                toast('üé¨ V√≠deo criado!');
            };
            
            recorder.start();
            
            // Anima√ß√£o
            const w = canvas.width, h = canvas.height;
            let frame = 0;
            const totalFrames = 180; // 6 segundos
            const cenas = [
                { inicio: 0, fim: 45 },    // Cena 1: Intro
                { inicio: 45, fim: 90 },   // Cena 2: Foto + Nome
                { inicio: 90, fim: 135 },  // Cena 3: Prioridades
                { inicio: 135, fim: 180 }  // Cena 4: Data + Dias
            ];
            
            // Part√≠culas
            const particulas = [];
            for (let i = 0; i < 50; i++) {
                particulas.push({
                    x: Math.random() * w,
                    y: Math.random() * h,
                    size: Math.random() * 4 + 2,
                    speedX: (Math.random() - 0.5) * 2,
                    speedY: (Math.random() - 0.5) * 2,
                    hue: Math.random() * 60 + 240
                });
            }
            
            function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }
            function easeInOutCubic(t) { return t < 0.5 ? 4*t*t*t : 1-Math.pow(-2*t+2,3)/2; }
            
            function animate() {
                frame++;
                const progress = frame / totalFrames;
                document.getElementById('progressBar').style.width = (progress * 100) + '%';
                
                // Background din√¢mico
                const hue1 = 250 + Math.sin(frame * 0.02) * 20;
                const hue2 = 320 + Math.cos(frame * 0.015) * 20;
                
                const bg = ctx.createLinearGradient(0, 0, w, h);
                bg.addColorStop(0, `hsl(${hue1}, 60%, 8%)`);
                bg.addColorStop(0.5, `hsl(${(hue1+hue2)/2}, 50%, 12%)`);
                bg.addColorStop(1, `hsl(${hue2}, 60%, 8%)`);
                ctx.fillStyle = bg;
                ctx.fillRect(0, 0, w, h);
                
                // Part√≠culas flutuantes
                particulas.forEach(p => {
                    p.x += p.speedX;
                    p.y += p.speedY;
                    if (p.x < 0 || p.x > w) p.speedX *= -1;
                    if (p.y < 0 || p.y > h) p.speedY *= -1;
                    
                    const alpha = 0.3 + Math.sin(frame * 0.05 + p.x * 0.01) * 0.2;
                    ctx.fillStyle = `hsla(${p.hue}, 80%, 60%, ${alpha})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // Glow central
                const glowSize = 400 + Math.sin(frame * 0.03) * 100;
                const glow = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, glowSize);
                glow.addColorStop(0, `hsla(${hue1}, 70%, 50%, 0.15)`);
                glow.addColorStop(0.5, `hsla(${hue2}, 70%, 50%, 0.05)`);
                glow.addColorStop(1, 'transparent');
                ctx.fillStyle = glow;
                ctx.fillRect(0, 0, w, h);
                
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                // ===== CENA 1: INTRO =====
                if (frame <= 45) {
                    const t = frame / 45;
                    const scale = easeOutCubic(t);
                    const alpha = easeOutCubic(t);
                    
                    ctx.save();
                    ctx.translate(w/2, h/2 - 100);
                    ctx.scale(scale, scale);
                    ctx.globalAlpha = alpha;
                    
                    // √çcone
                    ctx.font = '200px Arial';
                    ctx.fillText('üéÅ', 0, -50);
                    
                    // T√≠tulo
                    ctx.font = '900 72px "Sora", sans-serif';
                    ctx.fillStyle = '#fff';
                    ctx.fillText('C√ÅPSULA', 0, 150);
                    ctx.fillText('DO TEMPO', 0, 240);
                    
                    ctx.restore();
                }
                
                // ===== CENA 2: FOTO + NOME =====
                if (frame > 30 && frame <= 90) {
                    const t = Math.min(1, (frame - 30) / 30);
                    const fadeOut = frame > 75 ? 1 - (frame - 75) / 15 : 1;
                    
                    if (fotoImg) {
                        const fotoY = h * 0.35;
                        const fotoSize = 350 * easeOutCubic(t);
                        
                        ctx.save();
                        ctx.globalAlpha = easeOutCubic(t) * fadeOut;
                        
                        // Borda gradiente
                        const borderGrad = ctx.createLinearGradient(w/2 - 200, fotoY - 200, w/2 + 200, fotoY + 200);
                        borderGrad.addColorStop(0, '#6366f1');
                        borderGrad.addColorStop(0.5, '#ec4899');
                        borderGrad.addColorStop(1, '#fbbf24');
                        
                        ctx.fillStyle = borderGrad;
                        ctx.beginPath();
                        ctx.arc(w/2, fotoY, fotoSize/2 + 12, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Foto
                        ctx.beginPath();
                        ctx.arc(w/2, fotoY, fotoSize/2, 0, Math.PI * 2);
                        ctx.clip();
                        
                        const ratio = fotoImg.width / fotoImg.height;
                        let dw = fotoSize, dh = fotoSize;
                        if (ratio > 1) dw = fotoSize * ratio;
                        else dh = fotoSize / ratio;
                        ctx.drawImage(fotoImg, w/2 - dw/2, fotoY - dh/2, dw, dh);
                        
                        ctx.restore();
                    }
                    
                    // Nome
                    if (frame > 45) {
                        const nameT = (frame - 45) / 25;
                        const nameAlpha = easeOutCubic(Math.min(1, nameT)) * fadeOut;
                        const nameY = h * 0.6 + (1 - easeOutCubic(Math.min(1, nameT))) * 50;
                        
                        ctx.save();
                        ctx.globalAlpha = nameAlpha;
                        ctx.font = '800 80px "Sora", sans-serif';
                        ctx.fillStyle = '#fff';
                        ctx.fillText(nome.toUpperCase(), w/2, nameY);
                        
                        ctx.font = '400 36px "Outfit", sans-serif';
                        ctx.fillStyle = 'rgba(255,255,255,0.6)';
                        ctx.fillText('lacrou uma c√°psula', w/2, nameY + 70);
                        ctx.restore();
                    }
                }
                
                // ===== CENA 3: PRIORIDADES =====
                if (frame > 75 && frame <= 135) {
                    const t = Math.min(1, (frame - 75) / 30);
                    const fadeOut = frame > 120 ? 1 - (frame - 120) / 15 : 1;
                    
                    ctx.save();
                    ctx.globalAlpha = easeOutCubic(t) * fadeOut;
                    
                    // T√≠tulo
                    ctx.font = '600 42px "Outfit", sans-serif';
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.fillText('PRIORIDADES PARA 2025', w/2, h * 0.25);
                    
                    // Tags
                    const startY = h * 0.4;
                    prioridades.forEach((tag, i) => {
                        const delay = i * 8;
                        if (frame > 85 + delay) {
                            const tagT = Math.min(1, (frame - 85 - delay) / 15);
                            const tagAlpha = easeOutCubic(tagT) * fadeOut;
                            const tagY = startY + i * 120 + (1 - easeOutCubic(tagT)) * 30;
                            
                            ctx.globalAlpha = tagAlpha;
                            
                            // Background da tag
                            const tagGrad = ctx.createLinearGradient(w/2 - 250, tagY, w/2 + 250, tagY);
                            tagGrad.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
                            tagGrad.addColorStop(1, 'rgba(236, 72, 153, 0.3)');
                            
                            ctx.fillStyle = tagGrad;
                            roundRect(ctx, w/2 - 250, tagY - 45, 500, 90, 45);
                            ctx.fill();
                            
                            ctx.font = '700 52px "Sora", sans-serif';
                            ctx.fillStyle = '#fff';
                            ctx.fillText(tag, w/2, tagY + 5);
                        }
                    });
                    
                    // Palavra do momento
                    if (frame > 105) {
                        const wordT = (frame - 105) / 20;
                        ctx.globalAlpha = easeOutCubic(Math.min(1, wordT)) * fadeOut;
                        
                        ctx.font = '500 32px "Outfit", sans-serif';
                        ctx.fillStyle = 'rgba(255,255,255,0.5)';
                        ctx.fillText('Palavra do momento', w/2, h * 0.75);
                        
                        ctx.font = '800 72px "Sora", sans-serif';
                        ctx.fillStyle = '#fbbf24';
                        ctx.fillText(palavra.toUpperCase(), w/2, h * 0.75 + 80);
                    }
                    
                    ctx.restore();
                }
                
                // ===== CENA 4: DATA + COUNTDOWN =====
                if (frame > 120) {
                    const t = Math.min(1, (frame - 120) / 30);
                    
                    ctx.save();
                    ctx.globalAlpha = easeOutCubic(t);
                    
                    // √çcone cadeado
                    const lockScale = 0.5 + easeOutCubic(t) * 0.5;
                    ctx.font = `${150 * lockScale}px Arial`;
                    ctx.fillText('üîí', w/2, h * 0.28);
                    
                    // Status
                    ctx.font = '700 56px "Sora", sans-serif';
                    ctx.fillStyle = '#fff';
                    ctx.fillText('C√ÅPSULA LACRADA', w/2, h * 0.42);
                    
                    // Data
                    ctx.font = '500 36px "Outfit", sans-serif';
                    ctx.fillStyle = 'rgba(255,255,255,0.7)';
                    ctx.fillText('Abre em', w/2, h * 0.52);
                    
                    ctx.font = '700 48px "Sora", sans-serif';
                    ctx.fillStyle = '#fbbf24';
                    ctx.fillText(dataAbertura, w/2, h * 0.58);
                    
                    // Dias - Grande destaque
                    if (frame > 140) {
                        const diasT = (frame - 140) / 20;
                        const diasScale = easeOutCubic(Math.min(1, diasT));
                        const diasPulse = 1 + Math.sin(frame * 0.1) * 0.05;
                        
                        ctx.save();
                        ctx.translate(w/2, h * 0.72);
                        ctx.scale(diasScale * diasPulse, diasScale * diasPulse);
                        
                        // C√≠rculo de fundo
                        const circleGrad = ctx.createRadialGradient(0, 0, 0, 0, 0, 180);
                        circleGrad.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
                        circleGrad.addColorStop(1, 'rgba(236, 72, 153, 0.2)');
                        ctx.fillStyle = circleGrad;
                        ctx.beginPath();
                        ctx.arc(0, 0, 180, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.font = '900 140px "Sora", sans-serif';
                        ctx.fillStyle = '#fff';
                        ctx.fillText(dias, 0, 20);
                        
                        ctx.font = '600 36px "Outfit", sans-serif';
                        ctx.fillStyle = 'rgba(255,255,255,0.8)';
                        ctx.fillText('DIAS', 0, 90);
                        
                        ctx.restore();
                    }
                    
                    // Rodap√©
                    ctx.font = '400 28px "Outfit", sans-serif';
                    ctx.fillStyle = 'rgba(255,255,255,0.4)';
                    ctx.fillText('C√°psula do Tempo ‚Ä¢ 2024', w/2, h - 80);
                    
                    ctx.restore();
                }
                
                // Continuar ou finalizar
                if (frame < totalFrames) {
                    requestAnimationFrame(animate);
                } else {
                    recorder.stop();
                    
                    // Criar imagem est√°tica
                    canvas.toBlob((blob) => {
                        imagemBlob = blob;
                        document.getElementById('btnSalvarImg').disabled = false;
                        document.getElementById('shareStatus').style.display = 'none';
                    }, 'image/png');
                }
            }
            
            animate();
        }
        
        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x + r, y);
            ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r);
            ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r);
            ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y);
            ctx.closePath();
        }

        function salvarVideo() {
            if (!videoBlob) { toast('Aguarde...', 'error'); return; }
            const url = URL.createObjectURL(videoBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `capsula-${Date.now()}.webm`;
            a.click();
            URL.revokeObjectURL(url);
            toast('üé¨ V√≠deo salvo!');
        }

        function salvarImagem() {
            if (!imagemBlob) { toast('Aguarde...', 'error'); return; }
            const url = URL.createObjectURL(imagemBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `capsula-${Date.now()}.png`;
            a.click();
            URL.revokeObjectURL(url);
            toast('üì∏ Imagem salva!');
        }

        function copiarLink() {
            if (!linkCapsula) { toast('Link indispon√≠vel', 'error'); return; }
            navigator.clipboard.writeText(linkCapsula).then(() => toast('üîó Link copiado!'));
        }

        function verCapsula() { if (linkCapsula) window.location.href = linkCapsula; }
    </script>
</body>
</html>
